# Детекция дубликатов вакансий

## Описание

Модуль для автоматического обнаружения и обработки дубликатов вакансий. Одна и та же вакансия может попасть в базу из разных источников (Telegram, HeadHunter, LinkedIn) или быть опубликована повторно.

## Как это работает

Детектор использует несколько стратегий проверки (от наиболее надежных к менее надежным):

1. **Проверка по ссылке** - самый надежный способ
   - Сравнивает нормализованные URL вакансий
   - Работает для всех источников

2. **Проверка по ID из ссылки** - для HeadHunter и LinkedIn
   - Извлекает ID вакансии из URL (например, `hh.ru/vacancy/12345678`)
   - Сравнивает ID между вакансиями

3. **Проверка по title + company** - для вакансий без ссылок
   - Сравнивает заголовок и название компании
   - Использует нормализацию текста

4. **Проверка по текстовому сходству** - самый гибкий метод
   - Использует алгоритм SequenceMatcher для сравнения текстов
   - Настраиваемый порог схожести (по умолчанию 0.85)

## Настройка

В файле `data/settings.json` добавлены новые параметры:

```json
{
  "enable_duplicate_detection": true,
  "duplicate_similarity_threshold": 0.85,
  "merge_duplicates": false
}
```

### Параметры:

- **`enable_duplicate_detection`** (bool) - включить/выключить детекцию дубликатов
  - `true` - дубликаты будут обнаружены и пропущены (или объединены)
  - `false` - все вакансии сохраняются без проверки

- **`duplicate_similarity_threshold`** (float, 0.0-1.0) - порог схожести для текстового сравнения
  - `0.85` - по умолчанию (85% схожести)
  - `0.9` - более строгая проверка (меньше ложных срабатываний)
  - `0.8` - более мягкая проверка (больше дубликатов будет найдено)

- **`merge_duplicates`** (bool) - объединять дубликаты вместо пропуска
  - `false` - дубликаты просто пропускаются (по умолчанию)
  - `true` - дубликаты объединяются в одну вакансию с объединенными данными

## Использование

### Автоматическая детекция

Детекция дубликатов автоматически работает при парсинге вакансий через:
- HeadHunter парсер
- LinkedIn парсер
- Telegram парсер (если интегрирован)

При сохранении вакансии проверяется, есть ли уже такая вакансия в базе. Если дубликат найден:
- При `merge_duplicates: false` - вакансия пропускается
- При `merge_duplicates: true` - вакансии объединяются

### Ручная проверка дубликатов

Запустите тестовый скрипт для проверки дубликатов в существующей базе:

```bash
python test_duplicate_detector.py
```

Скрипт покажет:
- Статистику по дубликатам
- Список найденных пар дубликатов
- Результаты тестирования методов детекции

### Программное использование

```python
from duplicate_detector import DuplicateDetector, check_duplicate
from vacancy_storage_with_dedup import save_vacancy_with_dedup

# Простая проверка одной вакансии
from iget.vacancy_storage import load_all_vacancies

vacancy = {...}  # Ваша вакансия
existing = load_all_vacancies()

duplicate = check_duplicate(vacancy, existing)
if duplicate:
    print(f"Найден дубликат: {duplicate['id']}")

# Сохранение с проверкой дубликатов
result = save_vacancy_with_dedup(
    vacancy,
    check_duplicates=True,
    similarity_threshold=0.85,
    merge_duplicates=False
)

if result["is_duplicate"]:
    print(f"Дубликат найден: {result['duplicate_id']}")
else:
    print("Вакансия сохранена")
```

## Примеры

### Пример 1: Дубликаты по ссылке

Вакансия 1:
- Ссылка: `https://hh.ru/vacancy/12345678`
- Название: "Python разработчик"
- Компания: "ООО Тех"

Вакансия 2:
- Ссылка: `https://hh.ru/vacancy/12345678?query=python`
- Название: "Python Developer"
- Компания: "ООО Тех"

**Результат**: Дубликат найден по ссылке (нормализованные URL совпадают)

### Пример 2: Дубликаты по ID

Вакансия 1:
- Ссылка: `https://hh.ru/vacancy/12345678`
- Источник: HeadHunter

Вакансия 2:
- Ссылка: `https://hh.ru/vacancy/12345678`
- Источник: Telegram (содержит ссылку на HeadHunter)

**Результат**: Дубликат найден по ID (оба имеют ID `hh_12345678`)

### Пример 3: Дубликаты по текстовому сходству

Вакансия 1:
- Название: "Senior Python разработчик"
- Текст: "Ищем опытного Python разработчика..."

Вакансия 2:
- Название: "Senior Python Developer"
- Текст: "Ищем опытного Python разработчика..."

**Результат**: Дубликат найден по текстовому сходству (схожесть > 0.85)

## Объединение дубликатов

При включении `merge_duplicates: true`, дубликаты объединяются в одну вакансию:

- Сохраняется более полное описание
- Объединяются все уникальные ссылки
- Выбирается более ранняя дата публикации
- Сохраняются все источники
- Добавляется метаданное `merged_from` с ID исходных вакансий

## Производительность

- Проверка по ссылке: ~O(n) - очень быстро
- Проверка по ID: ~O(n) - очень быстро
- Проверка по title+company: ~O(n) - быстро
- Проверка по текстовому сходству: ~O(n*m) - медленнее, но более гибко

Для больших баз данных (>1000 вакансий) рекомендуется:
- Использовать проверку по ссылке/ID (включена по умолчанию)
- Увеличить порог схожести до 0.9 для текстового сравнения
- Использовать проверку по текстовому сходству только если другие методы не сработали

## Логирование

Детектор логирует все найденные дубликаты:

```
INFO: Найден дубликат: Python разработчик... (ID: abc12345...)
INFO:   Новая вакансия: https://hh.ru/vacancy/12345678
INFO:   Существующая: https://hh.ru/vacancy/12345678
```

Уровень логирования можно настроить в настройках логирования приложения.

## Ограничения

1. **Текстовое сравнение** может давать ложные срабатывания для похожих, но разных вакансий
2. **Нормализация текста** может терять важную информацию (например, регистр для некоторых языков)
3. **Производительность** текстового сравнения снижается при большом количестве вакансий

## Рекомендации

1. **Начните с проверки по ссылке/ID** - это самый надежный и быстрый метод
2. **Используйте текстовое сравнение** только если другие методы не сработали
3. **Настройте порог схожести** в зависимости от ваших потребностей:
   - Высокий порог (0.9) - меньше ложных срабатываний, но может пропустить некоторые дубликаты
   - Низкий порог (0.8) - больше дубликатов будет найдено, но возможны ложные срабатывания
4. **Проверяйте результаты** периодически запуская `test_duplicate_detector.py`

## Устранение неполадок

### Дубликаты не обнаруживаются

1. Проверьте, что `enable_duplicate_detection: true` в настройках
2. Уменьшите `duplicate_similarity_threshold` до 0.8
3. Проверьте, что у вакансий есть ссылки (link) или заголовки (title)

### Слишком много ложных срабатываний

1. Увеличьте `duplicate_similarity_threshold` до 0.9
2. Проверьте, что вакансии действительно дубликаты (запустите тестовый скрипт)

### Медленная работа

1. Убедитесь, что проверка по ссылке/ID включена (включена по умолчанию)
2. Увеличьте порог схожести, чтобы текстовое сравнение срабатывало реже
3. Рассмотрите возможность использования более быстрой библиотеки для текстового сравнения
