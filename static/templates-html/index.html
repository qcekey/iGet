<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iGet</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        /* ============== iGet Modern Cozy Theme ============== */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            /* Шрифт */
            --font-main: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            
            /* Размеры - улучшенная читаемость */
            --font-size-xs: 12px;
            --font-size-sm: 14px;
            --font-size-md: 16px;
            --font-size-lg: 18px;
            --font-size-xl: 22px;
            --font-size-xxl: 28px;
            
            /* Межстрочные интервалы */
            --line-height-tight: 1.3;
            --line-height-normal: 1.5;
            --line-height-relaxed: 1.7;
            
            /* Темная яркая палитра */
            --color-bg: #1a1e2e;
            --color-bg-secondary: #252a3a;
            --color-surface: #2d3346;
            --color-surface-elevated: #353b52;
            --color-border: rgba(79, 110, 247, 0.2);
            --color-border-hover: rgba(79, 110, 247, 0.4);
            --color-text: #f0f4f8;
            --color-text-secondary: #c8d2e0;
            --color-text-muted: #8a96a8;
            
            /* Яркий акцентный градиент */
            --color-accent: #5b7cff;
            --color-accent-secondary: #7c5eff;
            --accent-gradient: linear-gradient(135deg, #5b7cff 0%, #7c5eff 100%);
            
            /* Яркие статусные цвета */
            --color-success: #00ffa3;
            --color-warning: #ffb84d;
            --color-error: #ff6b6b;
            --color-info: #4dd0e1;
            
            /* Тени с цветом */
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.5);
            --shadow-colored: 0 8px 24px rgba(91, 124, 255, 0.4);
        }
        
        body {
            font-family: var(--font-main);
            font-size: var(--font-size-md);
            font-weight: 400;
            line-height: var(--line-height-normal);
            background: linear-gradient(180deg, var(--color-bg) 0%, #1f2435 100%);
            background-attachment: fixed;
            min-height: 100vh;
            color: var(--color-text);
            overflow-x: hidden;
            letter-spacing: -0.01em;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
        }
        
        /* ============== iGet MAIN CONTAINER ============== */
        .chrome-panel {
            background: var(--color-surface);
            border-radius: 20px;
            padding: 0;
            box-shadow: var(--shadow-lg), 0 0 40px rgba(91, 124, 255, 0.15);
            border: 1px solid var(--color-border);
        }
        
        .chrome-panel-middle {
            background: transparent;
            border-radius: 20px;
            padding: 0;
        }
        
        .chrome-panel-inner {
            background: var(--color-surface);
            border-radius: 20px;
            overflow: hidden;
            border: none;
        }
        
        /* ============== HEADER BAR ============== */
        .title-bar {
            background: linear-gradient(135deg, var(--color-surface) 0%, rgba(91, 124, 255, 0.15) 100%);
            padding: 18px 28px;
            border-bottom: 1px solid var(--color-border);
            position: relative;
        }
        
        .title-bar::before {
            display: none;
        }
        
        .title-bar-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .title-leds {
            display: flex;
            gap: 8px;
            margin-right: 16px;
        }
        
        .led {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }
        
        .led.green {
            background: var(--color-success);
            box-shadow: 0 0 8px rgba(0, 196, 140, 0.5);
        }
        
        .led.orange {
            background: var(--color-warning);
            box-shadow: 0 0 8px rgba(255, 170, 0, 0.5);
        }
        
        .led.blue {
            background: var(--color-info);
            box-shadow: 0 0 8px rgba(0, 180, 216, 0.5);
        }
        
        .title-text {
            letter-spacing: -0.3px;
            font-size: 26px;
            font-weight: 700;
            line-height: 1.2;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .window-controls {
            display: flex;
            gap: 8px;
        }
        
        .win-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: 1px solid var(--color-border);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: var(--font-size-sm);
            font-weight: 400;
            transition: all 0.2s ease;
            background: var(--color-surface);
            color: var(--color-text-muted);
        }
        
        .win-btn.minimize {
            background: var(--color-surface);
        }
        
        .win-btn.close {
            background: var(--color-surface);
            color: var(--color-error);
        }
        
        .win-btn:hover { 
            background: var(--color-bg-secondary);
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }
        .win-btn:active { 
            transform: scale(0.95);
        }
        
        /* ============== CONTENT AREA ============== */
        .content-area {
            background: linear-gradient(180deg, var(--color-bg) 0%, var(--color-bg-secondary) 100%);
            padding: 24px;
            position: relative;
        }
        
        .content-area::before {
            display: none;
        }
        
        /* ============== STATUS PANEL ============== */
        .lcd-panel {
            background: var(--color-surface);
            padding: 0;
            border-radius: 16px;
            border: 1px solid var(--color-border);
            box-shadow: var(--shadow-md);
            overflow: hidden;
        }
        
        .lcd-screen {
            background: linear-gradient(135deg, var(--color-surface) 0%, rgba(79, 110, 247, 0.02) 100%);
            border-radius: 16px;
            padding: 24px;
            border: none;
            position: relative;
            overflow: hidden;
        }
        
        .lcd-screen::before,
        .lcd-screen::after {
            display: none;
        }
        
        .lcd-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 18px;
            border-bottom: 1px solid var(--color-border);
            margin-bottom: 18px;
            position: relative;
            z-index: 1;
        }
        
        .lcd-title {
            font-family: var(--font-main);
            color: var(--color-text);
            letter-spacing: -0.2px;
            font-size: var(--font-size-lg);
            font-weight: 600;
            line-height: 1.4;
        }
        
        .lcd-time {
            font-family: var(--font-main);
            color: var(--color-text-secondary);
            font-size: var(--font-size-sm);
            font-weight: 500;
            font-variant-numeric: tabular-nums;
            background: var(--color-bg-secondary);
            padding: 8px 14px;
            border-radius: 20px;
            line-height: 1.2;
        }
        
        .lcd-dots {
            display: flex;
            gap: 6px;
            margin-left: 14px;
        }
        
        .lcd-dot {
            width: 8px;
            height: 8px;
            background: var(--color-accent);
            border-radius: 50%;
            animation: pulse 1s infinite;
            box-shadow: 0 0 8px rgba(79, 110, 247, 0.4);
        }
        
        .lcd-dot:nth-child(2) { animation-delay: 0.2s; }
        .lcd-dot:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(0.85); }
        }
        
        .lcd-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 18px;
            position: relative;
            z-index: 1;
        }
        
        .lcd-stat {
            display: flex;
            justify-content: space-between;
            font-family: var(--font-main);
            font-size: var(--font-size-sm);
            padding: 12px 16px;
            background: var(--color-bg);
            border-radius: 12px;
            border: 1px solid var(--color-border);
            transition: all 0.2s ease;
        }
        
        .lcd-stat:hover {
            box-shadow: var(--shadow-sm);
            transform: translateY(-1px);
        }
        
        .lcd-stat-label { 
            color: var(--color-text-secondary); 
            font-weight: 600; 
            text-transform: uppercase; 
            font-size: var(--font-size-xs); 
            letter-spacing: 0.8px; 
            line-height: 1.3;
        }
        .lcd-stat-value { 
            font-weight: 700; 
            font-variant-numeric: tabular-nums; 
            font-size: 20px; 
            line-height: 1.2;
            color: var(--color-text);
        }
        .lcd-stat-value.green { color: var(--color-success); }
        .lcd-stat-value.orange { color: var(--color-warning); }
        .lcd-stat-value.blue { color: var(--color-info); }
        .lcd-stat-value.red { color: var(--color-error); }
        
        .lcd-message {
            padding-top: 18px;
            border-top: 1px solid var(--color-border);
            font-family: var(--font-main);
            font-size: var(--font-size-sm);
            font-weight: 400;
            color: var(--color-text-secondary);
            line-height: var(--line-height-relaxed);
            position: relative;
            z-index: 1;
        }
        
        .lcd-message .cursor {
            animation: blink 0.5s infinite;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }
        
        /* Progress bar in LCD */
        .lcd-progress {
            height: 12px;
            background: #0a1a0a;
            border: 1px solid rgba(125, 255, 125, 0.4);
            border-radius: 4px;
            margin-top: 12px;
            overflow: hidden;
            position: relative;
            z-index: 1;
        }
        
        .lcd-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #7dff7d, #4a9eff);
            box-shadow: 0 0 12px rgba(125, 255, 125, 0.6);
            transition: width 0.3s ease;
            position: relative;
        }
        
        .lcd-progress-bar::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shine 1.5s infinite;
        }
        
        @keyframes shine {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        /* ============== VU METER (LOAD METER) ============== */
        .vu-panel {
            background: linear-gradient(135deg, var(--color-surface) 0%, var(--color-surface-elevated) 100%);
            padding: 20px;
            border-radius: 16px;
            border: 1px solid var(--color-border);
            box-shadow: var(--shadow-md), inset 0 1px 0 rgba(255, 255, 255, 0.05);
        }
        
        .vu-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .vu-title {
            color: var(--color-accent);
            font-size: var(--font-size-md);
            font-weight: 600;
            letter-spacing: 0.3px;
            display: flex;
            align-items: center;
            gap: 10px;
            text-transform: uppercase;
            line-height: 1.3;
        }
        
        .vu-device {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: linear-gradient(135deg, rgba(91, 124, 255, 0.2), rgba(124, 94, 255, 0.2));
            border: 1px solid var(--color-border);
            border-radius: 8px;
            padding: 4px 10px;
            font-size: var(--font-size-xs);
            color: var(--color-accent);
            font-weight: 500;
        }
        
        .vu-device.gpu {
            background: linear-gradient(135deg, rgba(0, 255, 163, 0.2), rgba(0, 220, 140, 0.2));
            border-color: var(--color-success);
            color: var(--color-success);
        }
        
        .vu-device-icon {
            font-size: var(--font-size-sm);
        }
        
        .vu-value {
            font-family: var(--font-main);
            color: var(--color-warning);
            font-size: var(--font-size-xl);
            font-weight: 700;
            line-height: 1.2;
            text-shadow: 0 0 12px rgba(255, 184, 77, 0.5);
        }
        
        .vu-track {
            background: linear-gradient(180deg, var(--color-bg) 0%, var(--color-bg-secondary) 100%);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid var(--color-border);
            box-shadow: inset 0 4px 12px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        
        .vu-segments-wrapper {
            position: relative;
        }
        
        .vu-segments {
            display: flex;
            gap: 4px;
            height: 32px;
            position: relative;
        }
        
        .vu-segment {
            flex: 1;
            border-radius: 4px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(0, 0, 0, 0.4);
            transition: all 0.1s ease;
            position: relative;
            overflow: hidden;
        }
        
        .vu-segment.green { background: rgba(0, 255, 163, 0.15); border-color: rgba(0, 255, 163, 0.3); }
        .vu-segment.yellow { background: rgba(255, 184, 77, 0.15); border-color: rgba(255, 184, 77, 0.3); }
        .vu-segment.red { background: rgba(255, 107, 107, 0.15); border-color: rgba(255, 107, 107, 0.3); }
        
        .vu-segment.active.green { 
            background: linear-gradient(180deg, #00ffa3, #00e68a, #00cc77); 
            border-color: #00ffa3;
            box-shadow: 0 0 12px rgba(0, 255, 163, 0.6), inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }
        .vu-segment.active.yellow { 
            background: linear-gradient(180deg, #ffb84d, #ffaa33, #ff9900); 
            border-color: #ffb84d;
            box-shadow: 0 0 12px rgba(255, 184, 77, 0.6), inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }
        .vu-segment.active.red { 
            background: linear-gradient(180deg, #ff6b6b, #ff5555, #ff4040); 
            border-color: #ff6b6b;
            box-shadow: 0 0 12px rgba(255, 107, 107, 0.6), inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }
        
        /* Needle */
        .vu-needle {
            position: absolute;
            top: -4px;
            bottom: -4px;
            width: 3px;
            background: linear-gradient(180deg, 
                rgba(255,255,255,0.6),
                rgba(255,255,255,1), 
                rgba(255,255,255,1),
                rgba(255,255,255,0.6));
            border-radius: 2px;
            box-shadow: 
                0 0 8px rgba(255, 255, 255, 0.9),
                0 0 16px rgba(91, 124, 255, 0.6);
            z-index: 10;
            pointer-events: none;
            left: 0;
        }
        
        .vu-scale {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            padding: 0 4px;
        }
        
        .vu-scale span {
            font-family: var(--font-main);
            font-size: var(--font-size-xs);
            font-weight: 600;
            opacity: 0.9;
            line-height: 1.3;
        }
        
        .vu-scale .green { color: var(--color-success); text-shadow: 0 0 8px rgba(0, 255, 163, 0.5); }
        .vu-scale .yellow { color: var(--color-warning); text-shadow: 0 0 8px rgba(255, 184, 77, 0.5); }
        .vu-scale .red { color: var(--color-error); text-shadow: 0 0 8px rgba(255, 107, 107, 0.5); }
        
        /* ============== CONTROL PANEL ============== */
        .control-panel {
            background: var(--color-surface);
            padding: 24px;
            border-radius: 16px;
            border: 1px solid var(--color-border);
            box-shadow: var(--shadow-md);
        }
        
        .panel-title {
            color: var(--color-accent);
            font-size: var(--font-size-sm);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            margin-bottom: 18px;
            line-height: 1.4;
        }
        
        .control-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        /* ============== CONTROL BUTTON ============== */
        .ctrl-btn {
            position: relative;
            padding: 16px 20px;
            background: var(--accent-gradient);
            border: none;
            border-radius: 12px;
            cursor: pointer;
            color: white;
            font-family: var(--font-main);
            font-size: var(--font-size-md);
            font-weight: 600;
            text-align: center;
            line-height: 1.4;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-colored);
        }
        
        .ctrl-btn::before {
            display: none;
        }
        
        .ctrl-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 28px rgba(79, 110, 247, 0.35);
            filter: brightness(1.05);
        }
        
        .ctrl-btn:active {
            transform: translateY(0);
            box-shadow: var(--shadow-sm);
        }
        
        .ctrl-btn.active {
            background: linear-gradient(135deg, #00c48c 0%, #00a878 100%);
            box-shadow: 0 8px 24px rgba(0, 196, 140, 0.35);
        }
        
        .ctrl-btn.danger {
            background: var(--color-bg);
            color: var(--color-error);
            border: 1px solid var(--color-border);
            box-shadow: var(--shadow-sm);
        }
        
        .ctrl-btn.danger:hover {
            background: rgba(255, 92, 92, 0.08);
            border-color: var(--color-error);
            box-shadow: 0 4px 16px rgba(255, 92, 92, 0.2);
        }
        
        .ctrl-btn-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .ctrl-btn-icon {
            font-size: 18px;
        }
        
        /* LED indicators on button */
        .ctrl-btn-leds {
            position: absolute;
            left: 8px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .ctrl-btn-led {
            width: 4px;
            height: 4px;
            border-radius: 50%;
        }
        
        .ctrl-btn-led.green { background: var(--color-success); box-shadow: 0 0 8px rgba(0, 255, 163, 0.6); }
        .ctrl-btn-led.orange { background: var(--color-warning); box-shadow: 0 0 8px rgba(255, 184, 77, 0.6); }
        
        /* Corner decorations */
        .ctrl-btn-corner {
            position: absolute;
            width: 8px;
            height: 8px;
            border: 2px solid var(--color-accent);
            opacity: 0.4;
        }
        
        .ctrl-btn-corner.tl { top: 4px; left: 4px; border-right: none; border-bottom: none; }
        .ctrl-btn-corner.tr { top: 4px; right: 4px; border-left: none; border-bottom: none; }
        .ctrl-btn-corner.bl { bottom: 4px; left: 4px; border-right: none; border-top: none; }
        .ctrl-btn-corner.br { bottom: 4px; right: 4px; border-left: none; border-top: none; }
        
        /* ============== RESUME DISK SLOT ============== */
        .disk-slot-panel {
            background: linear-gradient(135deg, var(--color-surface) 0%, var(--color-surface-elevated) 100%);
            padding: 20px;
            border-radius: 16px;
            border: 1px solid var(--color-border);
            box-shadow: var(--shadow-md);
        }
        
        .disk-slot {
            background: var(--color-bg);
            border-radius: 12px;
            padding: 18px;
            border: 1px solid var(--color-border);
            box-shadow: inset 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .disk-opening {
            background: linear-gradient(180deg, var(--color-bg) 0%, var(--color-bg-secondary) 100%);
            height: 70px;
            border-radius: 10px;
            border: 2px solid var(--color-border);
            position: relative;
            overflow: hidden;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .disk-opening:hover {
            border-color: var(--color-accent);
        }
        
        /* Slot guides */
        .disk-opening::before,
        .disk-opening::after {
            content: '';
            position: absolute;
            top: 8px;
            bottom: 8px;
            width: 4px;
            background: var(--color-border);
        }
        
        .disk-opening::before { left: 8px; }
        .disk-opening::after { right: 8px; }
        
        .disk-empty {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--color-text-muted);
            font-size: var(--font-size-sm);
            letter-spacing: 1px;
            opacity: 0.5;
        }
        
        /* Cassette animation */
        .disk-cassette {
            position: absolute;
            left: 16px;
            right: 16px;
            top: 50%;
            height: 50px;
            background: linear-gradient(135deg, var(--color-surface) 0%, var(--color-surface-elevated) 100%);
            border-radius: 10px;
            border: 2px solid var(--color-border);
            box-shadow: var(--shadow-md);
            display: flex;
            align-items: center;
            padding: 0 12px;
            gap: 10px;
            transform: translateY(-150%);
            opacity: 0;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .disk-cassette.inserting {
            animation: insertCassette 0.8s ease-out forwards;
        }
        
        .disk-cassette.inserted {
            transform: translateY(-50%);
            opacity: 1;
        }
        
        .disk-cassette.ejecting {
            animation: ejectCassette 0.6s ease-in forwards;
        }
        
        @keyframes insertCassette {
            0% { transform: translateY(-200%); opacity: 0; }
            30% { transform: translateY(-120%); opacity: 0.5; }
            60% { transform: translateY(-40%); opacity: 1; }
            80% { transform: translateY(-55%); opacity: 1; }
            100% { transform: translateY(-50%); opacity: 1; }
        }
        
        @keyframes ejectCassette {
            0% { transform: translateY(-50%); opacity: 1; }
            30% { transform: translateY(-60%); opacity: 1; }
            100% { transform: translateY(-200%); opacity: 0; }
        }
        
        .cassette-icon { 
            font-size: var(--font-size-xxl); 
            filter: drop-shadow(0 0 4px #4a9eff);
        }
        
        .cassette-label {
            flex: 1;
            background: #1a1d25;
            border-radius: 3px;
            padding: 4px 8px;
            border: 1px solid #2d333f;
        }
        
        .cassette-name {
            font-family: var(--font-main);
            font-size: var(--font-size-xs);
            color: #7dff7d;
            letter-spacing: 1px;
        }
        
        .cassette-size {
            font-family: var(--font-main);
            font-size: var(--font-size-xs);
            color: #4a9eff;
        }
        
        .cassette-check { 
            color: #7dff7d; 
            font-size: var(--font-size-lg);
            text-shadow: 0 0 8px #7dff7d;
        }
        
        /* Resume Info Card */
        .resume-info-card {
            background: linear-gradient(180deg, #1a2a1a, #0a1a0a);
            border: 2px solid #2a4a2a;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            display: none;
        }
        
        .resume-info-card.active { display: block; }
        
        .resume-info-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #2a4a2a;
        }
        
        .resume-info-avatar {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #3a6040, #2a4530);
            border: 2px solid #5a8060;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--font-size-xl);
        }
        
        .resume-info-name {
            flex: 1;
        }
        
        .resume-info-name h4 {
            color: #7dff7d;
            font-size: var(--font-size-md);
            margin: 0 0 2px 0;
            text-shadow: 0 0 6px rgba(125, 255, 125, 0.5);
        }
        
        .resume-info-name p {
            color: #4a9eff;
            font-size: var(--font-size-sm);
            margin: 0;
            font-family: var(--font-main);
        }
        
        .resume-info-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .resume-stat {
            background: #0a1a0a;
            border: 1px solid #2a4a2a;
            border-radius: 4px;
            padding: 6px 8px;
            text-align: center;
        }
        
        .resume-stat-value {
            font-family: var(--font-main);
            font-size: var(--font-size-md);
            color: #f69029;
            text-shadow: 0 0 6px rgba(246, 144, 41, 0.5);
        }
        
        .resume-stat-label {
            font-size: var(--font-size-xs);
            color: #7dff7d;
            opacity: 0.7;
            letter-spacing: 1px;
        }
        
        .resume-skills {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }
        
        .resume-skill-tag {
            background: linear-gradient(180deg, #2a4a2a, #1a3a1a);
            border: 1px solid #3a5a3a;
            border-radius: 10px;
            padding: 3px 8px;
            font-size: var(--font-size-xs);
            color: #7dff7d;
        }
        
        .disk-leds {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .disk-led {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .disk-led-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--color-text-muted);
            transition: all 0.3s ease;
        }
        
        .disk-led-dot.active.green { background: var(--color-success); box-shadow: 0 0 12px rgba(0, 255, 163, 0.6); }
        .disk-led-dot.active.orange { background: var(--color-warning); box-shadow: 0 0 12px rgba(255, 184, 77, 0.6); animation: pulse 0.5s infinite; }
        
        .disk-led-label {
            font-size: var(--font-size-sm);
            opacity: 0.8;
            font-weight: 500;
        }
        
        .disk-led-label.green { color: var(--color-success); }
        .disk-led-label.orange { color: var(--color-warning); }
        
        .disk-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .disk-btn {
            padding: 12px;
            font-size: var(--font-size-sm);
            font-weight: 600;
            letter-spacing: 0.5px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            border: 2px solid var(--color-border);
        }
        
        .disk-btn.insert {
            background: var(--color-surface);
            border-color: var(--color-border);
            color: var(--color-success);
        }
        
        .disk-btn.insert:hover {
            background: rgba(0, 255, 163, 0.1);
            border-color: var(--color-success);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 255, 163, 0.2);
        }
        
        .disk-btn.eject {
            background: var(--color-surface);
            border-color: var(--color-border);
            color: var(--color-warning);
        }
        
        .disk-btn.eject:hover {
            background: rgba(255, 184, 77, 0.1);
            border-color: var(--color-warning);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255, 184, 77, 0.2);
        }
        
        .disk-btn:active { 
            transform: translateY(0);
        }
        
        .disk-btn:disabled {
            background: var(--color-bg-secondary);
            border-color: var(--color-border);
            color: var(--color-text-muted);
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        .disk-hint {
            margin-top: 12px;
            text-align: center;
            font-family: var(--font-main);
            font-size: var(--font-size-sm);
            color: var(--color-accent);
            opacity: 0.7;
            letter-spacing: 0.5px;
        }
        

        /* ============== VACANCY CARDS ============== */
        .vacancy-section {
            margin-top: 24px;
        }
        
        .vacancy-header {
            background: linear-gradient(135deg, var(--color-surface) 0%, rgba(91, 124, 255, 0.1) 100%);
            padding: 16px 24px;
            border-radius: 16px 16px 0 0;
            border: 1px solid var(--color-border);
            border-bottom: none;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .vacancy-header-dot {
            width: 10px;
            height: 10px;
            background: var(--color-warning);
            border-radius: 50%;
            animation: pulse 1s infinite;
            box-shadow: 0 0 12px rgba(255, 184, 77, 0.6);
        }

        /* ---------- дата в хедере карточки ---------- */
        .vacancy-card-date {
            font-size: var(--font-size-xs);
            color: var(--color-text-secondary);
            letter-spacing: 0.3px;
            font-weight: 500;
            line-height: 1.3;
        }

        .vacancy-card-lead {
            --max-lines: 3;
            --line-height: 1.6;
            /* max-height: calc(var(--line-height) * 1em * var(--max-lines)); */
            overflow-y: auto;          /* разрешаем скролл */

            font-size: var(--font-size-md);
            color: var(--color-text-secondary);
            line-height: var(--line-height);
            margin-bottom: 10px;
            padding: 12px;
            background: var(--color-bg-secondary);
            border-left: 3px solid var(--color-accent);
            border-radius: 0 8px 8px 0;
            font-weight: 400;

            /* ---------- кастомный скролл ---------- */
            scrollbar-width: thin;              /* Firefox */
            scrollbar-color: var(--color-accent) transparent;
        }

        /* Chrome / Edge / Safari */
        .vacancy-card-lead::-webkit-scrollbar {
            width: 6px;                 /* толщина вертикального скролла */
        }
        .vacancy-card-lead::-webkit-scrollbar-track {
            background: transparent;    /* фон «дорожки» */
        }
        .vacancy-card-lead::-webkit-scrollbar-thumb {
            background-color: var(--color-accent);
            border-radius: 3px;         /* скругление ползунка */
        }
        .vacancy-card-lead::-webkit-scrollbar-thumb:hover {
            background-color: var(--color-accent-secondary);
        }
                
        .vacancy-header-text {
            color: var(--color-text);
            font-size: var(--font-size-md);
            font-weight: 600;
            line-height: 1.4;
            letter-spacing: 0.2px;
        }
        
        .vacancies-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
            gap: 20px;
            padding-top: 0;
        }
        
        .vacancy-card {
            background: var(--color-surface);
            border-radius: 16px;
            border: 1px solid var(--color-border);
            overflow: hidden;
            box-shadow: var(--shadow-md);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }
        
        .vacancy-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--accent-gradient);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .vacancy-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }
        
        .vacancy-card:hover::before {
            opacity: 1;
        }

        .vacancy-card.viewed {
            opacity: 0.75;
        }

        .vacancy-card-header {
            background: linear-gradient(135deg, var(--color-bg) 0%, rgba(79, 110, 247, 0.03) 100%);
            padding: 14px 18px;
            border-bottom: 1px solid var(--color-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            overflow: hidden;
            gap: 10px;
        }
        
        .vacancy-card-header::before {
            display: none;
        }
        
        .vacancy-card-id {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }
        
        .vacancy-card-led {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }
        
        .vacancy-card-led.active { background: var(--color-success); box-shadow: 0 0 10px rgba(0, 196, 140, 0.5); }
        .vacancy-card-led.pending { background: var(--color-warning); box-shadow: 0 0 10px rgba(255, 170, 0, 0.5); animation: ledPulse 2s infinite; }
        .vacancy-card-led.archived { background: var(--color-text-muted); }
        
        @keyframes ledPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .vacancy-card-code {
            font-family: var(--font-main);
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
            white-space: nowrap;
            flex-shrink: 0;
            font-weight: 500;
            line-height: 1.3;
        }

        .vacancy-card-source {
            font-family: var(--font-main);
            font-size: var(--font-size-md);
            color: var(--color-text);
            flex: 1;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            text-align: center;
            font-weight: 600;
            line-height: 1.4;
        }

        .vacancy-card-status {
            font-size: var(--font-size-xs);
            font-weight: 700;
            color: var(--color-success);
            text-transform: uppercase;
            flex-shrink: 0;
            white-space: nowrap;
            padding: 5px 12px;
            background: rgba(0, 255, 163, 0.15);
            border-radius: 20px;
            line-height: 1.2;
            letter-spacing: 0.5px;
        }

        .vacancy-card-status.analyzing {
            color: var(--color-info);
            background: rgba(0, 180, 216, 0.1);
        }

        .stage2-indicator.analyzing {
            animation: stage2Pulse 1.5s ease-in-out infinite;
        }

        @keyframes stage2Pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .stage2-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #3a4a6a;
            border-top-color: #4a9eff;
            border-radius: 50%;
            animation: stage2Spin 1s linear infinite;
        }

        @keyframes stage2Spin {
            to { transform: rotate(360deg); }
        }

        .stage2-btn {
            transition: all 0.3s ease;
        }

        .stage2-btn:hover:not(:disabled) {
            background: linear-gradient(180deg, #2a3a4a, #1a2a3a);
            border-color: #4a9eff;
        }
        
        .vacancy-card-body {
            padding: 18px;
        }
        
        .vacancy-card-title {
            color: var(--color-text);
            font-size: var(--font-size-lg);
            font-weight: 700;
            margin-bottom: 10px;
            line-height: var(--line-height-relaxed);
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            word-break: break-word;
            letter-spacing: -0.2px;
        }

        .vacancy-card-company {
            color: var(--color-accent);
            font-size: var(--font-size-md);
            font-weight: 600;
            margin-bottom: 14px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            line-height: 1.4;
        }

        .vacancy-card-summary {
            font-size: var(--font-size-sm);
            color: #a0b0c0;
            line-height: 1.4;
            margin-bottom: 8px;
            padding: 8px;
            background: rgba(0, 0, 0, 0.2);
            border-left: 2px solid #4a6a8a;
            border-radius: 0 4px 4px 0;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
        }

        .vacancy-card-details {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-bottom: 12px;
        }

        .vacancy-card-detail {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: var(--font-size-sm);
        }
        
        .vacancy-card-detail-icon { color: #4a9eff; font-size: var(--font-size-md); }
        .vacancy-card-detail-text { color: #7dff7d; opacity: 0.8; }
        
        /* Match meter */
        .match-meter {
            background: linear-gradient(135deg, var(--color-bg) 0%, rgba(79, 110, 247, 0.03) 100%);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid var(--color-border);
        }
        
        .match-meter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .match-meter-label {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--color-text-secondary);
            font-size: var(--font-size-xs);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            line-height: 1.3;
        }
        
        .match-meter-icon { font-size: var(--font-size-md); }
        
        .match-meter-value {
            font-size: var(--font-size-xxl);
            font-weight: 700;
            line-height: 1.2;
        }
        
        .match-meter-value.high { color: var(--color-success); text-shadow: 0 0 20px rgba(0, 196, 140, 0.3); }
        .match-meter-value.medium { color: var(--color-warning); text-shadow: 0 0 20px rgba(255, 170, 0, 0.3); }
        .match-meter-value.low { color: var(--color-error); text-shadow: 0 0 20px rgba(255, 92, 92, 0.3); }
        .match-meter-value.none { color: var(--color-text-muted); }
        
        .match-meter.pending .match-meter-bar { display: none; }
        
        .match-meter-hint {
            font-size: var(--font-size-xs);
            color: var(--color-text-secondary);
            margin-top: 8px;
            line-height: var(--line-height-relaxed);
        }
        
        .match-meter-bar {
            height: 8px;
            background: var(--color-bg-secondary);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .match-meter-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
            position: relative;
        }
        
        .match-meter-fill.high { background: linear-gradient(90deg, #00c48c, #00d9a0); box-shadow: 0 0 12px rgba(0, 196, 140, 0.4); }
        .match-meter-fill.medium { background: linear-gradient(90deg, #ffaa00, #ffbb33); box-shadow: 0 0 12px rgba(255, 170, 0, 0.4); }
        .match-meter-fill.low { background: linear-gradient(90deg, #ff5c5c, #ff7777); box-shadow: 0 0 12px rgba(255, 92, 92, 0.4); }
        
        .match-meter-fill::after {
            display: none;
        }
        
        .vacancy-card-actions {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 10px;
            margin-top: 16px;
        }
        
        .vacancy-btn {
            padding: 12px 14px;
            background: var(--color-bg);
            border: 1px solid var(--color-border);
            border-radius: 10px;
            font-family: var(--font-main);
            font-size: var(--font-size-sm);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            min-width: 0;
            color: var(--color-text);
            line-height: 1.3;
        }
        
        .vacancy-btn.details { color: var(--color-accent); }
        .vacancy-btn.open { color: var(--color-warning); }
        .vacancy-btn.track { color: var(--color-info); }
        .vacancy-btn.track:hover { background: rgba(0, 180, 216, 0.1); border-color: var(--color-info); box-shadow: 0 4px 12px rgba(0, 180, 216, 0.2); }
        
        .vacancy-btn:hover { 
            background: var(--color-surface);
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }
        .vacancy-btn:active {
            border-color: #2a3040 #5a6570 #5a6570 #2a3040;
            transform: translateY(1px);
        }

        .tracker-status-select {
            padding: 8px 12px;
            background: linear-gradient(180deg, #3a4250, #2d333f);
            border: 2px solid #4a5565;
            border-radius: 6px;
            color: #e0e8f0;
            font-family: var(--font-main);
            font-size: var(--font-size-sm);
            cursor: pointer;
        }
        .tracker-status-select:focus {
            outline: none;
            border-color: #4a9eff;
        }

        .vacancy-card-footer {
            height: 4px;
            background: linear-gradient(90deg, #2d333f, #5a6070 50%, #2d333f);
        }
        
        /* ============== EMPTY STATE ============== */
        .empty-state {
            text-align: center;
            padding: 56px 32px;
            background: linear-gradient(135deg, var(--color-surface) 0%, rgba(79, 110, 247, 0.03) 100%);
            border: 2px dashed var(--color-border);
            border-radius: 16px;
        }
        
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 18px;
            opacity: 0.7;
        }
        
        .empty-state-text {
            font-size: var(--font-size-lg);
            color: var(--color-text-secondary);
            line-height: var(--line-height-relaxed);
            font-weight: 500;
            color: #5a6070;
            letter-spacing: 1px;
        }
        
        .vacancy-header-text {
            color: #f69029;
            font-size: var(--font-size-md);
            letter-spacing: 1px;
        }
        
        /* ============== MODAL ============== */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(4px);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal-backdrop.active { display: flex; }
        
        .modal-window {
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            overflow: hidden;
        }
        
        .modal-tabs {
            background: linear-gradient(180deg, #2d333f, #252932);
            padding: 8px 16px;
            border-bottom: 2px solid #1a1d25;
            display: flex;
            gap: 8px;
        }
        
        .modal-tab {
            padding: 10px 16px;
            font-size: var(--font-size-sm);
            letter-spacing: 1px;
            border-radius: 6px 6px 0 0;
            cursor: pointer;
            transition: all 0.2s;
            background: #2d333f;
            border: 2px solid #3a4250;
            color: #5a6070;
        }
        
        .modal-tab:hover { color: #7dff7d; background: #3a4250; }
        
        .modal-tab.active {
            background: linear-gradient(180deg, #5a6070, #3a4250);
            border-color: #6a7080 #2a3040 transparent #6a7080;
            color: #7dff7d;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.1);
        }
        
        .modal-body {
            background: linear-gradient(135deg, #2d333f, #252932, #2d333f);
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .modal-body::-webkit-scrollbar {
            width: 12px;
        }
        
        .modal-body::-webkit-scrollbar-track {
            background: #0a0d15;
            border: 1px solid #2d333f;
        }
        
        .modal-body::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #4a5568, #3a4250);
            border: 1px solid #6b7280;
            border-radius: 2px;
        }
        
        .modal-actions {
            background: linear-gradient(90deg, #2d333f, #3a4250, #2d333f);
            padding: 16px 20px;
            border-top: 4px solid #1a1d25;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }
        
        .modal-btn {
            padding: 10px 24px;
            background: linear-gradient(180deg, #4a5565, #3a4250);
            border: 3px solid;
            border-color: #5a6570 #2a3040 #2a3040 #5a6570;
            border-radius: 6px;
            font-size: var(--font-size-sm);
            letter-spacing: 1px;
            cursor: pointer;
            color: #7dff7d;
            transition: all 0.1s;
        }
        
        .modal-btn:hover { filter: brightness(1.1); }
        .modal-btn:active {
            border-color: #2a3040 #5a6570 #5a6570 #2a3040;
            transform: translateY(1px);
        }
        
        .modal-btn.primary {
            background: linear-gradient(180deg, #6a7040, #4a5030);
            border-color: #7a8050 #3a4020 #3a4020 #7a8050;
            box-shadow: 0 0 12px rgba(125, 255, 125, 0.3);
        }
        
        /* Tab content */
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Resume comparison - Retro Terminal Style */
        .resume-result-container {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        /* Match Score Bar - Compact retro style */
        .match-score-bar {
            background: linear-gradient(180deg, #3a4250, #2d333f);
            border: 4px solid;
            border-color: #5a6070 #1a1d25 #1a1d25 #5a6070;
            border-radius: 8px;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .match-score-display {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .match-score-num {
            font-size: 36px;
            font-weight: bold;
            min-width: 80px;
        }

        .match-score-num.high { color: #7dff7d; }
        .match-score-num.medium { color: #f69029; }
        .match-score-num.low { color: #ff6b6b; }

        .match-score-meter {
            width: 150px;
            height: 14px;
            background: #1a1d25;
            border-radius: 7px;
            overflow: hidden;
            border: 2px solid #2d333f;
        }

        .match-score-fill {
            height: 100%;
            border-radius: 5px;
            transition: width 0.8s ease-out;
        }

        .match-score-fill.high { background: linear-gradient(90deg, #5a9a5a, #7dff7d); }
        .match-score-fill.medium { background: linear-gradient(90deg, #9a7a3a, #f69029); }
        .match-score-fill.low { background: linear-gradient(90deg, #9a3a3a, #ff6b6b); }

        .match-score-label {
            font-size: 12px;
            letter-spacing: 1px;
            color: #7dff7d;
        }

        .match-score-status {
            margin-left: auto;
            padding: 8px 14px;
            background: #1a1d25;
            border-radius: 4px;
            font-size: 12px;
            letter-spacing: 1px;
            font-weight: bold;
        }

        .match-score-status.high { color: #7dff7d; border: 1px solid #3a5a3a; }
        .match-score-status.medium { color: #f69029; border: 1px solid #5a4a2a; }
        .match-score-status.low { color: #ff6b6b; border: 1px solid #5a2a2a; }

        /* Resume Tabs - Retro style */
        .resume-tabs {
            display: flex;
            gap: 2px;
        }

        .resume-tab-btn {
            flex: 1;
            padding: 10px 16px;
            background: linear-gradient(180deg, #3a4250, #2d333f);
            border: 3px solid;
            border-color: #5a6070 #1a1d25 #1a1d25 #5a6070;
            border-radius: 6px 6px 0 0;
            color: #5a6070;
            font-size: 11px;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .resume-tab-btn:hover {
            background: linear-gradient(180deg, #4a5260, #3d434f);
            color: #8a9aaa;
        }

        .resume-tab-btn.active {
            background: linear-gradient(180deg, #2d333f, #1a1d25);
            border-color: #5a6070 #1a1d25 #1a1d25 #5a6070;
            color: #7dff7d;
        }

        .resume-tab-btn.active.original {
            color: #4a9eff;
        }

        .resume-tab-icon {
            font-size: 12px;
        }

        /* Resume Content Panel - Retro terminal */
        .resume-content-panel {
            background: #1a1d25;
            border: 4px solid;
            border-color: #1a1d25 #5a6070 #5a6070 #1a1d25;
            border-radius: 0 0 8px 8px;
            min-height: 200px;
            max-height: 300px;
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 2px 8px rgba(0,0,0,0.5);
        }

        .resume-tab-content {
            display: none;
            padding: 16px;
            height: 300px;
            max-height: 300px;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .resume-tab-content.active {
            display: block;
        }

        .resume-text {
            font-size: 12px;
            color: #c0c8d0;
            line-height: 1.7;
            white-space: pre-wrap;
        }

        .resume-text.improved {
            white-space: normal;
        }

        /* Copy Button - Retro */
        .copy-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            padding: 5px 10px;
            background: linear-gradient(180deg, #3a4250, #2d333f);
            border: 2px solid;
            border-color: #5a6070 #1a1d25 #1a1d25 #5a6070;
            border-radius: 4px;
            color: #7dff7d;
            font-size: 10px;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.2s ease;
            z-index: 10;
        }

        .copy-btn:hover {
            background: linear-gradient(180deg, #4a5260, #3d434f);
        }

        .copy-btn.copied {
            background: linear-gradient(180deg, #3a5a3a, #2d4a2d);
            color: #fff;
        }

        /* Analysis Summary - Retro terminal */
        .analysis-summary {
            background: linear-gradient(180deg, #3a4250, #2d333f);
            border: 4px solid;
            border-color: #5a6070 #1a1d25 #1a1d25 #5a6070;
            border-radius: 8px;
            overflow: hidden;
        }

        .analysis-header {
            padding: 10px 14px;
            background: linear-gradient(180deg, #2d333f, #1a1d25);
            border-bottom: 2px solid #1a1d25;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .analysis-header-icon {
            font-size: 14px;
        }

        .analysis-header-title {
            font-size: 11px;
            letter-spacing: 1px;
            color: #7dff7d;
        }

        .analysis-body {
            padding: 16px;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            max-height: none;
            overflow-y: visible;
        }

        .analysis-section {
            background: #1a1d25;
            border-radius: 6px;
            padding: 14px 16px;
            border-left: 4px solid;
        }

        .analysis-section.strengths { border-left-color: #7dff7d; }
        .analysis-section.weaknesses { border-left-color: #f69029; }
        .analysis-section.missing { border-left-color: #ff6b6b; }
        .analysis-section.risks { border-left-color: #ff4d4d; }
        .analysis-section.tips { border-left-color: #4a9eff; }

        .analysis-section-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            font-size: 12px;
            font-weight: bold;
            letter-spacing: 1px;
        }

        .analysis-section.strengths .analysis-section-header { color: #7dff7d; }
        .analysis-section.weaknesses .analysis-section-header { color: #f69029; }
        .analysis-section.missing .analysis-section-header { color: #ff6b6b; }
        .analysis-section.risks .analysis-section-header { color: #ff4d4d; }
        .analysis-section.tips .analysis-section-header { color: #4a9eff; }

        /* Recruiter Verdict */
        .recruiter-verdict {
            background: linear-gradient(180deg, #2a2a3a, #1a1a2a);
            border: 3px solid;
            border-color: #5a6070 #1a1d25 #1a1d25 #5a6070;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
        }

        .verdict-label {
            font-size: 12px;
            font-weight: bold;
            letter-spacing: 1px;
            color: #7dccff;
            margin-bottom: 10px;
        }

        .verdict-text {
            font-size: 14px;
            color: #e0e8f0;
            line-height: 1.6;
        }

        .recruiter-analysis-container {
            display: flex;
            flex-direction: column;
            gap: 16px;
            padding: 8px;
        }

        .analysis-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .analysis-list li {
            padding: 6px 0;
            font-size: 13px;
            color: #c0c8d0;
            border-bottom: 1px solid #2d333f;
            line-height: 1.5;
        }

        .analysis-list li:last-child {
            border-bottom: none;
        }

        .analysis-list li::before {
            content: '› ';
            opacity: 0.6;
        }

        /* Cover Letter Hint - Retro */
        .cover-letter-section {
            background: #1a1d25;
            border: 2px solid #2d333f;
            border-radius: 6px;
            padding: 16px;
            margin: 16px;
            margin-top: 0;
        }

        .cover-letter-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            font-size: 12px;
            font-weight: bold;
            letter-spacing: 1px;
            color: #4a9eff;
        }

        .cover-letter-text {
            font-size: 14px;
            color: #c0c8d0;
            line-height: 1.6;
            font-style: italic;
        }

        /* Legacy support - keep old classes working */
        .resume-compare {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        @media (max-width: 700px) {
            .resume-compare { grid-template-columns: 1fr; }
        }

        .resume-column {
            background: #0a0d15;
            border: 2px solid;
            border-color: #1a1d25 #3a4250 #3a4250 #1a1d25;
            border-radius: 8px;
            overflow: hidden;
        }

        .resume-column-header {
            padding: 12px;
            background: linear-gradient(180deg, #2d333f, #1e222a);
            border-bottom: 1px solid #3a4250;
            font-size: var(--font-size-sm);
            font-weight: 400;
            letter-spacing: 1px;
        }

        .resume-column.original .resume-column-header { color: #8b94a3; }
        .resume-column.improved .resume-column-header { color: #7dff7d; }

        .resume-column-body {
            padding: 16px;
            font-family: var(--font-main);
            font-size: var(--font-size-sm);
            color: #c0c8d0;
            line-height: 1.6;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }

        /* Markdown content styling */
        .markdown-content {
            white-space: normal !important;
        }

        .markdown-content h1 {
            font-size: 1.8em;
            color: #7dff7d;
            margin: 0.5em 0;
            border-bottom: 2px solid #3a4250;
            padding-bottom: 0.3em;
        }

        .markdown-content h2 {
            font-size: 1.4em;
            color: #7dccff;
            margin: 0.5em 0;
        }

        .markdown-content h3 {
            font-size: 1.2em;
            color: #ffaa7d;
            margin: 0.5em 0;
        }

        .markdown-content strong {
            color: #fff;
            font-weight: bold;
        }

        .markdown-content em {
            font-style: italic;
            color: #a0a8b0;
        }

        .markdown-content ul {
            margin: 0.5em 0;
            padding-left: 1.5em;
        }

        .markdown-content li {
            margin: 0.3em 0;
            color: #c0c8d0;
        }

        .markdown-content p {
            margin: 0.8em 0;
        }

        .markdown-content hr {
            border: none;
            border-top: 1px solid #3a4250;
            margin: 1em 0;
        }

        .markdown-content pre {
            background: #0a0d15;
            border: 1px solid #3a4250;
            border-radius: 4px;
            padding: 1em;
            overflow-x: auto;
        }

        .markdown-content code {
            font-family: 'Courier New', monospace;
            color: #7dff7d;
        }

        /* Stream output */
        .stream-output {
            background: #0a0d15;
            border: 2px solid;
            border-color: #1a1d25 #3a4250 #3a4250 #1a1d25;
            border-radius: 6px;
            padding: 16px;
            font-family: var(--font-main);
            font-size: var(--font-size-sm);
            color: #7dff7d;
            max-height: 150px;
            overflow-y: auto;
            display: none;
            margin-bottom: 16px;
        }
        
        .stream-output.active { display: block; }
        
        /* ============== FORM ELEMENTS ============== */
        .form-row {
            display: flex;
            gap: 14px;
            margin-bottom: 18px;
        }
        
        .form-group {
            flex: 1;
        }
        
        .form-label {
            display: block;
            font-size: var(--font-size-sm);
            color: var(--color-accent);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.6px;
            margin-bottom: 10px;
            line-height: 1.4;
        }
        
        .form-select, .form-input {
            width: 100%;
            padding: 14px 16px;
            background: var(--color-bg);
            border: 2px solid var(--color-border);
            border-radius: 12px;
            color: var(--color-text);
            font-family: var(--font-main);
            font-size: var(--font-size-md);
            font-weight: 400;
            line-height: var(--line-height-normal);
            transition: all 0.2s ease;
        }
        
        .form-select:hover, .form-input:hover {
            border-color: var(--color-accent);
            background: var(--color-surface);
        }
        
        .form-select:focus, .form-input:focus {
            outline: none;
            border-color: var(--color-accent);
            background: var(--color-surface);
            box-shadow: 0 0 0 4px rgba(79, 110, 247, 0.15);
        }
        
        .form-select option {
            background: var(--color-surface);
            color: #c0c8d0;
        }

        /* ============== TOGGLE SWITCH ============== */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 26px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--color-bg-secondary);
            border: 2px solid var(--color-border);
            transition: all 0.3s ease;
            border-radius: 26px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 2px;
            bottom: 2px;
            background-color: var(--color-text-muted);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .toggle-switch input:checked + .toggle-slider {
            background: var(--accent-gradient);
            border-color: var(--color-accent);
            box-shadow: 0 0 12px rgba(91, 124, 255, 0.4);
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(22px);
            background-color: #ffffff;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
        }

        .toggle-switch input:focus + .toggle-slider {
            box-shadow: 0 0 0 4px rgba(91, 124, 255, 0.2);
        }
        
        .prompt-hint {
            font-size: var(--font-size-sm);
            color: var(--color-accent);
            margin-bottom: 8px;
            opacity: 0.9;
            font-weight: 500;
            line-height: 1.4;
        }
        
        .prompt-area {
            width: 100%;
            min-height: 140px;
            padding: 14px;
            background: var(--color-bg);
            border: 2px solid var(--color-border);
            border-radius: 12px;
            color: var(--color-text);
            font-family: var(--font-main);
            font-size: var(--font-size-md);
            font-weight: 400;
            resize: vertical;
            line-height: var(--line-height-relaxed);
            transition: all 0.2s ease;
        }
        
        .prompt-area::placeholder { color: var(--color-text-muted); }
        .prompt-area:focus { 
            outline: none; 
            border-color: var(--color-accent);
            box-shadow: 0 0 0 4px rgba(91, 124, 255, 0.15);
        }

        /* Source selection buttons */
        .source-option {
            cursor: pointer;
        }
        .source-option input[type="radio"] {
            display: none;
        }
        .source-btn {
            display: inline-block;
            padding: 10px 18px;
            background: var(--color-surface);
            border: 2px solid var(--color-border);
            border-radius: 10px;
            color: var(--color-text-secondary);
            font-family: var(--font-main);
            font-size: var(--font-size-sm);
            font-weight: 500;
            transition: all 0.2s ease;
        }
        .source-option input[type="radio"]:checked + .source-btn {
            background: var(--accent-gradient);
            border-color: var(--color-accent);
            color: #ffffff;
            box-shadow: 0 4px 12px rgba(91, 124, 255, 0.4);
            font-weight: 600;
        }
        .source-btn:hover {
            border-color: var(--color-accent);
            color: var(--color-accent);
            background: rgba(91, 124, 255, 0.1);
        }

        /* ============== MAIN NAVIGATION TABS ============== */
        .main-nav {
            display: flex;
            gap: 4px;
            padding: 8px 24px;
            background: var(--color-bg);
            border-bottom: 1px solid var(--color-border);
        }
        .main-nav-tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-radius: 10px;
            color: var(--color-text-secondary);
            font-family: var(--font-main);
            font-size: var(--font-size-md);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            line-height: 1.4;
        }
        .main-nav-tab:hover {
            color: var(--color-text);
            background: var(--color-surface);
        }
        .main-nav-tab.active {
            background: var(--color-surface);
            color: var(--color-accent);
            box-shadow: var(--shadow-sm);
            font-weight: 600;
        }
        .main-nav-tab-icon {
            margin-right: 8px;
        }
        .main-nav-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 20px;
            height: 20px;
            padding: 0 6px;
            margin-left: 8px;
            background: #f69029;
            border-radius: 10px;
            font-size: 11px;
            color: #1a1d25;
            font-weight: bold;
        }

        /* Tab content panels */
        .tab-panel {
            display: none;
        }
        .tab-panel.active {
            display: block;
        }

        /* Time range buttons */
        .time-range-btn {
            padding: 10px 14px;
            background: var(--color-surface);
            border: 2px solid var(--color-border);
            border-radius: 10px;
            color: var(--color-text-secondary);
            font-family: var(--font-main);
            font-size: var(--font-size-sm);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            line-height: 1.3;
        }
        .time-range-btn:hover {
            border-color: var(--color-accent);
            color: var(--color-accent);
            background: rgba(91, 124, 255, 0.1);
            transform: translateY(-1px);
        }
        .time-range-btn.active {
            background: var(--accent-gradient);
            border-color: var(--color-accent);
            color: #ffffff;
            box-shadow: 0 4px 12px rgba(91, 124, 255, 0.4);
            font-weight: 600;
        }

        /* Channel tag with remove button */
        .channel-tag {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: linear-gradient(135deg, rgba(91, 124, 255, 0.2), rgba(124, 94, 255, 0.2));
            border: 1px solid var(--color-border);
            border-radius: 20px;
            font-size: var(--font-size-sm);
            font-weight: 600;
            color: var(--color-accent);
            line-height: 1.3;
        }
        .channel-tag-remove {
            cursor: pointer;
            opacity: 0.7;
            transition: all 0.2s ease;
            color: var(--color-error);
        }
        .channel-tag-remove:hover {
            opacity: 1;
            transform: scale(1.1);
        }

        /* Search mode tabs */
        .search-mode-tab {
            flex: 1;
            padding: 14px 18px;
            background: var(--color-surface);
            border: none;
            border-bottom: 3px solid transparent;
            color: var(--color-text-secondary);
            font-family: var(--font-main);
            font-size: var(--font-size-md);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            line-height: 1.4;
        }
        .search-mode-tab:hover {
            color: var(--color-accent);
            background: rgba(91, 124, 255, 0.1);
        }
        .search-mode-tab.active {
            background: var(--color-surface-elevated);
            color: var(--color-accent);
            border-bottom-color: var(--color-accent);
            font-weight: 600;
            box-shadow: 0 -2px 8px rgba(91, 124, 255, 0.2);
        }
        .search-mode-panel {
            display: none;
        }
        .search-mode-panel.active {
            display: block;
        }

        /* Tracker filter buttons */
        .tracker-filter {
            padding: 10px 18px;
            background: var(--color-surface);
            border: 2px solid var(--color-border);
            border-radius: 10px;
            color: var(--color-text-secondary);
            font-family: var(--font-main);
            font-size: var(--font-size-md);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            line-height: 1.3;
        }
        .tracker-filter:hover {
            border-color: var(--color-accent);
            color: var(--color-accent);
            background: rgba(91, 124, 255, 0.1);
        }
        .tracker-filter.active {
            background: var(--accent-gradient);
            border-color: var(--color-accent);
            color: #ffffff;
            box-shadow: 0 4px 12px rgba(91, 124, 255, 0.4);
            font-weight: 600;
        }

        /* Tracker list */
        .tracker-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 16px;
        }
        .tracker-empty {
            grid-column: 1 / -1;
            text-align: center;
            padding: 60px 20px;
            background: var(--color-surface);
            border: 2px dashed var(--color-border);
            border-radius: 16px;
            color: var(--color-text-muted);
        }

        /* Tracker card */
        .tracker-card {
            background: linear-gradient(180deg, #2d333f, #252932);
            border: 2px solid #3a4250;
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.2s;
        }
        .tracker-card.active {
            border-color: #7dff7d;
            box-shadow: 0 4px 20px rgba(125, 255, 125, 0.2);
        }
        .tracker-card:hover {
            border-color: #4a9eff;
            box-shadow: 0 4px 20px rgba(74, 158, 255, 0.2);
        }
        .tracker-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: linear-gradient(180deg, #3a4250, #2d333f);
            border-bottom: 2px solid #252932;
        }
        /* дата в хедере трекера */
        .tracker-card-date {
            font-size: 11px;
            color: #8a9aa9;
            margin-left: auto;
            padding-right: 4px;
        }
        
        /* текст вакансии (под заголовком) */
        .tracker-card-text {
            --max-lines: 3;
            --line-height: 1.4;
            /* max-height: calc(var(--line-height) * 1em * var(--max-lines)); */
            overflow-y: auto;          /* разрешаем скролл */

            font-size: var(--font-size-sm);
            color: #a0b0c0;
            line-height: var(--line-height);
            margin-bottom: 8px;
            padding: 8px;
            background: rgba(0,0,0,.2);
            border-left: 2px solid #4a6a8a;
            border-radius: 0 4px 4px 0;

            /* ---------- кастомный скролл ---------- */
            scrollbar-width: thin;              /* Firefox */
            scrollbar-color: #4a6a8a transparent;
        }

        /* Chrome / Edge / Safari */
        .tracker-card-text::-webkit-scrollbar {
            width: 6px;                 /* толщина вертикального скролла */
        }
        .tracker-card-text::-webkit-scrollbar-track {
            background: transparent;    /* фон «дорожки» */
        }
        .tracker-card-text::-webkit-scrollbar-thumb {
            background-color: #4a6a8a;
            border-radius: 3px;         /* скругление ползунка */
        }
        .tracker-card-source {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: var(--font-size-sm);
            color: #7dff7d;
        }
        .tracker-card-status {
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
        }
        .tracker-card-status.wishlist { background: #3a5070; color: #4a9eff; }
        .tracker-card-status.applied { background: #4a5030; color: #a0c040; }
        .tracker-card-status.interview { background: #5a4030; color: #f69029; }
        .tracker-card-status.offer { background: #305030; color: #7dff7d; }
        .tracker-card-status.rejected { background: #503030; color: #ff6060; }
        .tracker-card-body {
            padding: 16px;
        }
        .tracker-card-title {
            font-size: var(--font-size-md);
            color: #e0e8f0;
            margin-bottom: 8px;
            font-weight: 500;
        }
        .tracker-card-company {
            font-size: var(--font-size-sm);
            color: #7dff7d;
            margin-bottom: 12px;
        }

        .tracker-card-summary {
            font-size: var(--font-size-sm);
            color: #a0b0c0;
            line-height: 1.4;
            margin-bottom: 8px;
            padding: 6px 8px;
            background: rgba(0, 0, 0, 0.2);
            border-left: 2px solid #4a6a8a;
            border-radius: 0 4px 4px 0;
            font-size: 11px;
        }

        .tracker-card-actions {
            display: flex;
            gap: 8px;
            padding: 12px 16px;
            border-top: 1px solid #3a4250;
            flex-wrap: wrap;
        }
        .tracker-card-actions select {
            flex: 1;
            min-width: 140px;
            padding: 8px 12px;
            background: #1a1d25;
            border: 2px solid #3a4250;
            border-radius: 6px;
            color: #7dff7d;
            font-family: var(--font-main);
            font-size: var(--font-size-sm);
            cursor: pointer;
        }
        .tracker-card-actions select:focus {
            outline: none;
            border-color: #4a9eff;
        }
        
        /* Quick action buttons */
        .quick-actions {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }
        .quick-action-btn {
            padding: 6px 10px;
            background: linear-gradient(180deg, #2d333f, #252932);
            border: 1px solid #3a4250;
            border-radius: 4px;
            color: #7dff7d;
            font-family: var(--font-main);
            font-size: 10px;
            cursor: pointer;
            transition: all 0.2s;
            opacity: 0.7;
        }
        .quick-action-btn:hover {
            opacity: 1;
            border-color: #4a9eff;
            transform: translateY(-1px);
        }
        .quick-action-btn.active {
            opacity: 1;
            border-color: #7dff7d;
            background: linear-gradient(180deg, #2a5a4a, #1a4a3a);
        }
        
        /* Status badge improvements */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
            position: relative;
        }
        .status-badge.wishlist { background: rgba(74, 158, 255, 0.15); color: #4a9eff; border: 1px solid rgba(74, 158, 255, 0.3); }
        .status-badge.applied { background: rgba(246, 144, 41, 0.15); color: #f69029; border: 1px solid rgba(246, 144, 41, 0.3); }
        .status-badge.interview { background: rgba(180, 120, 255, 0.15); color: #b478ff; border: 1px solid rgba(180, 120, 255, 0.3); }
        .status-badge.offer { background: rgba(125, 255, 125, 0.15); color: #7dff7d; border: 1px solid rgba(125, 255, 125, 0.3); }
        .status-badge.rejected { background: rgba(255, 96, 96, 0.15); color: #ff6060; border: 1px solid rgba(255, 96, 96, 0.3); }
        
        /* Match score improvements */
        .match-meter {
            margin: 12px 0;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
            border: 1px solid #3a4250;
        }
        .match-meter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }
        .match-meter-label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: #5a6a7a;
            font-family: var(--font-main);
        }
        .match-meter-icon {
            font-size: 14px;
        }
        .match-meter-value {
            font-size: 14px;
            font-weight: bold;
            font-family: var(--font-main);
        }
        .match-meter-value.high { color: #7dff7d; }
        .match-meter-value.medium { color: #f69029; }
        .match-meter-value.low { color: #ff6060; }
        .match-meter-bar {
            height: 6px;
            background: #1a1d25;
            border-radius: 3px;
            overflow: hidden;
            border: 1px solid #2a303a;
        }
        .match-meter-fill {
            height: 100%;
            transition: width 0.3s ease;
            border-radius: 3px;
        }
        .match-meter-fill.high { background: linear-gradient(90deg, #7dff7d, #5ddf5d); }
        .match-meter-fill.medium { background: linear-gradient(90deg, #f69029, #d67009); }
        .match-meter-fill.low { background: linear-gradient(90deg, #ff6060, #df4040); }
        
        /* Tracker card improvements */
        .tracker-card-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(58, 66, 80, 0.5);
            font-size: 10px;
            color: #5a6a7a;
        }
        .tracker-card-time {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        /* Filter badges with counts */
        .tracker-filter-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 20px;
            height: 18px;
            padding: 0 6px;
            margin-left: 6px;
            background: rgba(125, 255, 125, 0.2);
            border-radius: 9px;
            font-size: 10px;
            color: #7dff7d;
            font-weight: bold;
        }
        
        /* Search in tracker */
        .tracker-search {
            margin-bottom: 16px;
        }
        .tracker-search-input {
            width: 100%;
            padding: 10px 14px;
            background: #1a1d25;
            border: 2px solid #3a4250;
            border-radius: 6px;
            color: #7dff7d;
            font-family: var(--font-main);
            font-size: var(--font-size-sm);
        }
        .tracker-search-input:focus {
            outline: none;
            border-color: #4a9eff;
        }
        .tracker-search-input::placeholder {
            color: #5a6a7a;
        }

        /* ============== LAYOUT ============== */
        .app-container {
            padding: 24px;
            max-width: 1800px;
            margin: 0 auto;
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 480px;
            gap: 20px;
        }
        
        @media (max-width: 1200px) {
            .main-grid { grid-template-columns: 1fr 420px; }
        }
        
        @media (max-width: 1000px) {
            .main-grid { grid-template-columns: 1fr; }
        }
        
        .left-column {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .right-column {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        /* Hidden file input */
        .hidden-input { display: none; }

        /* ============== TOAST NOTIFICATIONS ============== */
        .toast-container {
            position: fixed;
            top: 24px;
            right: 24px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 14px;
            pointer-events: none;
        }
        .toast {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 16px;
            padding: 16px 20px;
            min-width: 300px;
            max-width: 400px;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 14px;
            pointer-events: auto;
            animation: toastSlideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
            overflow: hidden;
        }
        .toast::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
        }
        .toast.success {
            border-color: rgba(0, 196, 140, 0.3);
            background: linear-gradient(135deg, var(--color-surface) 0%, rgba(0, 196, 140, 0.05) 100%);
        }
        .toast.success::before {
            background: var(--color-success);
        }
        .toast.error {
            border-color: rgba(255, 92, 92, 0.3);
            background: linear-gradient(135deg, var(--color-surface) 0%, rgba(255, 92, 92, 0.05) 100%);
        }
        .toast.error::before {
            background: var(--color-error);
        }
        .toast.warning {
            border-color: rgba(255, 170, 0, 0.3);
            background: linear-gradient(135deg, var(--color-surface) 0%, rgba(255, 170, 0, 0.05) 100%);
        }
        .toast.warning::before {
            background: var(--color-warning);
        }
        .toast.info {
            border-color: rgba(0, 180, 216, 0.3);
            background: linear-gradient(135deg, var(--color-surface) 0%, rgba(0, 180, 216, 0.05) 100%);
        }
        .toast.info::before {
            background: var(--color-info);
        }
        .toast-icon {
            font-size: 22px;
            flex-shrink: 0;
        }
        .toast-content {
            flex: 1;
            font-family: var(--font-main);
            font-size: var(--font-size-md);
            color: var(--color-text);
            line-height: var(--line-height-normal);
        }
        .toast-title {
            font-weight: 600;
            margin-bottom: 4px;
            line-height: 1.3;
        }
        .toast-message {
            color: var(--color-text-secondary);
            font-size: var(--font-size-sm);
            line-height: var(--line-height-relaxed);
        }
        .toast-close {
            background: none;
            border: none;
            color: var(--color-text-muted);
            font-size: 18px;
            cursor: pointer;
            padding: 0;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: all 0.2s ease;
        }
        .toast-close:hover {
            background: var(--color-bg-secondary);
            color: var(--color-text);
        }
        @keyframes toastSlideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        @keyframes toastSlideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }
        .toast.hiding {
            animation: toastSlideOut 0.3s ease-in forwards;
        }

        /* ============== LOADING SPINNER ============== */
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(125, 255, 125, 0.3);
            border-top-color: #7dff7d;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .btn-loading {
            position: relative;
            pointer-events: none;
            opacity: 0.7;
        }
        .btn-loading::after {
            content: '';
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 16px;
            height: 16px;
            border: 2px solid rgba(125, 255, 125, 0.3);
            border-top-color: #7dff7d;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        /* ============== CONFIRMATION MODAL ============== */
        .confirm-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }
        .confirm-modal.active {
            display: flex;
        }
        .confirm-dialog {
            background: linear-gradient(180deg, #3a4250, #2d333f);
            border: 4px solid #5a6070;
            border-radius: 12px;
            padding: 24px;
            max-width: 400px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.8);
        }
        .confirm-title {
            font-family: var(--font-main);
            font-size: var(--font-size-lg);
            color: #ff6060;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .confirm-message {
            font-family: var(--font-main);
            font-size: var(--font-size-sm);
            color: #7dff7d;
            margin-bottom: 20px;
            line-height: 1.5;
        }
        .confirm-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }
        .confirm-btn {
            padding: 10px 20px;
            border: 2px solid;
            border-radius: 6px;
            font-family: var(--font-main);
            font-size: var(--font-size-sm);
            cursor: pointer;
            transition: all 0.2s;
        }
        .confirm-btn.cancel {
            background: linear-gradient(180deg, #3a4250, #2d333f);
            border-color: #5a6070;
            color: #7dff7d;
        }
        .confirm-btn.cancel:hover {
            border-color: #7dff7d;
            filter: brightness(1.1);
        }
        .confirm-btn.danger {
            background: linear-gradient(180deg, #8a4040, #6a3030);
            border-color: #ff6060;
            color: #ff6060;
        }
        .confirm-btn.danger:hover {
            filter: brightness(1.2);
        }

        /* ============== TOOLTIP ============== */
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip-text {
            visibility: hidden;
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(180deg, #2d333f, #1a1d25);
            color: #7dff7d;
            font-family: var(--font-main);
            font-size: var(--font-size-xs);
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #3a4250;
            white-space: nowrap;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.2s, visibility 0.2s;
            pointer-events: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
        }
        .tooltip-text::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: #2d333f;
        }
        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        /* ============== VACANCY TEXT FORMATTING ============== */
        .vacancy-formatted {
            font-family: var(--font-main);
            font-size: var(--font-size-sm);
            color: #c0c8d0;
            line-height: 1.7;
        }

        .vacancy-empty {
            color: #5a6070;
            font-style: italic;
            text-align: center;
            padding: 32px;
        }

        .vacancy-intro {
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid rgba(90, 130, 140, 0.2);
        }

        .vacancy-section {
            margin-bottom: 20px;
            padding: 16px;
            background: linear-gradient(180deg, rgba(30, 50, 60, 0.4), rgba(20, 35, 45, 0.3));
            border: 1px solid rgba(90, 130, 140, 0.25);
            border-radius: 8px;
            transition: border-color 0.2s ease;
        }

        .vacancy-section:hover {
            border-color: rgba(90, 130, 140, 0.45);
        }

        .vacancy-section-header {
            font-size: 13px;
            font-weight: 600;
            color: #7dddaa;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(125, 221, 170, 0.2);
        }

        .vacancy-section-content {
            color: #b8c4cc;
        }

        .vacancy-paragraph {
            margin: 0 0 10px 0;
            line-height: 1.7;
        }

        .vacancy-paragraph:last-child {
            margin-bottom: 0;
        }

        .vacancy-list {
            margin: 8px 0;
            padding-left: 0;
            list-style: none;
        }

        .vacancy-list li {
            position: relative;
            padding-left: 20px;
            margin-bottom: 8px;
            line-height: 1.6;
        }

        .vacancy-list li::before {
            content: '▸';
            position: absolute;
            left: 0;
            color: #5a9a7a;
            font-size: 12px;
        }

        .vacancy-list li:last-child {
            margin-bottom: 0;
        }

        .vacancy-tag {
            display: inline-block;
            background: rgba(74, 158, 255, 0.15);
            color: #6ab4ff;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin: 0 2px;
        }

        .vacancy-link {
            color: #4a9eff;
            text-decoration: none;
            border-bottom: 1px dotted rgba(74, 158, 255, 0.4);
            transition: all 0.2s ease;
        }

        .vacancy-link:hover {
            color: #7dbfff;
            border-bottom-color: rgba(74, 158, 255, 0.8);
        }

        .vacancy-salary {
            display: inline-block;
            background: rgba(125, 221, 170, 0.15);
            color: #7dddaa;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 500;
            font-size: 13px;
        }

        .vacancy-loading {
            color: #6a8aaa;
            text-align: center;
            padding: 24px;
            font-style: italic;
        }

        .vacancy-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(90, 130, 140, 0.2);
        }

        .vacancy-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            background: rgba(90, 130, 140, 0.2);
            color: #a0b8c8;
        }

        .vacancy-badge.salary {
            background: rgba(125, 221, 170, 0.2);
            color: #7dddaa;
        }

        .vacancy-badge.remote {
            background: rgba(74, 158, 255, 0.2);
            color: #6ab4ff;
        }

        .vacancy-badge.office {
            background: rgba(255, 180, 100, 0.2);
            color: #ffb464;
        }

        .vacancy-tech-stack {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 16px;
        }

        .vacancy-tech {
            display: inline-block;
            padding: 3px 8px;
            background: rgba(140, 100, 200, 0.15);
            color: #b090d0;
            border-radius: 4px;
            font-size: 11px;
            font-family: var(--font-mono, monospace);
            text-transform: lowercase;
        }

        .vacancy-contacts-section {
            margin-top: 20px;
            padding: 16px;
            background: linear-gradient(180deg, rgba(40, 50, 70, 0.4), rgba(30, 40, 55, 0.3));
            border: 1px solid rgba(100, 140, 180, 0.25);
            border-radius: 8px;
        }

        .vacancy-contacts-header {
            font-size: 13px;
            font-weight: 600;
            color: #8ab4e8;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(138, 180, 232, 0.2);
        }

        .vacancy-contacts-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .vacancy-contact {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: rgba(60, 80, 100, 0.3);
            border: 1px solid rgba(100, 140, 180, 0.2);
            border-radius: 6px;
            font-size: 13px;
            color: #b0c8e0;
            text-decoration: none;
            transition: all 0.2s ease;
        }

        a.vacancy-contact:hover {
            background: rgba(74, 158, 255, 0.15);
            border-color: rgba(74, 158, 255, 0.4);
            color: #8ac4ff;
        }

        .contact-icon {
            font-size: 14px;
        }

        .contact-value {
            font-family: var(--font-mono, monospace);
        }

        .contact-label {
            font-size: 10px;
            padding: 2px 6px;
            background: rgba(125, 221, 170, 0.2);
            color: #7dddaa;
            border-radius: 3px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Contact type colors */
        .contact-email { border-left: 3px solid #e8a87c; }
        .contact-telegram { border-left: 3px solid #54a9eb; }
        .contact-phone { border-left: 3px solid #7dddaa; }
        .contact-whatsapp { border-left: 3px solid #25d366; }
        .contact-linkedin { border-left: 3px solid #0077b5; }
        .contact-form { border-left: 3px solid #b090d0; }
        .contact-website { border-left: 3px solid #6ab4ff; }
        .contact-discord { border-left: 3px solid #7289da; }
        .contact-skype { border-left: 3px solid #00aff0; }

        .vacancy-section[data-confidence="low"] {
            border-left: 3px solid rgba(255, 180, 100, 0.5);
        }

        .vacancy-section[data-confidence="high"] {
            border-left: 3px solid rgba(125, 221, 170, 0.5);
        }
    </style>
</head>
<body>
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- Confirmation Modal -->
    <div class="confirm-modal" id="confirmModal">
        <div class="confirm-dialog">
            <div class="confirm-title">
                <span>⚠️</span>
                <span id="confirmTitle">Confirm Action</span>
            </div>
            <div class="confirm-message" id="confirmMessage"></div>
            <div class="confirm-actions">
                <button class="confirm-btn cancel" onclick="confirmCancel()">Cancel</button>
                <button class="confirm-btn danger" id="confirmOkBtn" onclick="confirmOk()">Confirm</button>
            </div>
        </div>
    </div>
    <!-- Подключаем модуль авторизации -->
    <div class="app-container">
        <div class="chrome-panel">
            <div class="chrome-panel-middle">
                <div class="chrome-panel-inner">
                    <!-- Title Bar -->
                    <div class="title-bar">
                        <div class="title-bar-content">
                            <div style="display: flex; align-items: center;">
                                <div class="title-leds">
                                    <div class="led green"></div>
                                    <div class="led orange"></div>
                                </div>
                                <span class="title-text">iGet</span>
                            </div>
                            <div class="window-controls">
                                <button class="win-btn minimize">_</button>
                                <button class="win-btn close">×</button>
                            </div>
                        </div>
                    </div>

                    <!-- Main Navigation Tabs -->
                    <div class="main-nav">
                        <button class="main-nav-tab" onclick="switchMainTab('home')">
                            <span class="main-nav-tab-icon">🏠</span>HOME
                        </button>
                        <button class="main-nav-tab active" onclick="switchMainTab('search')">
                            <span class="main-nav-tab-icon">🔍</span>SEARCH
                        </button>
                        <button class="main-nav-tab" onclick="switchMainTab('resume')">
                            <span class="main-nav-tab-icon">📄</span>RESUMES
                        </button>
                        <button class="main-nav-tab" onclick="switchMainTab('tracker')">
                            <span class="main-nav-tab-icon">📋</span>TRACKER
                            <span class="main-nav-badge" id="trackerBadge" style="display: none;">0</span>
                        </button>
                    </div>

                    <!-- HOME TAB -->
                    <div class="tab-panel" id="tabHome">
                        <div class="content-area" style="padding: 20px;">
                            <!-- Single Unified LCD Panel -->
                            <div class="lcd-panel" style="max-width: 1600px; margin: 0 auto;">
                                <div class="lcd-screen" style="padding: 24px;">
                                    
                                    <!-- SEARCH STATISTICS Section -->
                                    <div style="margin-bottom: 20px;">
                                        <div class="lcd-title" style="font-size: 15px; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                                            <span style="font-size: 22px;">🔍</span> SEARCH STATISTICS
                                        </div>
                                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">
                                            <div style="text-align: center; padding: 14px 10px; background: rgba(125,255,125,0.08); border-radius: 6px; border: 1px solid #2a4040;">
                                                <div style="font-size: 28px; color: #7dff7d; font-weight: bold;" id="homeStatFound">0</div>
                                                <div style="color: #5a7a6a; font-size: 11px; margin-top: 4px;">FOUND</div>
                                            </div>
                                            <div style="text-align: center; padding: 14px 10px; background: rgba(74,158,255,0.08); border-radius: 6px; border: 1px solid #2a4060;">
                                                <div style="font-size: 28px; color: #4a9eff; font-weight: bold;" id="homeStatProcessed">0</div>
                                                <div style="color: #5a6a8a; font-size: 11px; margin-top: 4px;">PROCESSED</div>
                                            </div>
                                            <div style="text-align: center; padding: 14px 10px; background: rgba(255,96,96,0.08); border-radius: 6px; border: 1px solid #503030;">
                                                <div style="font-size: 28px; color: #ff6060; font-weight: bold;" id="homeStatRejected">0</div>
                                                <div style="color: #8a5a5a; font-size: 11px; margin-top: 4px;">REJECTED</div>
                                            </div>
                                            <div style="text-align: center; padding: 14px 10px; background: rgba(125,255,125,0.12); border-radius: 6px; border: 1px solid #3a5050;">
                                                <div style="font-size: 28px; color: #7dff7d; font-weight: bold;" id="homeStatSuitable">0</div>
                                                <div style="color: #5a8a6a; font-size: 11px; margin-top: 4px;">SUITABLE</div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Divider -->
                                    <div style="height: 1px; background: rgba(125, 255, 125, 0.2); margin: 16px 0;"></div>

                                    <!-- TRACKER PIPELINE Section -->
                                    <div style="margin-bottom: 20px;">
                                        <div class="lcd-title" style="font-size: 15px; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                                            <span style="font-size: 22px;">📋</span> TRACKER PIPELINE
                                        </div>
                                        <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 14px;">
                                            <div style="text-align: center; padding: 12px 8px; background: rgba(74,158,255,0.1); border-radius: 6px; border: 1px solid #3a5070;">
                                                <div style="font-size: 26px; color: #4a9eff; font-weight: bold;" id="homeStatWishlist">0</div>
                                                <div style="color: #5a6a8a; font-size: 10px; margin-top: 3px;">💭 WISHLIST</div>
                                            </div>
                                            <div style="text-align: center; padding: 12px 8px; background: rgba(246,144,41,0.1); border-radius: 6px; border: 1px solid #705030;">
                                                <div style="font-size: 26px; color: #f69029; font-weight: bold;" id="homeStatApplied">0</div>
                                                <div style="color: #8a6a4a; font-size: 10px; margin-top: 3px;">📤 APPLIED</div>
                                            </div>
                                            <div style="text-align: center; padding: 12px 8px; background: rgba(180,120,255,0.1); border-radius: 6px; border: 1px solid #504070;">
                                                <div style="font-size: 26px; color: #b478ff; font-weight: bold;" id="homeStatInterview">0</div>
                                                <div style="color: #7a5a9a; font-size: 10px; margin-top: 3px;">🎤 INTERVIEW</div>
                                            </div>
                                            <div style="text-align: center; padding: 12px 8px; background: rgba(125,255,125,0.12); border-radius: 6px; border: 1px solid #3a6050;">
                                                <div style="font-size: 26px; color: #7dff7d; font-weight: bold;" id="homeStatOffer">0</div>
                                                <div style="color: #5a8a6a; font-size: 10px; margin-top: 3px;">🎉 OFFER</div>
                                            </div>
                                            <div style="text-align: center; padding: 12px 8px; background: rgba(255,96,96,0.08); border-radius: 6px; border: 1px solid #503030;">
                                                <div style="font-size: 26px; color: #ff6060; font-weight: bold;" id="homeStatTrackerRejected">0</div>
                                                <div style="color: #8a5a5a; font-size: 10px; margin-top: 3px;">❌ REJECTED</div>
                                            </div>
                                        </div>
                                        <!-- Pipeline Progress Bar -->
                                        <div>
                                            <div style="color: #5a6a7a; font-size: 11px; margin-bottom: 6px;">PIPELINE PROGRESS</div>
                                            <div style="display: flex; height: 24px; border-radius: 5px; overflow: hidden; background: #1a1d25; border: 1px solid #2a303a;">
                                                <div id="pipelineWishlist" style="background: linear-gradient(180deg, #4a9eff, #3a7edf); transition: width 0.3s;"></div>
                                                <div id="pipelineApplied" style="background: linear-gradient(180deg, #f69029, #d67009); transition: width 0.3s;"></div>
                                                <div id="pipelineInterview" style="background: linear-gradient(180deg, #b478ff, #9458df); transition: width 0.3s;"></div>
                                                <div id="pipelineOffer" style="background: linear-gradient(180deg, #7dff7d, #5ddf5d); transition: width 0.3s;"></div>
                                                <div id="pipelineRejected" style="background: linear-gradient(180deg, #ff6060, #df4040); transition: width 0.3s;"></div>
                                            </div>
                                            <div style="display: flex; justify-content: space-between; margin-top: 6px; font-size: 10px; color: #4a5a6a;">
                                                <span>Total: <span id="homeStatTrackerTotal" style="color: #7dff7d;">0</span></span>
                                                <span>Success rate: <span id="homeStatSuccessRate" style="color: #7dff7d;">0%</span></span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Divider -->
                                    <div style="height: 1px; background: rgba(125, 255, 125, 0.2); margin: 16px 0;"></div>

                                    <!-- STATISTICS OVERVIEW Section -->
                                    <div>
                                        <div class="lcd-title" style="font-size: 15px; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                                            <span style="font-size: 22px;">📊</span> STATISTICS OVERVIEW
                                        </div>
                                        <div style="display: grid; grid-template-columns: auto 1fr; gap: 24px; align-items: start;">
                                            <!-- Pie Chart Canvas -->
                                            <div style="display: flex; justify-content: center; align-items: center;">
                                                <canvas id="statsChart" width="220" height="220" style="width: 220px; height: 220px;"></canvas>
                                            </div>
                                            <!-- Stats Summary -->
                                            <div>
                                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 14px;">
                                                    <div style="padding: 14px; background: rgba(125,255,125,0.05); border-radius: 6px; border: 1px solid #2a4040;">
                                                        <div style="color: #5a7a6a; font-size: 11px; margin-bottom: 4px;">MATCH RATE</div>
                                                        <div style="font-size: 22px; color: #7dff7d; font-weight: bold;" id="homeMatchRate">0%</div>
                                                    </div>
                                                    <div style="padding: 14px; background: rgba(74,158,255,0.05); border-radius: 6px; border: 1px solid #2a4060;">
                                                        <div style="color: #5a6a8a; font-size: 11px; margin-bottom: 4px;">SUCCESS RATE</div>
                                                        <div style="font-size: 22px; color: #4a9eff; font-weight: bold;" id="homeSuccessRate">0%</div>
                                                    </div>
                                                    <div style="padding: 14px; background: rgba(246,144,41,0.05); border-radius: 6px; border: 1px solid #504030;">
                                                        <div style="color: #8a6a4a; font-size: 11px; margin-bottom: 4px;">APPLY RATE</div>
                                                        <div style="font-size: 22px; color: #f69029; font-weight: bold;" id="homeApplyRate">0%</div>
                                                    </div>
                                                    <div style="padding: 14px; background: rgba(180,120,255,0.05); border-radius: 6px; border: 1px solid #403050;">
                                                        <div style="color: #7a5a9a; font-size: 11px; margin-bottom: 4px;">INTERVIEW RATE</div>
                                                        <div style="font-size: 22px; color: #b478ff; font-weight: bold;" id="homeInterviewRate">0%</div>
                                                    </div>
                                                </div>
                                                <div style="padding-top: 12px; border-top: 1px solid #2a303a; color: #5a6a7a; font-size: 11px;">
                                                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                                                        <div>Resume: <span id="homeResumeStatus" style="color: #7dff7d;">Not loaded</span></div>
                                                        <div>Channels: <span id="homeChannelsCount" style="color: #4a9eff;">0 configured</span></div>
                                                        <div>Search mode: <span id="homeSearchMode" style="color: #f69029;">Basic</span></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SEARCH TAB (Current main content) -->
                    <div class="tab-panel active" id="tabSearch">
                    <!-- Content -->
                    <div class="content-area">
                        <div class="main-grid">
                            <!-- Left Column -->
                            <div class="left-column">
                                <!-- LCD Display -->
                                <div class="lcd-panel">
                                    <div class="lcd-screen">
                                        <div class="lcd-header">
                                            <div style="display: flex; align-items: center;">
                                                <span class="lcd-title">VACANCY.SYS</span>
                                                <div class="lcd-dots" id="scanningDots" style="display: none;">
                                                    <div class="lcd-dot"></div>
                                                    <div class="lcd-dot"></div>
                                                    <div class="lcd-dot"></div>
                                                </div>
                                            </div>
                                            <span class="lcd-time" id="lcdTime">00:00:00</span>
                                        </div>
                                        
                                        <div class="lcd-stats">
                                            <div class="lcd-stat">
                                                <span class="lcd-stat-label">STATUS:</span>
                                                <span class="lcd-stat-value green" id="lcdStatus">IDLE</span>
                                            </div>
                                            <div class="lcd-stat">
                                                <span class="lcd-stat-label">FOUND:</span>
                                                <span class="lcd-stat-value orange" id="lcdFound">000</span>
                                            </div>
                                            <div class="lcd-stat">
                                                <span class="lcd-stat-label">PROCESSED:</span>
                                                <span class="lcd-stat-value blue" id="lcdProcessed">000</span>
                                            </div>
                                            <div class="lcd-stat">
                                                <span class="lcd-stat-label">REJECTED:</span>
                                                <span class="lcd-stat-value red" id="lcdRejected">000</span>
                                            </div>
                                            <div class="lcd-stat">
                                                <span class="lcd-stat-label">SUITABLE:</span>
                                                <span class="lcd-stat-value green" id="lcdSuitable">000</span>
                                            </div>
                                        </div>
                                        
                                        <div class="lcd-message">
                                            <span class="cursor">▸</span>
                                            <span id="lcdMessage">SYSTEM READY :: AWAITING INPUT</span>
                                        </div>
                                        
                                        <div class="lcd-progress" id="progressContainer" style="display: none;">
                                            <div class="lcd-progress-bar" id="progressBar" style="width: 0%;"></div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- VU Meter -->
                                <div class="vu-panel">
                                    <div class="vu-header">
                                        <span class="vu-title">
                                            LOAD METER
                                            <span class="vu-device" id="vuDevice">
                                                <span class="vu-device-icon">💻</span>
                                                <span id="vuDeviceName">CPU</span>
                                            </span>
                                        </span>
                                        <span class="vu-value" id="vuValue">0%</span>
                                    </div>
                                    <div class="vu-track">
                                        <div class="vu-segments-wrapper">
                                            <div class="vu-segments" id="vuSegments"></div>
                                            <div class="vu-needle" id="vuNeedle"></div>
                                        </div>
                                        <div class="vu-scale">
                                            <span class="green">0</span>
                                            <span class="yellow">60</span>
                                            <span class="red">85</span>
                                            <span class="red">100</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Vacancies Section -->
                                <div class="vacancy-section">
                                    <div class="vacancy-header">
                                        <div class="vacancy-header-dot"></div>
                                        <span class="vacancy-header-text">VACANCY DATABASE :: <span id="vacancyCount">0</span> RECORDS FOUND</span>
                                    </div>
                                    
                                    <div class="vacancies-grid" id="vacanciesGrid">
                                        <div class="empty-state">
                                            <div class="empty-state-icon">📡</div>
                                            <div class="empty-state-text">AWAITING SIGNAL...<br>PRESS SCAN TO BEGIN</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Right Column -->
                            <div class="right-column">
                                <!-- Search Mode Tabs -->
                                <div class="control-panel" style="padding: 0;">
                                    <div style="display: flex; border-bottom: 2px solid #1a1d25;">
                                        <button class="search-mode-tab active" onclick="switchSearchMode('basic')" id="searchModeBasic">
                                            📋 BASIC
                                        </button>
                                        <button class="search-mode-tab" onclick="switchSearchMode('advanced')" id="searchModeAdvanced">
                                            🤖 AI SEARCH
                                        </button>
                                    </div>

                                    <!-- BASIC SEARCH PANEL -->
                                    <div id="basicSearchPanel" class="search-mode-panel active" style="padding: 16px;">
                                        <!-- Time Range -->
                                        <div class="form-group" style="margin-bottom: 16px; border-bottom: 1px solid #2d333f; padding-bottom: 16px;">
                                            <label class="form-label">TIME RANGE</label>
                                            <div class="prompt-hint">How far back to search (applies to all sources: Telegram, HeadHunter, LinkedIn)</div>
                                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin-top: 8px;">
                                                <button class="time-range-btn" data-days="1" onclick="setTimeRange(1)">24h</button>
                                                <button class="time-range-btn" data-days="3" onclick="setTimeRange(3)">3 days</button>
                                                <button class="time-range-btn active" data-days="7" onclick="setTimeRange(7)">7 days</button>
                                                <button class="time-range-btn" data-days="14" onclick="setTimeRange(14)">14 days</button>
                                            </div>
                                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin-top: 6px;">
                                                <button class="time-range-btn" data-days="30" onclick="setTimeRange(30)">30 days</button>
                                                <button class="time-range-btn" data-days="60" onclick="setTimeRange(60)">60 days</button>
                                                <button class="time-range-btn" data-days="90" onclick="setTimeRange(90)">90 days</button>
                                            </div>
                                            <input type="hidden" id="daysBackBasic" value="7">
                                        </div>

                                        <!-- Telegram Parser -->
                                        <div class="form-group" style="margin-bottom: 16px; border-bottom: 1px solid #2d333f; padding-bottom: 16px;">
                                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                                                <label class="form-label" style="margin-bottom: 0;">📱 TELEGRAM CHANNELS</label>
                                                <label class="toggle-switch">
                                                    <input type="checkbox" id="enableTelegram" checked onchange="saveParserSettings()">
                                                    <span class="toggle-slider"></span>
                                                </label>
                                            </div>
                                            <div class="prompt-hint">Parse vacancies from Telegram channels</div>
                                            <div id="telegramSettings" style="display: block; margin-top: 12px;">
                                                <div style="display: flex; gap: 8px; margin-top: 8px;">
                                                    <input type="text" id="newChannelBasic" class="form-select" placeholder="channel_name" style="flex: 1;" onkeypress="if(event.key==='Enter') addChannelBasic()">
                                                    <button class="vacancy-btn" onclick="addChannelBasic()" style="padding: 8px 16px;">+ ADD</button>
                                                </div>
                                                <div id="channelTagsBasic" style="display: flex; flex-wrap: wrap; gap: 6px; margin-top: 10px;"></div>
                                            </div>
                                        </div>

                                        <!-- Keyword Filter -->
                                        <div class="form-group" style="margin-bottom: 16px;">
                                            <label class="form-label">KEYWORD FILTER (optional)</label>
                                            <div class="prompt-hint">Comma-separated keywords to filter results</div>
                                            <input type="text" id="keywordFilter" class="form-select" placeholder="e.g. Unreal, Unity, C++, remote" style="width: 100%; margin-top: 8px;">
                                        </div>

                                        <!-- HeadHunter Parser -->
                                        <div class="form-group" style="margin-bottom: 16px; border-top: 1px solid #2d333f; padding-top: 16px;">
                                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                                                <label class="form-label" style="margin-bottom: 0;">🎯 HEADHUNTER</label>
                                                <label class="toggle-switch">
                                                    <input type="checkbox" id="enableHeadHunter" onchange="saveParserSettings()">
                                                    <span class="toggle-slider"></span>
                                                </label>
                                            </div>
                                            <div class="prompt-hint">Parse vacancies from HeadHunter.ru</div>
                                            <div id="headHunterSettings" style="display: none; margin-top: 12px; padding: 12px; background: #1a1d25; border-radius: 8px; border: 1px solid #2d333f;">
                                                <div style="margin-bottom: 10px;">
                                                    <label style="display: block; margin-bottom: 4px; font-size: 12px; color: #7dff7d;">Search Query</label>
                                                    <input type="text" id="hhSearchQuery" class="form-select" placeholder="e.g. Python разработчик" style="width: 100%;" onchange="saveParserSettings()">
                                                </div>
                                                <div style="margin-bottom: 10px;">
                                                    <label style="display: block; margin-bottom: 4px; font-size: 12px; color: #7dff7d;">Region</label>
                                                    <select id="hhArea" class="form-select" style="width: 100%;" onchange="saveParserSettings()">
                                                        <option value="1">Москва</option>
                                                        <option value="2">Санкт-Петербург</option>
                                                        <option value="113">Россия</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label style="display: block; margin-bottom: 4px; font-size: 12px; color: #7dff7d;">Max Pages</label>
                                                    <input type="number" id="hhMaxPages" class="form-select" value="5" min="1" max="20" style="width: 100%;" onchange="saveParserSettings()">
                                                </div>
                                            </div>
                                        </div>

                                        <!-- LinkedIn Parser -->
                                        <div class="form-group" style="margin-bottom: 16px; border-top: 1px solid #2d333f; padding-top: 16px;">
                                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                                                <label class="form-label" style="margin-bottom: 0;">🔗 LINKEDIN</label>
                                                <label class="toggle-switch">
                                                    <input type="checkbox" id="enableLinkedIn" onchange="saveParserSettings()">
                                                    <span class="toggle-slider"></span>
                                                </label>
                                            </div>
                                            <div class="prompt-hint">Parse vacancies from LinkedIn (may be blocked)</div>
                                            <div id="linkedInSettings" style="display: none; margin-top: 12px; padding: 12px; background: #1a1d25; border-radius: 8px; border: 1px solid #2d333f;">
                                                <div style="margin-bottom: 10px;">
                                                    <label style="display: block; margin-bottom: 4px; font-size: 12px; color: #7dff7d;">Search Query</label>
                                                    <input type="text" id="linkedInSearchQuery" class="form-select" placeholder="e.g. Python Developer" style="width: 100%;" onchange="saveParserSettings()">
                                                </div>
                                                <div style="margin-bottom: 10px;">
                                                    <label style="display: block; margin-bottom: 4px; font-size: 12px; color: #7dff7d;">Location</label>
                                                    <input type="text" id="linkedInLocation" class="form-select" placeholder="e.g. Moscow, Russia" style="width: 100%;" onchange="saveParserSettings()">
                                                </div>
                                                <div style="margin-bottom: 10px;">
                                                    <label style="display: block; margin-bottom: 4px; font-size: 12px; color: #7dff7d;">Email (optional)</label>
                                                    <input type="email" id="linkedInEmail" class="form-select" placeholder="your@email.com" style="width: 100%;" onchange="saveParserSettings()">
                                                </div>
                                                <div>
                                                    <label style="display: block; margin-bottom: 4px; font-size: 12px; color: #7dff7d;">Password (optional)</label>
                                                    <input type="password" id="linkedInPassword" class="form-select" placeholder="••••••••" style="width: 100%;" onchange="saveParserSettings()">
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- ADVANCED (AI) SEARCH PANEL -->
                                    <div id="advancedSearchPanel" class="search-mode-panel" style="padding: 16px; display: none;">
                                        <div class="form-group" style="margin-bottom: 16px;">
                                            <label class="form-label">AI MODEL</label>
                                            <select id="modelSelectSearch" class="form-select" style="width: 100%;">
                                                <option value="mistral">Mistral (Local)</option>
                                                <option value="gemini">Gemini (Cloud)</option>
                                            </select>
                                        </div>

                                        <div class="form-group" style="margin-bottom: 16px;">
                                            <label class="form-label">SEARCH PROMPT</label>
                                            <div class="prompt-hint">Describe what you're looking for</div>
                                            <textarea id="aiSearchPrompt" class="prompt-area" style="min-height: 120px;" placeholder="Example: Looking for Senior Unreal Engine Developer positions with C++ experience, remote or hybrid, salary from $80k..."></textarea>
                                        </div>

                                        <!-- Stage 2 is now triggered manually via Ask Recruiter button -->
                                    </div>
                                </div>

                                <!-- Control Buttons -->
                                <div class="control-panel">
                                    <div class="panel-title">CONTROL</div>
                                    <div class="control-buttons">
                                        <button class="ctrl-btn" id="scanBtn" onclick="toggleScan()">
                                            <div class="ctrl-btn-leds">
                                                <div class="ctrl-btn-led green"></div>
                                                <div class="ctrl-btn-led orange"></div>
                                            </div>
                                            <div class="ctrl-btn-content">
                                                <span class="ctrl-btn-icon">▶</span>
                                                <span>SCAN</span>
                                            </div>
                                            <div class="ctrl-btn-corner tl"></div>
                                            <div class="ctrl-btn-corner tr"></div>
                                            <div class="ctrl-btn-corner bl"></div>
                                            <div class="ctrl-btn-corner br"></div>
                                        </button>

                                        <button class="ctrl-btn danger" onclick="resetAll()">
                                            <div class="ctrl-btn-leds">
                                                <div class="ctrl-btn-led green"></div>
                                                <div class="ctrl-btn-led orange"></div>
                                            </div>
                                            <div class="ctrl-btn-content">
                                                <span class="ctrl-btn-icon">↺</span>
                                                <span>RESET</span>
                                            </div>
                                            <div class="ctrl-btn-corner tl"></div>
                                            <div class="ctrl-btn-corner tr"></div>
                                            <div class="ctrl-btn-corner bl"></div>
                                            <div class="ctrl-btn-corner br"></div>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    </div>
                    <!-- END SEARCH TAB -->

                    <!-- RESUMES TAB -->
                    <div class="tab-panel" id="tabResume">
                        <div class="content-area">
                            <div class="main-grid">
                                <div class="left-column">
                                    <!-- Resume Disk Slot -->
                                    <div class="disk-slot-panel">
                                        <div class="panel-title">RESUME DRIVE</div>
                                        <div class="disk-slot">
                                            <div class="disk-opening" onclick="triggerFileInput()">
                                                <div class="disk-empty" id="diskEmpty">INSERT DISK</div>
                                                <div class="disk-cassette" id="diskCassette">
                                                    <span class="cassette-icon">💾</span>
                                                    <div class="cassette-label">
                                                        <div class="cassette-name" id="cassetteName">RESUME.DOC</div>
                                                        <div class="cassette-size" id="cassetteSize">0 KB</div>
                                                    </div>
                                                    <span class="cassette-check">✓</span>
                                                </div>
                                            </div>
                                            
                                            <!-- Resume Info Card -->
                                            <div class="resume-info-card" id="resumeInfoCard">
                                                <div class="resume-info-header">
                                                    <div class="resume-info-avatar">👤</div>
                                                    <div class="resume-info-name">
                                                        <h4 id="resumeInfoName">Candidate</h4>
                                                        <p id="resumeInfoLevel">LEVEL: — | EXP: —</p>
                                                    </div>
                                                </div>
                                                <div class="resume-info-stats">
                                                    <div class="resume-stat">
                                                        <div class="resume-stat-value" id="resumeInfoExp">—</div>
                                                        <div class="resume-stat-label">YEARS EXP</div>
                                                    </div>
                                                    <div class="resume-stat">
                                                        <div class="resume-stat-value" id="resumeInfoSkillCount">—</div>
                                                        <div class="resume-stat-label">SKILLS</div>
                                                    </div>
                                                </div>
                                                <div class="resume-skills" id="resumeInfoSkills"></div>
                                            </div>
                                            
                                            <div class="disk-leds">
                                                <div class="disk-led">
                                                    <div class="disk-led-dot" id="ledReady"></div>
                                                    <span class="disk-led-label green">READY</span>
                                                </div>
                                                <div class="disk-led">
                                                    <div class="disk-led-dot" id="ledBusy"></div>
                                                    <span class="disk-led-label orange">BUSY</span>
                                                </div>
                                            </div>
                                            
                                            <div class="disk-buttons">
                                                <button class="disk-btn insert" id="insertBtn" onclick="triggerFileInput()">↑ INSERT</button>
                                                <button class="disk-btn eject" id="ejectBtn" onclick="ejectDisk()" disabled>⏏ EJECT</button>
                                            </div>
                                            
                                            <div class="disk-hint" id="diskHint">INSERT RESUME DISK</div>
                                        </div>
                                        <input type="file" class="hidden-input" id="fileInput" accept=".txt,.pdf,.docx,.html,.htm" onchange="uploadResume(this)">
                                    </div>
                                </div>

                                <div class="right-column">
                                    <div class="control-panel">
                                        <div class="panel-title">RESUME LIBRARY</div>
                                        <div class="prompt-hint" style="margin-bottom: 12px;">Store multiple resumes, choose the active one for analysis, re-activate previously uploaded files without re-uploading.</div>
                                        <div id="resumeLibraryList" class="tracker-list" style="grid-template-columns: 1fr; gap: 12px;">
                                            <!-- Filled by JS -->
                                        </div>
                                        <button class="ctrl-btn danger" style="margin-top: 12px; width: 100%;" onclick="clearSavedResumes()">
                                            <div class="ctrl-btn-content">
                                                <span class="ctrl-btn-icon">🗑️</span>
                                                <span>CLEAR LIBRARY</span>
                                            </div>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- TRACKER TAB -->
                    <div class="tab-panel" id="tabTracker">
                        <div class="content-area">
                            <div style="max-width: 1400px; margin: 0 auto;">
                                <!-- Tracker Header -->
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                    <div style="display: flex; align-items: center; gap: 12px;">
                                        <div class="vacancy-header-dot" style="background: #4a9eff;"></div>
                                        <span class="vacancy-header-text">MY VACANCIES :: <span id="trackerCount">0</span> TRACKED</span>
                                    </div>
                                    <button class="ctrl-btn" onclick="openAddVacancyModal()" style="width: auto; padding: 8px 20px;">
                                        <div class="ctrl-btn-content">
                                            <span class="ctrl-btn-icon">+</span>
                                            <span>ADD CUSTOM</span>
                                        </div>
                                    </button>
                                </div>

                                <!-- Tracker Search -->
                                <div class="tracker-search">
                                    <input type="text" class="tracker-search-input" id="trackerSearchInput" placeholder="🔍 Search vacancies..." oninput="filterTrackerBySearch(this.value)">
                                </div>

                                <!-- Tracker Filters -->
                                <div style="display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; align-items: center;">
                                    <button class="tracker-filter active" onclick="filterTracker('all')" data-filter="all">
                                        ALL
                                        <span class="tracker-filter-badge" id="filterCountAll">0</span>
                                    </button>
                                    <button class="tracker-filter" onclick="filterTracker('wishlist')" data-filter="wishlist">
                                        📌 WISHLIST
                                        <span class="tracker-filter-badge" id="filterCountWishlist">0</span>
                                    </button>
                                    <button class="tracker-filter" onclick="filterTracker('applied')" data-filter="applied">
                                        ✉️ APPLIED
                                        <span class="tracker-filter-badge" id="filterCountApplied">0</span>
                                    </button>
                                    <button class="tracker-filter" onclick="filterTracker('interview')" data-filter="interview">
                                        🎯 INTERVIEW
                                        <span class="tracker-filter-badge" id="filterCountInterview">0</span>
                                    </button>
                                    <button class="tracker-filter" onclick="filterTracker('offer')" data-filter="offer">
                                        🎉 OFFER
                                        <span class="tracker-filter-badge" id="filterCountOffer">0</span>
                                    </button>
                                    <button class="tracker-filter" onclick="filterTracker('rejected')" data-filter="rejected">
                                        ❌ REJECTED
                                        <span class="tracker-filter-badge" id="filterCountRejected">0</span>
                                    </button>
                                </div>

                                <!-- Tracker List -->
                                <div class="tracker-list" id="trackerList">
                                    <!-- Populated by JavaScript -->
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- END TRACKER TAB -->

                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal-backdrop" id="modal" onclick="closeModal(event)">
        <div class="modal-window chrome-panel" onclick="event.stopPropagation()">
            <div class="chrome-panel-middle">
                <div class="chrome-panel-inner">
                    <div class="title-bar">
                        <div class="title-bar-content">
                            <div style="display: flex; align-items: center;">
                                <div class="led green"></div>
                                <span class="title-text" style="margin-left: 12px;" id="modalTitle">VACANCY DETAILS</span>
                            </div>
                            <button class="win-btn close" onclick="closeModal()">×</button>
                        </div>
                    </div>
                    
                    <div class="modal-tabs">
                        <button class="modal-tab active" onclick="switchTab('details')">📋 DETAILS</button>
                        <button class="modal-tab" onclick="switchTab('analysis')">🤖 ANALYSIS</button>
                        <button class="modal-tab" onclick="switchTab('resume')" id="resumeTab" style="display: none;">📄 RESUME+</button>
                    </div>
                    
                    <div class="modal-body">
                        <div id="tabDetails" class="tab-content active"></div>
                        <div id="tabAnalysis" class="tab-content"></div>
                        <div id="tabResume" class="tab-content">
                            <button class="ctrl-btn" id="improveBtn" style="margin-bottom: 16px;" onclick="improveResume()">
                                <div class="ctrl-btn-content">
                                    <span class="ctrl-btn-icon">✨</span>
                                    <span>GENERATE IMPROVED RESUME</span>
                                </div>
                            </button>
                            <div class="stream-output" id="streamImprove"></div>
                            <div id="resumeComparison"></div>
                        </div>
                    </div>
                    
                    <div class="modal-actions">
                        <button class="modal-btn" onclick="closeModal()">CLOSE</button>
                        <button class="modal-btn primary" id="applyBtn">APPLY NOW</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Custom Vacancy Modal -->
    <div class="modal-backdrop" id="addVacancyModal" onclick="closeAddVacancyModal(event)">
        <div class="modal-window chrome-panel" onclick="event.stopPropagation()" style="max-width: 800px;">
            <div class="chrome-panel-middle">
                <div class="chrome-panel-inner">
                    <div class="title-bar">
                        <div class="title-bar-content">
                            <div class="title-leds">
                                <div class="led green"></div>
                                <div class="led orange"></div>
                                <div class="led blue"></div>
                            </div>
                            <span class="title-text" style="margin-left: 12px;">+ ADD CUSTOM VACANCY</span>
                            <div class="window-controls" style="margin-left: auto;">
                                <button class="win-btn close" onclick="closeAddVacancyModal()">×</button>
                            </div>
                        </div>
                    </div>

                    <div class="modal-body" style="padding: 30px;">
                        <!-- Source Selection -->
                        <div class="form-group" style="margin-bottom: 20px;">
                            <label class="form-label">SOURCE PLATFORM</label>
                            <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-top: 8px;">
                                <label class="source-option">
                                    <input type="radio" name="vacancySource" value="linkedin" checked>
                                    <span class="source-btn">🔗 LinkedIn</span>
                                </label>
                                <label class="source-option">
                                    <input type="radio" name="vacancySource" value="headhunter">
                                    <span class="source-btn">🎯 HeadHunter</span>
                                </label>
                                <label class="source-option">
                                    <input type="radio" name="vacancySource" value="habr">
                                    <span class="source-btn">💼 Habr Career</span>
                                </label>
                                <label class="source-option">
                                    <input type="radio" name="vacancySource" value="custom">
                                    <span class="source-btn">📝 Other</span>
                                </label>
                            </div>
                        </div>

                        <!-- Job Title -->
                        <div class="form-group" style="margin-bottom: 20px;">
                            <label class="form-label">JOB TITLE</label>
                            <input type="text" id="customVacancyTitle" class="form-select" placeholder="e.g. Senior Unreal Engine Developer" style="width: 100%;">
                        </div>

                        <!-- Company -->
                        <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <div class="form-group">
                                <label class="form-label">COMPANY</label>
                                <input type="text" id="customVacancyCompany" class="form-select" placeholder="e.g. Epic Games" style="width: 100%;">
                            </div>
                            <div class="form-group">
                                <label class="form-label">LINK (optional)</label>
                                <input type="text" id="customVacancyLink" class="form-select" placeholder="https://..." style="width: 100%;">
                            </div>
                        </div>

                        <!-- Vacancy Text -->
                        <div class="form-group" style="margin-bottom: 20px;">
                            <label class="form-label">VACANCY DESCRIPTION</label>
                            <div class="prompt-hint">📋 Paste the full job description here</div>
                            <textarea class="prompt-area" id="customVacancyText" placeholder="Paste the job description here...

Requirements:
- 3+ years of experience with Unreal Engine
- Strong C++ skills
- ...

Responsibilities:
- Develop gameplay systems
- ...

Benefits:
- Competitive salary
- ..." style="min-height: 250px;"></textarea>
                        </div>

                        <!-- Options -->
                        <div class="form-group">
                            <label class="source-option" style="display: inline-flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="skipAnalysis">
                                <span style="color: #7dff7d; font-size: 14px;">⚡ Skip AI analysis (add directly)</span>
                            </label>
                        </div>
                    </div>

                    <div class="modal-actions">
                        <button class="modal-btn" onclick="closeAddVacancyModal()">CANCEL</button>
                        <button class="modal-btn primary" onclick="submitCustomVacancy()" id="submitVacancyBtn">
                            <span id="submitVacancyText">ADD VACANCY</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============== STATE ==============
        let isScanning = false;
        let ws = null;
        let vacancies = [];
        let currentVacancy = null;
        let resumeData = null;
        let savedResumes = [];
        let activeResumeId = null;
        const improvementTasks = {};

        // Tracker state
        let trackedVacancies = [];
        let currentTrackerFilter = 'all';
        let trackerSearchQuery = '';

        // Stage 2 progress tracking
        const stage2InProgress = new Set();

        // Search mode state
        let searchMode = 'basic'; // 'basic' or 'advanced'

        // Channels state
        let channels = [];

        // Confirmation modal state
        let confirmCallback = null;

        // ============== TOAST NOTIFICATIONS ==============
        function showToast(message, type = 'info', title = null) {
            const container = document.getElementById('toastContainer');
            if (!container) return;

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = {
                success: '✓',
                error: '✕',
                warning: '⚠',
                info: 'ℹ'
            };
            
            const titles = {
                success: title || 'Success',
                error: title || 'Error',
                warning: title || 'Warning',
                info: title || 'Info'
            };

            toast.innerHTML = `
                <span class="toast-icon">${icons[type] || icons.info}</span>
                <div class="toast-content">
                    <div class="toast-title">${titles[type]}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">×</button>
            `;

            container.appendChild(toast);

            // Auto remove after 5 seconds
            setTimeout(() => {
                toast.classList.add('hiding');
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }

        // ============== CONFIRMATION MODAL ==============
        function showConfirm(title, message, onConfirm) {
            const modal = document.getElementById('confirmModal');
            const titleEl = document.getElementById('confirmTitle');
            const messageEl = document.getElementById('confirmMessage');
            
            if (!modal || !titleEl || !messageEl) {
                // Fallback to native confirm
                if (confirm(`${title}\n\n${message}`)) {
                    onConfirm();
                }
                return;
            }

            titleEl.textContent = title;
            messageEl.textContent = message;
            confirmCallback = onConfirm;
            modal.classList.add('active');
        }

        function confirmOk() {
            const modal = document.getElementById('confirmModal');
            if (modal) modal.classList.remove('active');
            
            if (confirmCallback) {
                confirmCallback();
                confirmCallback = null;
            }
        }

        function confirmCancel() {
            const modal = document.getElementById('confirmModal');
            if (modal) modal.classList.remove('active');
            confirmCallback = null;
        }

        // Close modal on background click
        document.addEventListener('DOMContentLoaded', () => {
            const modal = document.getElementById('confirmModal');
            if (modal) {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        confirmCancel();
                    }
                });
            }
        });

        // ============== BUTTON LOADING STATE ==============
        function setButtonLoading(buttonId, loading) {
            const btn = typeof buttonId === 'string' ? document.getElementById(buttonId) : buttonId;
            if (!btn) return;
            
            if (loading) {
                btn.classList.add('btn-loading');
                btn.disabled = true;
            } else {
                btn.classList.remove('btn-loading');
                btn.disabled = false;
            }
        }

        // ============== INIT ==============
        document.addEventListener('DOMContentLoaded', () => {
            initVUMeter();
            updateClock();
            setInterval(updateClock, 1000);
            initSystemMonitor();
            loadSavedResumes();
            loadAvailableModels();
            restoreSession();
            loadVacancies();
            loadTrackedVacancies();
            loadParserSettings(); // Загружаем настройки парсеров
            
            // Update filter counts after loading
            setTimeout(() => {
                updateFilterCounts();
            }, 500);
            
            // Restore filter states
            const savedFilter = localStorage.getItem('trackerFilter');
            if (savedFilter) {
                currentTrackerFilter = savedFilter;
                const filterBtn = document.querySelector(`.tracker-filter[data-filter="${savedFilter}"]`);
                if (filterBtn) {
                    filterBtn.classList.add('active');
                    document.querySelectorAll('.tracker-filter').forEach(btn => {
                        if (btn !== filterBtn) btn.classList.remove('active');
                    });
                }
            }
            
            const savedSearchMode = localStorage.getItem('searchMode');
            if (savedSearchMode) {
                switchSearchMode(savedSearchMode);
            }
            
            const savedDaysBack = localStorage.getItem('selectedDaysBack');
            if (savedDaysBack) {
                setTimeRange(parseInt(savedDaysBack));
            }
            
            connectWS();
        });

        // ============== MAIN TAB NAVIGATION ==============
        function switchMainTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.main-nav-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.main-nav-tab[onclick="switchMainTab('${tabName}')"]`).classList.add('active');

            // Update tab panels
            document.querySelectorAll('.tab-panel').forEach(panel => {
                panel.classList.remove('active');
            });
            document.getElementById('tab' + tabName.charAt(0).toUpperCase() + tabName.slice(1)).classList.add('active');

            // Update home stats when switching to home
            if (tabName === 'home') {
                updateHomeStats();
            }
        }

        function updateHomeStats() {
            // Update basic stats
            const totalEl = document.getElementById('homeStatTotal');
            const trackedEl = document.getElementById('homeStatTracked');
            if (totalEl) totalEl.textContent = vacancies.length;
            if (trackedEl) trackedEl.textContent = trackedVacancies.length;

            // Calculate tracker status counts from the actual trackedVacancies array
            const wishlist = trackedVacancies.filter(v => v.tracker_status === 'wishlist').length;
            const applied = trackedVacancies.filter(v => v.tracker_status === 'applied').length;
            const interview = trackedVacancies.filter(v => v.tracker_status === 'interview').length;
            const offer = trackedVacancies.filter(v => v.tracker_status === 'offer').length;
            const rejected = trackedVacancies.filter(v => v.tracker_status === 'rejected').length;

            // Update the stats display elements with safety checks
            const wishlistEl = document.getElementById('homeStatWishlist');
            const appliedEl = document.getElementById('homeStatApplied');
            const interviewEl = document.getElementById('homeStatInterview');
            const offerEl = document.getElementById('homeStatOffer');
            const rejectedEl = document.getElementById('homeStatTrackerRejected');

            if (wishlistEl) wishlistEl.textContent = wishlist;
            if (appliedEl) appliedEl.textContent = applied;
            if (interviewEl) interviewEl.textContent = interview;
            if (offerEl) offerEl.textContent = offer;
            if (rejectedEl) rejectedEl.textContent = rejected;

            // Update tracker pipeline stats
            const totalTracked = trackedVacancies.length;
            // Use the values calculated earlier to avoid duplicate variable declarations
            const wishlistCount = trackedVacancies.filter(v => v.tracker_status === 'wishlist').length;
            const appliedCount = trackedVacancies.filter(v => v.tracker_status === 'applied').length;
            const interviewCount = trackedVacancies.filter(v => v.tracker_status === 'interview').length;
            const offerCount = trackedVacancies.filter(v => v.tracker_status === 'offer').length;
            const rejectedCount = trackedVacancies.filter(v => v.tracker_status === 'rejected').length;

            // Update tracker pipeline display
            const trackerTotalEl = document.getElementById('homeStatTrackerTotal');
            const successRate = totalTracked > 0 ? Math.round((offerCount / totalTracked) * 100) : 0;
            const successRateEl = document.getElementById('homeStatSuccessRate');

            if (trackerTotalEl) trackerTotalEl.textContent = totalTracked;
            if (successRateEl) successRateEl.textContent = successRate + '%';

            // Update pipeline progress bars
            updatePipelineProgress(wishlistCount, appliedCount, interviewCount, offerCount, rejectedCount, totalTracked);

            // Update chart statistics
            updateChartStats();
        }

        function updatePipelineProgress(wishlistCount, appliedCount, interviewCount, offerCount, rejectedCount, total) {
            if (total === 0) {
                // Set all to 0 if no tracked items
                ['pipelineWishlist', 'pipelineApplied', 'pipelineInterview', 'pipelineOffer', 'pipelineRejected'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.style.width = '0%';
                });
                return;
            }

            const wishlistPercent = (wishlistCount / total) * 100;
            const appliedPercent = (appliedCount / total) * 100;
            const interviewPercent = (interviewCount / total) * 100;
            const offerPercent = (offerCount / total) * 100;
            const rejectedPercent = (rejectedCount / total) * 100;

            const wishlistEl = document.getElementById('pipelineWishlist');
            const appliedEl = document.getElementById('pipelineApplied');
            const interviewEl = document.getElementById('pipelineInterview');
            const offerEl = document.getElementById('pipelineOffer');
            const rejectedEl = document.getElementById('pipelineRejected');

            if (wishlistEl) wishlistEl.style.width = wishlistPercent + '%';
            if (appliedEl) appliedEl.style.width = appliedPercent + '%';
            if (interviewEl) interviewEl.style.width = interviewPercent + '%';
            if (offerEl) offerEl.style.width = offerPercent + '%';
            if (rejectedEl) rejectedEl.style.width = rejectedPercent + '%';
        }

        function updateChartStats() {
            // Get base stats from LCD display with safety checks
            const lcdFoundEl = document.getElementById('lcdFound');
            const lcdSuitableEl = document.getElementById('lcdSuitable');
            const found = lcdFoundEl ? parseInt(lcdFoundEl.textContent) || 0 : 0;
            const suitable = lcdSuitableEl ? parseInt(lcdSuitableEl.textContent) || 0 : 0;

            // Calculate match rate: suitable / found
            const matchRate = found > 0 ? Math.round((suitable / found) * 100) : 0;
            const homeMatchRateEl = document.getElementById('homeMatchRate');
            if (homeMatchRateEl) homeMatchRateEl.textContent = matchRate + '%';

            // Get tracker stats from the home stat elements (which are now updated from actual data)
            const offer = parseInt(document.getElementById('homeStatOffer')?.textContent || '0');
            const applied = parseInt(document.getElementById('homeStatApplied')?.textContent || '0');
            const rejected = parseInt(document.getElementById('homeStatTrackerRejected')?.textContent || '0');
            const wishlist = parseInt(document.getElementById('homeStatWishlist')?.textContent || '0');
            const interview = parseInt(document.getElementById('homeStatInterview')?.textContent || '0');

            // Calculate success rate: offer / (applied + offer + rejected)
            const successRate = (applied + offer + rejected) > 0 ? Math.round((offer / (applied + offer + rejected)) * 100) : 0;
            const homeSuccessRateEl = document.getElementById('homeSuccessRate');
            if (homeSuccessRateEl) homeSuccessRateEl.textContent = successRate + '%';

            // Calculate apply rate: applied / wishlist
            const applyRate = wishlist > 0 ? Math.round((applied / wishlist) * 100) : 0;
            const homeApplyRateEl = document.getElementById('homeApplyRate');
            if (homeApplyRateEl) homeApplyRateEl.textContent = applyRate + '%';

            // Calculate interview rate: interview / applied
            const interviewRate = applied > 0 ? Math.round((interview / applied) * 100) : 0;
            const homeInterviewRateEl = document.getElementById('homeInterviewRate');
            if (homeInterviewRateEl) homeInterviewRateEl.textContent = interviewRate + '%';

            // Draw the chart with actual tracker data
            drawStatsChart(found, suitable, applied, interview, offer, rejected);
        }

        function drawStatsChart(found, suitable, applied, interview, offer, rejected) {
            const canvas = document.getElementById('statsChart');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = 95;

            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Draw outer circle
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
            ctx.strokeStyle = '#2a303a';
            ctx.lineWidth = 12;
            ctx.stroke();

            // Calculate values for chart
            const total = suitable + applied + interview + offer + rejected;
            if (total === 0) return;

            let startAngle = -Math.PI / 2;
            const colors = ['#7dff7d', '#4a9eff', '#f69029', '#b478ff', '#ff6060']; // green, blue, orange, purple, red
            const values = [suitable, applied, interview, offer, rejected];
            const labels = ['Suitable', 'Applied', 'Interview', 'Offer', 'Rejected'];

            // Draw each segment
            for (let i = 0; i < values.length; i++) {
                if (values[i] === 0) continue;

                const sliceAngle = (values[i] / total) * 2 * Math.PI;

                // Draw arc
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius, startAngle, startAngle + sliceAngle);
                ctx.strokeStyle = colors[i];
                ctx.lineWidth = 12;
                ctx.stroke();

                // Draw inner arc to create doughnut effect
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius - 6, startAngle + sliceAngle, startAngle, true);
                ctx.strokeStyle = '#1a1d25';
                ctx.lineWidth = 6;
                ctx.stroke();

                startAngle += sliceAngle;
            }

            // Draw center text
            ctx.fillStyle = '#7dff7d';
            ctx.font = 'bold 24px "Share Tech Mono", monospace';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(total.toString(), centerX, centerY);

            ctx.fillStyle = '#5a6a7a';
            ctx.font = '14px "Share Tech Mono", monospace';
            ctx.fillText('TOTAL', centerX, centerY + 25);
        }

        // ============== TRACKER ==============
        async function loadTrackedVacancies() {
            try {
                const response = await fetch('/api/tracker');
                const data = await response.json();
                trackedVacancies = data.vacancies || [];
                renderTrackerList();
                updateTrackerBadge();
            } catch (error) {
                console.error('Error loading tracker:', error);
            }
        }

        function isInTracker(vacancyId) {
            return trackedVacancies.some(v => v.id === vacancyId);
        }

        async function addToTracker(vacancyId) {
            const vacancy = vacancies.find(v => v.id === vacancyId);
            if (!vacancy || isInTracker(vacancyId)) return;

            const trackedVacancy = {
                ...vacancy,
                tracker_status: 'wishlist',
                tracked_at: new Date().toISOString()
            };

            try {
                const response = await fetch('/api/tracker/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ vacancy: trackedVacancy })
                });
                const result = await response.json();

                if (result.status === 'added') {
                    trackedVacancies.unshift(trackedVacancy);
                    renderTrackerList();
                    updateTrackerBadge();
                    updateFilterCounts();
                    updateHomeStats();
                    showToast('Vacancy added to tracker', 'success', 'Tracker Updated');

                    // Update button on search card
                    const btn = document.getElementById('trackBtn_' + vacancyId);
                    if (btn) {
                        btn.disabled = true;
                        btn.style.opacity = '0.5';
                        btn.style.cursor = 'not-allowed';
                        btn.innerHTML = '✓ TRACKED';
                    }
                }
            } catch (error) {
                console.error('Error adding to tracker:', error);
                showToast('Failed to add to tracker: ' + error.message, 'error', 'Add Error');
            }
        }

        async function updateTrackerStatus(vacancyId, newStatus) {
            try {
                const response = await fetch('/api/tracker/status', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ vacancy_id: vacancyId, status: newStatus })
                });
                const result = await response.json();

                if (result.status === 'updated') {
                    const idx = trackedVacancies.findIndex(v => v.id === vacancyId);
                    if (idx >= 0) {
                        trackedVacancies[idx].tracker_status = newStatus;
                        trackedVacancies[idx].status_updated_at = new Date().toISOString();
                        renderTrackerList();
                        updateFilterCounts();
                        updateHomeStats();
                        const statusNames = {
                            wishlist: 'Wishlist',
                            applied: 'Applied',
                            interview: 'Interview',
                            offer: 'Offer',
                            rejected: 'Rejected'
                        };
                        showToast(`Status updated to ${statusNames[newStatus] || newStatus}`, 'success', 'Status Updated');
                    }
                }
            } catch (error) {
                console.error('Error updating tracker status:', error);
                showToast('Failed to update status: ' + error.message, 'error', 'Update Error');
            }
        }

        async function removeFromTracker(vacancyId) {
            try {
                const response = await fetch('/api/tracker/remove', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ vacancy_id: vacancyId })
                });
                const result = await response.json();

                if (result.status === 'removed') {
                    // Remove from local array
                    trackedVacancies = trackedVacancies.filter(v => v.id !== vacancyId);

                    // Re-render the list
                    renderTrackerList();
                    updateTrackerBadge();
                    updateFilterCounts();
                    updateHomeStats();
                    showToast('Vacancy removed from tracker', 'success', 'Tracker Updated');

                    // Update button on search card
                    const btn = document.getElementById('trackBtn_' + vacancyId);
                    if (btn) {
                        btn.disabled = false;
                        btn.style.opacity = '1';
                        btn.style.cursor = 'pointer';
                        btn.innerHTML = '📌 TRACK';
                    }
                }
            } catch (error) {
                console.error('Error removing from tracker:', error);
                showToast('Failed to remove from tracker: ' + error.message, 'error', 'Remove Error');
            }
        }

        function updateTrackerBadge() {
            const badge = document.getElementById('trackerBadge');
            const count = trackedVacancies.length;
            if (count > 0) {
                badge.textContent = count;
                badge.style.display = 'inline-flex';
            } else {
                badge.style.display = 'none';
            }
            document.getElementById('trackerCount').textContent = count;
        }

        function filterTracker(filter) {
            currentTrackerFilter = filter;
            localStorage.setItem('trackerFilter', filter);
            document.querySelectorAll('.tracker-filter').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filter);
            });
            renderTrackerList();
            updateFilterCounts();
        }
        
        function filterTrackerBySearch(query) {
            trackerSearchQuery = query.toLowerCase().trim();
            renderTrackerList();
        }
        
        function updateFilterCounts() {
            const counts = {
                all: trackedVacancies.length,
                wishlist: trackedVacancies.filter(v => v.tracker_status === 'wishlist').length,
                applied: trackedVacancies.filter(v => v.tracker_status === 'applied').length,
                interview: trackedVacancies.filter(v => v.tracker_status === 'interview').length,
                offer: trackedVacancies.filter(v => v.tracker_status === 'offer').length,
                rejected: trackedVacancies.filter(v => v.tracker_status === 'rejected').length
            };
            
            Object.keys(counts).forEach(status => {
                const badge = document.getElementById(`filterCount${status.charAt(0).toUpperCase() + status.slice(1)}`);
                if (badge) {
                    badge.textContent = counts[status];
                    badge.style.display = counts[status] > 0 ? 'inline-flex' : 'none';
                }
            });
        }
        
        function getTimeInStatus(vacancy) {
            const dateToUse = vacancy.status_updated_at || vacancy.tracked_at;
            if (!dateToUse) return '';
            const statusDate = new Date(dateToUse);
            const now = new Date();
            const diffMs = now - statusDate;
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            
            if (diffHours < 1) return 'Just now';
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays === 1) return '1 day ago';
            if (diffDays < 7) return `${diffDays} days ago`;
            if (diffDays < 30) return `${Math.floor(diffDays / 7)}w ago`;
            return `${Math.floor(diffDays / 30)}mo ago`;
        }

        function getStatusColor(status) {
            const colors = {
                wishlist: '#4a9eff',
                applied: '#f69029',
                interview: '#b478ff',
                offer: '#7dff7d',
                rejected: '#ff6060'
            };
            return colors[status] || '#7dff7d';
        }
        
        function getStatusIcon(status) {
            const icons = {
                wishlist: '📌',
                applied: '✉️',
                interview: '🎯',
                offer: '🎉',
                rejected: '❌'
            };
            return icons[status] || '📌';
        }

        function renderTrackerList() {
          const container = document.getElementById('trackerList');
          if (!container) return;

          let filtered = trackedVacancies;
          
          // Apply status filter
          if (currentTrackerFilter !== 'all') {
            filtered = trackedVacancies.filter(v => v.tracker_status === currentTrackerFilter);
          }
          
          // Apply search filter
          if (trackerSearchQuery) {
            filtered = filtered.filter(v => {
              const searchText = `${v.title || ''} ${v.text || ''} ${v.channel || ''}`.toLowerCase();
              return searchText.includes(trackerSearchQuery);
            });
          }

          if (filtered.length === 0) {
            const emptyMessage = trackerSearchQuery 
              ? 'No vacancies match your search'
              : 'NO TRACKED VACANCIES';
            const emptyHint = trackerSearchQuery
              ? 'Try a different search term'
              : 'Add vacancies from Search or create custom ones';
            container.innerHTML = `
              <div class="tracker-empty">
                <div style="font-size:48px;margin-bottom:16px;">${trackerSearchQuery ? '🔍' : '📋'}</div>
                <div style="color:#7dff7d;font-size:18px;margin-bottom:8px;">${emptyMessage}</div>
                <div style="color:#5a6a7a;font-size:14px;">${emptyHint}</div>
              </div>`;
            return;
          }

          const sourceIcons = { telegram:'📱', linkedin:'🔗', headhunter:'🎯', habr:'💼', custom:'📝' };

          container.innerHTML = filtered.map(v => {
            const sourceIcon = sourceIcons[v.source] || '📱';

            // ── дата и preview из самой вакансии ──
            const dateStr = v.date
              ? new Date(v.date).toLocaleDateString('ru-RU')
              : '';

            const leadText = (v.text || '')
              .replace(/\s+/g,' ')
              .trim()
              .slice(0,220) + (v.text.length > 220 ? '…' : '');

            const firstLine = (v.text || '').split('\n').find(l => l.trim()) || '';
            const shortTitle = v.title || firstLine.substring(0,60) || 'Vacancy';

            // match-метр (если есть)
            const hasRecruiterScore = v.recruiter_analysis?.match_score > 0;
            const hasComparisonScore = v.comparison?.match_score > 0;
            const match = hasRecruiterScore ? v.recruiter_analysis.match_score
                        : hasComparisonScore ? v.comparison.match_score : null;
            const matchClass = match !== null ? (match >= 70 ? 'high' : match >= 50 ? 'medium' : 'low') : 'none';

            const matchMeterHTML = match !== null
              ? `<div class="match-meter" style="margin:12px 0;">
                   <div class="match-meter-header">
                     <div class="match-meter-label"><span class="match-meter-icon">📈</span><span>MATCH RATE</span></div>
                     <span class="match-meter-value ${matchClass}">${match}%</span>
                   </div>
                   <div class="match-meter-bar"><div class="match-meter-fill ${matchClass}" style="width:${match}%"></div></div>
                 </div>`
              : '';

            const currentStatus = v.tracker_status || 'wishlist';
            const statusIcon = getStatusIcon(currentStatus);
            const timeInStatus = getTimeInStatus(v);
            
            // Quick action buttons - show adjacent statuses for quick navigation
            const statusFlow = ['wishlist', 'applied', 'interview', 'offer'];
            const currentIndex = statusFlow.indexOf(currentStatus);
            const quickActions = [];
            
            if (currentIndex > 0) {
              quickActions.push(`<button class="quick-action-btn" onclick="updateTrackerStatus('${v.id}','${statusFlow[currentIndex - 1]}')" title="Move to ${statusFlow[currentIndex - 1]}">${getStatusIcon(statusFlow[currentIndex - 1])}</button>`);
            }
            if (currentIndex < statusFlow.length - 1 && currentStatus !== 'rejected') {
              quickActions.push(`<button class="quick-action-btn" onclick="updateTrackerStatus('${v.id}','${statusFlow[currentIndex + 1]}')" title="Move to ${statusFlow[currentIndex + 1]}">${getStatusIcon(statusFlow[currentIndex + 1])}</button>`);
            }
            if (currentStatus !== 'rejected') {
              quickActions.push(`<button class="quick-action-btn" onclick="updateTrackerStatus('${v.id}','rejected')" title="Mark as rejected" style="color:#ff6060;">❌</button>`);
            }

            return `
              <div class="vacancy-card" id="tracker_${v.id}">
                <div class="vacancy-card-header">
                  <div class="vacancy-card-id">
                    <div class="vacancy-card-led ${currentStatus==='offer'?'active':currentStatus==='rejected'?'archived':'pending'}"></div>
                    <span class="vacancy-card-code">${sourceIcon}</span>
                  </div>
                  <span class="vacancy-card-source" title="${escapeHtml(v.channel||'Unknown')}">${escapeHtml((v.channel||'Unknown').substring(0, 20))}</span>
                  <span class="tracker-card-date">${dateStr}</span>
                  <span class="status-badge ${currentStatus}">${statusIcon} ${currentStatus.toUpperCase()}</span>
                </div>
                <div class="tracker-card-body">
                  <div class="tracker-card-title">${escapeHtml(shortTitle)}</div>
                  <div class="tracker-card-text">${escapeHtml(leadText)}</div>
                  ${matchMeterHTML}
                </div>
                <div class="tracker-card-actions">
                  <select onchange="updateTrackerStatus('${v.id}',this.value)" class="tracker-status-select">
                    <option value="wishlist" ${currentStatus==='wishlist'?'selected':''}>📌 Wishlist</option>
                    <option value="applied"  ${currentStatus==='applied' ?'selected':''}>✉️ Applied</option>
                    <option value="interview"${currentStatus==='interview'?'selected':''}>🎯 Interview</option>
                    <option value="offer"    ${currentStatus==='offer'   ?'selected':''}>🎉 Offer</option>
                    <option value="rejected" ${currentStatus==='rejected'?'selected':''}>❌ Rejected</option>
                  </select>
                  <button class="vacancy-btn details" onclick="showTrackedDetails('${v.id}')">📋 DETAILS</button>
                  <button class="vacancy-btn" onclick="event.stopPropagation();removeFromTracker('${v.id}')" style="padding:8px 12px;color:#ff6060;" title="Remove from tracker">🗑️</button>
                </div>
                <div class="vacancy-card-footer"></div>
              </div>
            `;
          }).join('');
        }

        function showTrackedDetails(id) {
            try {
                // Find vacancy in tracker array
                currentVacancy = trackedVacancies.find(v => v.id === id);
                if (!currentVacancy) {
                    console.error('Vacancy not found:', id);
                    return;
                }

                // Show modal with full details
                const modalTitle = document.getElementById('modalTitle');
                const tabDetails = document.getElementById('tabDetails');
                const tabAnalysis = document.getElementById('tabAnalysis');
                const resumeTab = document.getElementById('resumeTab');
                const modal = document.getElementById('modal');

                if (!modalTitle || !tabDetails || !tabAnalysis || !modal) {
                    console.error('Modal elements not found');
                    return;
                }

                modalTitle.textContent = 'VACANCY :: ' + (currentVacancy.channel || '').substring(0, 20);

                // Details tab - use async parser with API, fallback to client-side
                parseVacancyAsync(currentVacancy.text, 'tabDetails');

                // Analysis tab
                let analysisContent = '';
                if (currentVacancy.analysis) {
                    analysisContent += `
                        <div style="padding: 16px; background: linear-gradient(180deg, #1a2a2a, #0a1a1a); border: 2px solid #3a5050; border-radius: 8px; margin-bottom: 16px;">
                            <div style="font-size: var(--font-size-sm); color: #7dff7d; letter-spacing: 1px; margin-bottom: 12px;">🔍 STAGE 1: FILTER ANALYSIS</div>
                            <div style="font-size: var(--font-size-sm); color: #c0c8d0; line-height: 1.6;">${formatAnalysis(currentVacancy.analysis)}</div>
                        </div>
                    `;
                }

                if (currentVacancy.recruiter_analysis && currentVacancy.recruiter_analysis.match_score > 0) {
                    analysisContent += `
                        <div style="margin-bottom: 16px;">
                            <div style="font-size: var(--font-size-sm); color: #4a9eff; letter-spacing: 1px; margin-bottom: 12px; padding: 0 16px;">🎯 STAGE 2: RECRUITER ANALYSIS</div>
                            ${renderRecruiterAnalysis(currentVacancy.recruiter_analysis)}
                        </div>
                    `;
                }

                tabAnalysis.innerHTML = analysisContent || '<div style="color: #5a6070;">No analysis available</div>';

                // Resume+ tab
                if (resumeTab) {
                    resumeTab.style.display = resumeData ? 'block' : 'none';
                }

                const streamImprove = document.getElementById('streamImprove');
                if (streamImprove) streamImprove.classList.remove('active');

                const resumeComparison = document.getElementById('resumeComparison');
                const improveBtn = document.getElementById('improveBtn');

                if (currentVacancy.comparison && currentVacancy.comparison.improved_resume) {
                    if (resumeComparison) resumeComparison.innerHTML = renderComparisonResult(currentVacancy.comparison);
                    if (improveBtn) improveBtn.style.display = 'none';
                } else {
                    if (resumeComparison) resumeComparison.innerHTML = '';
                    if (improveBtn) {
                        improveBtn.style.display = 'block';
                        improveBtn.innerHTML = `
                            <div class="ctrl-btn-content">
                                <span class="ctrl-btn-icon">✨</span>
                                <span>GENERATE IMPROVED RESUME</span>
                            </div>
                        `;
                    }
                }

                const applyBtn = document.getElementById('applyBtn');
                if (applyBtn && currentVacancy.link) {
                    applyBtn.onclick = () => window.open(currentVacancy.link, '_blank');
                }

                switchTab('details');
                modal.classList.add('active');
            } catch (error) {
                console.error('Error showing tracked details:', error);
            }
        }
        
        // ============== SEARCH MODE ==============
        let selectedDaysBack = 7;

        function switchSearchMode(mode) {
            searchMode = mode;
            localStorage.setItem('searchMode', mode);

            // Update tabs
            document.getElementById('searchModeBasic').classList.toggle('active', mode === 'basic');
            document.getElementById('searchModeAdvanced').classList.toggle('active', mode === 'advanced');

            // Update panels
            document.getElementById('basicSearchPanel').classList.toggle('active', mode === 'basic');
            document.getElementById('basicSearchPanel').style.display = mode === 'basic' ? 'block' : 'none';
            document.getElementById('advancedSearchPanel').classList.toggle('active', mode === 'advanced');
            document.getElementById('advancedSearchPanel').style.display = mode === 'advanced' ? 'block' : 'none';
        }

        function setTimeRange(days) {
            selectedDaysBack = days;
            localStorage.setItem('selectedDaysBack', days.toString());
            document.getElementById('daysBackBasic').value = days;

            // Update button states
            document.querySelectorAll('.time-range-btn').forEach(btn => {
                btn.classList.toggle('active', parseInt(btn.dataset.days) === days);
            });
        }

        function addChannelBasic() {
            const input = document.getElementById('newChannelBasic');
            const channelName = input.value.trim().replace('@', '');

            if (!channelName) return;

            if (channels.includes(channelName)) {
                input.value = '';
                return;
            }

            channels.push(channelName);
            input.value = '';
            updateChannelTagsBasic();
            saveChannelsToServer();
        }

        function removeChannelBasic(channelName) {
            channels = channels.filter(ch => ch !== channelName);
            updateChannelTagsBasic();
            saveChannelsToServer();
        }

        async function saveChannelsToServer() {
            try {
                const response = await fetch('/api/settings');
                const settings = await response.json();
                settings.channels = channels;

                await fetch('/api/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });
            } catch (error) {
                console.error('Error saving channels:', error);
            }
        }

        function updateChannelTagsBasic() {
            const container = document.getElementById('channelTagsBasic');
            if (!container) return;

            if (channels.length === 0) {
                container.innerHTML = '<span style="color: #5a6a7a; font-size: 12px;">No channels added. Add Telegram channels to monitor.</span>';
                return;
            }

            container.innerHTML = channels.map(ch => `
                <span class="channel-tag">
                    <span>📱 ${escapeHtml(ch)}</span>
                    <span class="channel-tag-remove" onclick="removeChannelBasic('${escapeHtml(ch)}')" title="Remove">×</span>
                </span>
            `).join('');
        }

        // toggleStage2Setting removed - Stage 2 is now triggered manually via Ask Recruiter button

        function updateClock() {
            const now = new Date();
            document.getElementById('lcdTime').textContent = now.toLocaleTimeString('en-US', { hour12: false });
        }
        
        function initVUMeter() {
            const container = document.getElementById('vuSegments');
            for (let i = 0; i < 24; i++) {
                const seg = document.createElement('div');
                seg.className = 'vu-segment';
                if (i < 14) seg.classList.add('green');
                else if (i < 20) seg.classList.add('yellow');
                else seg.classList.add('red');
                container.appendChild(seg);
            }
        }
        
        function updateVUMeter(percent) {
            percent = Math.max(0, Math.min(100, percent || 0));
            
            const segments = document.querySelectorAll('.vu-segment');
            const needle = document.getElementById('vuNeedle');
            const container = document.getElementById('vuSegments');
            const valueEl = document.getElementById('vuValue');
            
            if (!segments.length) return;
            
            const totalSegments = segments.length;
            const activeCount = Math.floor((percent / 100) * totalSegments);
            
            // 1. Обновляем сегменты
            for (let i = 0; i < totalSegments; i++) {
                if (i < activeCount) {
                    segments[i].classList.add('active');
                } else {
                    segments[i].classList.remove('active');
                }
            }
            
            // 2. Needle позиция = процент активных сегментов (как в Figma React)
            // left: calc(${(activeSegments / segments) * 100}% - 1px)
            if (needle) {
                const needlePercent = (activeCount / totalSegments) * 100;
                needle.style.left = `calc(${needlePercent}% - 1px)`;
            }
            
            // 3. Обновляем текст
            if (valueEl) {
                valueEl.textContent = Math.round(percent) + '%';
            }
        }
        
        // ============== SYSTEM MONITOR (VU Meter) ==============
        let monitorInterval = null;
        let hasRealGPU = false;
        let fallbackMode = false;
        let cpuSamples = [];
        
        async function initSystemMonitor() {
            try {
                // Пробуем получить данные от backend
                const res = await fetch('/api/system-monitor');
                const data = await res.json();
                
                if (data.has_gpu && data.gpu) {
                    // Есть NVIDIA GPU с pynvml
                    hasRealGPU = true;
                    document.getElementById('vuDeviceName').textContent = data.gpu.short_name || 'GPU';
                    document.getElementById('vuDevice').classList.add('gpu');
                    document.querySelector('.vu-device-icon').textContent = '🎮';
                    console.log('Real GPU monitoring:', data.gpu.name);
                } else {
                    // CPU режим
                    hasRealGPU = false;
                    document.getElementById('vuDeviceName').textContent = 'CPU';
                    document.getElementById('vuDevice').classList.remove('gpu');
                    document.querySelector('.vu-device-icon').textContent = '💻';
                    console.log('CPU monitoring mode');
                }
                
                // Запускаем мониторинг через backend
                await fetch('/api/monitor/start', { method: 'POST' });
                fallbackMode = false;
                
            } catch (e) {
                console.log('Backend monitor unavailable, using fallback:', e);
                fallbackMode = true;
                detectGPUFallback();
                startFallbackMonitor();
            }
        }
        
        function detectGPUFallback() {
            // Фоллбэк через WebGL если backend недоступен
            try {
                const canvas = document.createElement('canvas');
                const gl = canvas.getContext('webgl');
                if (gl) {
                    const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
                    if (debugInfo) {
                        const renderer = gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL);
                        const gpuKeywords = ['nvidia', 'geforce', 'rtx', 'gtx', 'radeon', 'rx '];
                        if (gpuKeywords.some(kw => renderer.toLowerCase().includes(kw))) {
                            let shortName = 'GPU';
                            const match = renderer.match(/\b(RTX|GTX)\s*(\d{3,4})/i);
                            if (match) shortName = match[1].toUpperCase() + ' ' + match[2];
                            document.getElementById('vuDeviceName').textContent = shortName;
                            document.getElementById('vuDevice').classList.add('gpu');
                            document.querySelector('.vu-device-icon').textContent = '🎮';
                            return;
                        }
                    }
                }
            } catch (e) {}
            document.getElementById('vuDeviceName').textContent = 'CPU';
        }
        
        function startFallbackMonitor() {
            // Фоллбэк измерение через requestAnimationFrame
            let lastTime = performance.now();
            
            function measure() {
                const now = performance.now();
                const delta = now - lastTime;
                lastTime = now;
                
                const load = Math.min(100, Math.max(0, ((delta - 16.67) / 16.67) * 100 + 15));
                cpuSamples.push(load);
                if (cpuSamples.length > 20) cpuSamples.shift();
                
                const avg = cpuSamples.reduce((a, b) => a + b, 0) / cpuSamples.length;
                updateVUMeter(avg);
                
                if (fallbackMode) requestAnimationFrame(measure);
            }
            requestAnimationFrame(measure);
        }
        
        function handleSystemMonitor(data) {
            // Обработка данных мониторинга от WebSocket
            if (data.has_gpu && data.gpu && typeof data.gpu.utilization === 'number') {
                updateVUMeter(data.gpu.utilization);
                
                // Обновляем tooltip с деталями
                const tooltip = `${data.gpu.name}\nGPU: ${data.gpu.utilization}%\nVRAM: ${data.gpu.memory_used_mb}/${data.gpu.memory_total_mb} MB\nTemp: ${data.gpu.temperature}°C`;
                document.querySelector('.vu-panel').title = tooltip;
            } else if (data.cpu && typeof data.cpu.utilization === 'number') {
                updateVUMeter(data.cpu.utilization);
                
                const tooltip = `CPU: ${data.cpu.utilization}%\nCores: ${data.cpu.cores}\nRAM: ${data.cpu.memory_used_gb}/${data.cpu.memory_total_gb} GB`;
                document.querySelector('.vu-panel').title = tooltip;
            }
        }
        
        // ============== MODELS ==============
        async function loadAvailableModels() {
            try {
                const res = await fetch('/api/models');
                const data = await res.json();

                if (data.models && data.models.length > 0) {
                    const modelSelectSearch = document.getElementById('modelSelectSearch');
                    if (!modelSelectSearch) return; // Safely handle missing element

                    const currentValue = modelSelectSearch.value;

                    // Очищаем текущие опции
                    modelSelectSearch.innerHTML = '';

                    // Добавляем найденные модели
                    data.models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model.name;
                        option.textContent = model.display_name;
                        modelSelectSearch.appendChild(option);
                    });

                    // Восстанавливаем выбранную модель если она есть
                    if (currentValue && Array.from(modelSelectSearch.options).some(opt => opt.value === currentValue)) {
                        modelSelectSearch.value = currentValue;
                    }

                    console.log(`✓ Loaded ${data.models.length} models:`, data.models.map(m => m.name));
                }
            } catch (e) {
                console.warn('Failed to load models:', e);
                // Оставляем дефолтные опции если не удалось загрузить
            }
        }

        // ============== SESSION ==============
        async function restoreSession() {
            try {
                const res = await fetch('/api/session');
                const data = await res.json();
                
                if (data.settings) {
                    const modelSelectSearch = document.getElementById('modelSelectSearch');
                    if (modelSelectSearch) modelSelectSearch.value = data.settings.model_type || 'mistral';
                    const daysBackBasic = document.getElementById('daysBackBasic');
                    if (daysBackBasic) daysBackBasic.value = data.settings.days_back || 7;
                    const aiSearchPrompt = document.getElementById('aiSearchPrompt');
                    if (data.settings.custom_prompt && aiSearchPrompt) {
                        aiSearchPrompt.value = data.settings.custom_prompt;
                    }
                    if (data.settings.channels && data.settings.channels.length > 0) {
                        channels = data.settings.channels;
                        updateChannelTagsBasic();
                    }

                    // Stage 2 toggle removed - now triggered manually via Ask Recruiter button
                }
                
                if (data.resume_data) {
                    resumeData = data.resume_data;
                    showResumeInserted(data.resume_data, false); // без анимации при восстановлении
                    ensureResumeStoredFromSession();
                }
                
                if (data.stats) {
                    updateStatsDisplay(data.stats);
                }

                if (data.is_monitoring) {
                    isScanning = true;
                    updateScanButton(true);
                }

                // Load tracked vacancies to sync with UI
                await loadTrackedVacancies();
                updateHomeStats();
            } catch (e) {
                console.error('Session restore error:', e);
            }
        }
        
        async function loadVacancies() {
            try {
                const res = await fetch('/api/vacancies');
                const data = await res.json();
                if (data.vacancies && data.vacancies.length) {
                    data.vacancies.forEach(v => addVacancy(v, false));
                    updateHomeStats();
                }
            } catch (e) {
                console.error('Load vacancies error:', e);
            }
        }
        
        // ============== WEBSOCKET ==============
        let wsReconnectAttempts = 0;
        const MAX_RECONNECT_ATTEMPTS = 10;
        let wsReconnectTimeout = null;

        function connectWS() {
            if (ws && ws.readyState === WebSocket.OPEN) return;

            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}/ws`);
            
            ws.onopen = () => {
                console.log('WS connected');
                wsReconnectAttempts = 0;
                if (wsReconnectAttempts === 0) {
                    // Only show toast on initial connection or after reconnection
                    showToast('WebSocket connected', 'success', 'Connection');
                }
            };
            
            ws.onmessage = (e) => handleWSMessage(JSON.parse(e.data));
            
            ws.onclose = () => {
                console.log('WS disconnected');
                if (wsReconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                    scheduleReconnect();
                } else {
                    showToast('WebSocket connection failed. Please refresh the page.', 'error', 'Connection Lost');
                }
            };
            
            ws.onerror = (e) => {
                console.error('WS error:', e);
                if (wsReconnectAttempts === 0) {
                    showToast('WebSocket connection error. Reconnecting...', 'warning', 'Connection');
                }
                scheduleReconnect();
            };
            
            function scheduleReconnect() {
                if (wsReconnectTimeout) return;
                wsReconnectAttempts++;
                const delay = Math.min(1000 * Math.pow(2, wsReconnectAttempts), 30000); // Exponential backoff, max 30s
                wsReconnectTimeout = setTimeout(() => {
                    wsReconnectTimeout = null;
                    connectWS();
                }, delay);
            }
        }

        function ensureWSConnected() {
            return new Promise((resolve) => {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    resolve(true);
                    return;
                }

                console.log('WS not connected, reconnecting...');

                // Create new WebSocket
                ws = new WebSocket(`ws://${window.location.host}/ws`);

                ws.onopen = () => {
                    console.log('WS connected');
                    resolve(true);
                };
                ws.onmessage = (e) => handleWSMessage(JSON.parse(e.data));
                ws.onclose = () => {
                    console.log('WS disconnected, will reconnect in 2s');
                    setTimeout(connectWS, 2000);
                };
                ws.onerror = (e) => {
                    console.error('WS error:', e);
                    resolve(false);
                };

                // Timeout after 5 seconds
                setTimeout(() => resolve(false), 5000);
            });
        }
        
        function handleWSMessage(data) {
            // Логируем ВСЕ сообщения для отладки
            console.log('[WS] Message received:', data.type, data);

            // Отладка resume_improved
            if (data.type === 'resume_improved') {
                console.log('!!! RESUME_IMPROVED RECEIVED !!!', data);
            }

            switch (data.type) {
                case 'vacancy':
                    addVacancy(data.vacancy);
                    break;
                case 'vacancy_update':
                    handleVacancyUpdate(data);
                    break;
                case 'status':
                    document.getElementById('lcdMessage').textContent = data.message;
                    break;
                case 'stats':
                    updateStatsDisplay(data.stats);
                    break;
                case 'progress':
                    document.getElementById('progressBar').style.width = data.percent + '%';
                    break;
                case 'stream':
                    handleStream(data);
                    break;
                case 'resume_improved':
                    handleResumeImproved(data);
                    break;
                case 'system_monitor':
                    handleSystemMonitor(data);
                    break;
                case 'stage2_started':
                    handleStage2Started(data);
                    break;
                case 'stage2_progress':
                    handleStage2Progress(data);
                    break;
                case 'stage2_completed':
                    handleStage2Completed(data);
                    break;
                case 'stage2_error':
                    handleStage2Error(data);
                    break;
            }
        }
        
        function updateStatsDisplay(stats) {
            if (stats.found !== undefined) {
                const el = document.getElementById('lcdFound');
                if (el) el.textContent = String(stats.found).padStart(3, '0');
            }
            if (stats.processed !== undefined) {
                const el = document.getElementById('lcdProcessed');
                if (el) el.textContent = String(stats.processed).padStart(3, '0');
            }
            if (stats.rejected !== undefined) {
                const el = document.getElementById('lcdRejected');
                if (el) el.textContent = String(stats.rejected).padStart(3, '0');
            }
            if (stats.suitable !== undefined) {
                const el = document.getElementById('lcdSuitable');
                if (el) el.textContent = String(stats.suitable).padStart(3, '0');
            }

            // Update chart as well
            updateChartStats();
        }

        // ============== RESUME ==============
        function triggerFileInput() {
            document.getElementById('fileInput').click();
        }
        
        async function uploadResume(input) {
            if (!input.files || !input.files[0]) return;

            const file = input.files[0];
            showResumeLoading(file.name, file.size);

            try {
                // Получаем расширение файла
                const fileName = file.name;
                const fileExt = fileName.substring(fileName.lastIndexOf('.')).toLowerCase();

                // Читаем файл как ArrayBuffer для бинарных форматов (PDF, DOCX)
                const fileData = await file.arrayBuffer();
                const model = document.getElementById('modelSelectSearch').value;

                const res = await fetch(`/api/upload-resume?model_type=${model}&file_ext=${fileExt}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/octet-stream'},
                    body: fileData
                });

                const result = await res.json();

                if (result.error) {
                    showToast(result.error, 'error', 'Upload Failed');
                    hideResumeLoading();
                } else {
                    resumeData = result;
                    // Сохраняем оригинальный текст, если он есть в ответе
                    if (result.raw_text) {
                        resumeData.raw_text = result.raw_text;
                    }
                    showResumeInserted(result, true);
                    rememberResume(result, fileName, file.size || fileData.byteLength || 0);
                    showToast('Resume uploaded and processed successfully', 'success', 'Resume Uploaded');
                }
            } catch (e) {
                console.error('Upload failed:', e);
                showToast('Upload failed: ' + e.message, 'error', 'Upload Error');
                hideResumeLoading();
            }
        }
        
        function showResumeLoading(fileName, fileSize) {
            document.getElementById('ledBusy').classList.add('active', 'orange');
            document.getElementById('diskEmpty').style.display = 'none';
            document.getElementById('diskHint').textContent = 'ANALYZING...';
            
            // Показываем кассету в процессе вставки
            const cassette = document.getElementById('diskCassette');
            document.getElementById('cassetteName').textContent = fileName || 'RESUME.DOC';
            document.getElementById('cassetteSize').textContent = formatFileSize(fileSize || 0);
            cassette.classList.remove('inserted', 'ejecting');
            cassette.classList.add('inserting');
        }
        
        function hideResumeLoading() {
            document.getElementById('ledBusy').classList.remove('active', 'orange');
            document.getElementById('diskEmpty').style.display = 'flex';
            document.getElementById('diskHint').textContent = 'INSERT RESUME DISK';
            
            const cassette = document.getElementById('diskCassette');
            cassette.classList.remove('inserting', 'inserted');
        }
        
        function showResumeInserted(data, animate = true, fileName = null, fileSize = null) {
            document.getElementById('diskEmpty').style.display = 'none';
            document.getElementById('ledReady').classList.add('active', 'green');
            document.getElementById('ledBusy').classList.remove('active', 'orange');
            document.getElementById('insertBtn').disabled = true;
            document.getElementById('ejectBtn').disabled = false;
            document.getElementById('diskHint').textContent = 'DISK LOADED OK';

            // Update cassette name and size
            const name = fileName || data.name || 'RESUME.DOC';
            const size = fileSize || (data.raw_text ? data.raw_text.length : 0);
            document.getElementById('cassetteName').textContent = name.substring(0, 20);
            document.getElementById('cassetteSize').textContent = formatFileSize(size);

            // Кассета
            const cassette = document.getElementById('diskCassette');
            cassette.classList.remove('inserting', 'ejecting');
            if (animate) {
                // Ждем окончания анимации inserting
                setTimeout(() => {
                    cassette.classList.add('inserted');
                }, 800);
            } else {
                cassette.classList.add('inserted');
            }

            // Информация о резюме
            const infoCard = document.getElementById('resumeInfoCard');
            infoCard.classList.add('active');

            // Заполняем данные
            document.getElementById('resumeInfoName').textContent = data.name || 'Candidate';
            document.getElementById('resumeInfoLevel').textContent =
                `LEVEL: ${(data.level || '—').toUpperCase()} | EXP: ${data.experience_years || '—'}y`;
            document.getElementById('resumeInfoExp').textContent = data.experience_years || '—';

            const skills = data.key_skills || [];
            document.getElementById('resumeInfoSkillCount').textContent = skills.length;

            const skillsContainer = document.getElementById('resumeInfoSkills');
            skillsContainer.innerHTML = '';
            skills.slice(0, 6).forEach(skill => {
                const tag = document.createElement('span');
                tag.className = 'resume-skill-tag';
                tag.textContent = skill;
                skillsContainer.appendChild(tag);
            });

        }

        
        function ejectDisk() {
            const cassette = document.getElementById('diskCassette');
            cassette.classList.remove('inserted', 'inserting');
            cassette.classList.add('ejecting');

            // После анимации сбрасываем
            setTimeout(() => {
                resumeData = null;
                cassette.classList.remove('ejecting');
                document.getElementById('diskEmpty').style.display = 'flex';
                document.getElementById('ledReady').classList.remove('active', 'green');
                document.getElementById('insertBtn').disabled = false;
                document.getElementById('ejectBtn').disabled = true;
                document.getElementById('resumeInfoCard').classList.remove('active');
                document.getElementById('diskHint').textContent = 'INSERT RESUME DISK';
            }, 600);
        }
        
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        // ============== RESUME LIBRARY ==============
        function persistSavedResumes() {
            try {
                localStorage.setItem('savedResumes', JSON.stringify({
                    items: savedResumes,
                    active: activeResumeId
                }));
            } catch (e) {
                console.warn('persistSavedResumes failed', e);
            }
        }

        function loadSavedResumes() {
            try {
                const raw = localStorage.getItem('savedResumes');
                if (raw) {
                    const parsed = JSON.parse(raw);
                    savedResumes = parsed.items || [];
                    activeResumeId = parsed.active || null;
                }
            } catch (e) {
                savedResumes = [];
                activeResumeId = null;
            }
            renderSavedResumes();
            if (activeResumeId) {
                setActiveResume(activeResumeId, true).catch(err => console.warn('setActiveResume failed', err));
            }
        }

        function renderSavedResumes() {
            const container = document.getElementById('resumeLibraryList');
            if (!container) return;

            if (!savedResumes.length) {
                container.innerHTML = `
                    <div class="tracker-empty">
                        <div style="font-size: 36px; margin-bottom: 8px;">💾</div>
                        <div style="color: #7dff7d;">No resumes stored. Upload one to start.</div>
                    </div>`;
                return;
            }

            container.innerHTML = savedResumes.map(r => {
                const skills = (r.data?.key_skills || []).length;
                const exp = r.data?.experience_years || '—';
                const uploaded = r.uploaded_at ? formatDate(r.uploaded_at) : '';
                const isActive = r.id === activeResumeId;

                return `
                    <div class="tracker-card ${isActive ? 'active' : ''}">
                        <div class="tracker-card-header">
                            <div class="tracker-card-source">
                                <span>💾</span>
                                <span>${escapeHtml(r.name || 'Resume')}</span>
                            </div>
                            <span class="tracker-card-status ${isActive ? 'offer' : 'wishlist'}">${isActive ? 'ACTIVE' : 'READY'}</span>
                        </div>
                        <div class="tracker-card-body">
                            <div class="tracker-card-title">${escapeHtml(r.data?.level || 'unknown').toUpperCase()}</div>
                            <div class="tracker-card-company">EXP: ${exp}y • SKILLS: ${skills}</div>
                            <div style="font-size: 12px; color: #5a6a7a;">Stored ${uploaded}</div>
                        </div>
                        <div class="tracker-card-actions">
                            <button class="vacancy-btn details" onclick="setActiveResume('${r.id}')">📌 ${isActive ? 'ACTIVE' : 'ACTIVATE'}</button>
                            <button class="vacancy-btn" onclick="removeSavedResume('${r.id}')" style="padding: 8px 12px; color: #ff6060;">🗑️</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function rememberResume(data, fileName = 'RESUME', fileSize = 0) {
            if (!data) return;
            const entry = {
                id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()),
                name: fileName,
                size: fileSize,
                uploaded_at: new Date().toISOString(),
                data
            };
            savedResumes = [entry, ...savedResumes];
            activeResumeId = entry.id;
            persistSavedResumes();
            renderSavedResumes();
        }

        async function setActiveResume(resumeId, syncServer = true) {
            const entry = savedResumes.find(r => r.id === resumeId);
            if (!entry) return;

            resumeData = entry.data;
            activeResumeId = entry.id;
            showResumeInserted(entry.data, false, entry.name, entry.size);
            persistSavedResumes();
            renderSavedResumes();

            if (syncServer) {
                await syncActiveResumeWithServer(entry.data);
            }
        }

        async function syncActiveResumeWithServer(data) {
            try {
                await fetch('/api/resume/set', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({resume_data: data})
                });
            } catch (e) {
                console.error('Failed to sync resume with server', e);
            }
        }

        function removeSavedResume(resumeId) {
            const wasActive = activeResumeId === resumeId;
            savedResumes = savedResumes.filter(r => r.id !== resumeId);

            if (wasActive) {
                activeResumeId = savedResumes[0]?.id || null;
                if (activeResumeId) {
                    setActiveResume(activeResumeId);
                } else {
                    // Trigger eject animation when deleting active resume with no replacement
                    resumeData = null;
                    const cassette = document.getElementById('diskCassette');
                    if (cassette && cassette.classList.contains('inserted')) {
                        cassette.classList.remove('inserted', 'inserting');
                        cassette.classList.add('ejecting');

                        setTimeout(() => {
                            cassette.classList.remove('ejecting');
                            const diskEmpty = document.getElementById('diskEmpty');
                            if (diskEmpty) diskEmpty.style.display = 'flex';
                            const ledReady = document.getElementById('ledReady');
                            if (ledReady) ledReady.classList.remove('active', 'green');
                            const insertBtn = document.getElementById('insertBtn');
                            if (insertBtn) insertBtn.disabled = false;
                            const ejectBtn = document.getElementById('ejectBtn');
                            if (ejectBtn) ejectBtn.disabled = true;
                            const resumeInfoCard = document.getElementById('resumeInfoCard');
                            if (resumeInfoCard) resumeInfoCard.classList.remove('active');
                            const diskHint = document.getElementById('diskHint');
                            if (diskHint) diskHint.textContent = 'INSERT RESUME DISK';
                        }, 600);
                    } else {

                    }
                }
            }
            persistSavedResumes();
            renderSavedResumes();
        }

        function clearSavedResumes() {
            showConfirm(
                'Clear Resume Library',
                'This will remove all saved resumes from the library. This action cannot be undone.',
                () => {
                    savedResumes = [];
                    activeResumeId = null;
                    resumeData = null;

                    const cassette = document.getElementById('diskCassette');
                    if (cassette && cassette.classList.contains('inserted')) {
                        // Trigger eject animation
                        cassette.classList.remove('inserted', 'inserting');
                        cassette.classList.add('ejecting');

                        setTimeout(() => {
                            cassette.classList.remove('ejecting');
                            const diskEmpty = document.getElementById('diskEmpty');
                            if (diskEmpty) diskEmpty.style.display = 'flex';
                            const ledReady = document.getElementById('ledReady');
                            if (ledReady) ledReady.classList.remove('active', 'green');
                            const insertBtn = document.getElementById('insertBtn');
                            if (insertBtn) insertBtn.disabled = false;
                            const ejectBtn = document.getElementById('ejectBtn');
                            if (ejectBtn) ejectBtn.disabled = true;
                            const resumeInfoCard = document.getElementById('resumeInfoCard');
                            if (resumeInfoCard) resumeInfoCard.classList.remove('active');
                            const diskHint = document.getElementById('diskHint');
                            if (diskHint) diskHint.textContent = 'INSERT RESUME DISK';
                        }, 600);
                    } else {
                        const insertBtn = document.getElementById('insertBtn');
                        if (insertBtn) insertBtn.disabled = false;
                        const ejectBtn = document.getElementById('ejectBtn');
                        if (ejectBtn) ejectBtn.disabled = true;
                        const diskHint = document.getElementById('diskHint');
                        if (diskHint) diskHint.textContent = 'INSERT RESUME DISK';
                        const diskEmpty = document.getElementById('diskEmpty');
                        if (diskEmpty) diskEmpty.style.display = 'flex';
                    }

                    persistSavedResumes();
                    renderSavedResumes();
                    showToast('Resume library cleared', 'success', 'Library Cleared');
                }
            );
        }

        function ensureResumeStoredFromSession() {
            if (!resumeData) return;
            const already = savedResumes.some(r => r.data && r.data.raw_text === resumeData.raw_text);
            if (already) return;
            if (savedResumes.length === 0) {
                rememberResume(resumeData, resumeData.name || 'Session resume', (resumeData.raw_text || '').length);
            }
        }
        
        // ============== SCANNING ==============
        async function toggleScan() {
            if (!isScanning) {
                await saveSettings();
                const res = await fetch('/api/start', {method: 'POST'});
                const data = await res.json();
                
                if (data.status === 'started' || data.status === 'already_running') {
                    isScanning = true;
                    updateScanButton(true);
                    connectWS();
                }
            } else {
                await fetch('/api/stop', {method: 'POST'});
                isScanning = false;
                updateScanButton(false);
            }
        }
        
        function updateScanButton(scanning) {
            const btn = document.getElementById('scanBtn');
            const dots = document.getElementById('scanningDots');
            const progress = document.getElementById('progressContainer');
            
            if (scanning) {
                btn.classList.add('active');
                btn.querySelector('.ctrl-btn-content span:last-child').textContent = 'STOP';
                btn.querySelector('.ctrl-btn-icon').textContent = '⏸';
                document.getElementById('lcdStatus').textContent = 'SCANNING';
                dots.style.display = 'flex';
                progress.style.display = 'block';
            } else {
                btn.classList.remove('active');
                btn.querySelector('.ctrl-btn-content span:last-child').textContent = 'SCAN';
                btn.querySelector('.ctrl-btn-icon').textContent = '▶';
                document.getElementById('lcdStatus').textContent = 'IDLE';
                dots.style.display = 'none';
                progress.style.display = 'none';
                updateVUMeter(0);
            }
        }
        
        async function saveSettings() {
            let settings;

            if (searchMode === 'basic') {
                // Basic mode: use simple filters, no AI prompt
                const daysBackBasic = document.getElementById('daysBackBasic');
                const keywordFilter = document.getElementById('keywordFilter');

                const modelSelectSearch = document.getElementById('modelSelectSearch');
                settings = {
                    model_type: modelSelectSearch?.value || 'mistral',
                    days_back: parseInt(daysBackBasic?.value || 7),
                    custom_prompt: '',  // No AI filter in basic mode
                    keyword_filter: keywordFilter?.value || '',
                    channels: channels,
                    search_mode: 'basic'
                };
            } else {
                // Advanced (AI) mode
                const modelSelectSearch = document.getElementById('modelSelectSearch');
                const aiSearchPrompt = document.getElementById('aiSearchPrompt');
                const daysBackBasic = document.getElementById('daysBackBasic');

                settings = {
                    model_type: modelSelectSearch?.value || 'mistral',
                    days_back: parseInt(daysBackBasic?.value || 7),
                    custom_prompt: aiSearchPrompt?.value || '',
                    channels: channels,
                    search_mode: 'advanced'
                };
            }

            // Добавляем настройки парсеров
            const parserSettings = getParserSettings();
            Object.assign(settings, parserSettings);

            await fetch('/api/settings', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(settings)
            });
        }

        // ============== PARSER SETTINGS ==============
        function getParserSettings() {
            return {
                enable_telegram: document.getElementById('enableTelegram')?.checked !== false, // По умолчанию true
                enable_headhunter: document.getElementById('enableHeadHunter')?.checked || false,
                hh_search_query: document.getElementById('hhSearchQuery')?.value || '',
                hh_area: parseInt(document.getElementById('hhArea')?.value || 1),
                hh_max_pages: parseInt(document.getElementById('hhMaxPages')?.value || 5),
                enable_linkedin: document.getElementById('enableLinkedIn')?.checked || false,
                linkedin_search_query: document.getElementById('linkedInSearchQuery')?.value || '',
                linkedin_location: document.getElementById('linkedInLocation')?.value || '',
                linkedin_email: document.getElementById('linkedInEmail')?.value || '',
                linkedin_password: document.getElementById('linkedInPassword')?.value || ''
            };
        }

        async function saveParserSettings() {
            const parserSettings = getParserSettings();
            
            // Обновляем видимость настроек
            const telegramSettings = document.getElementById('telegramSettings');
            const hhSettings = document.getElementById('headHunterSettings');
            const linkedInSettings = document.getElementById('linkedInSettings');
            
            if (telegramSettings) {
                telegramSettings.style.display = parserSettings.enable_telegram ? 'block' : 'none';
            }
            if (hhSettings) {
                hhSettings.style.display = parserSettings.enable_headhunter ? 'block' : 'none';
            }
            if (linkedInSettings) {
                linkedInSettings.style.display = parserSettings.enable_linkedin ? 'block' : 'none';
            }

            // Сохраняем настройки на сервер
            try {
                // Получаем текущие настройки
                const response = await fetch('/api/settings');
                const currentSettings = await response.json();
                
                // Объединяем с настройками парсеров
                const updatedSettings = {
                    ...currentSettings,
                    ...parserSettings
                };
                
                console.log('Saving parser settings:', parserSettings);
                
                // Отправляем обновленные настройки
                const saveResponse = await fetch('/api/settings', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(updatedSettings)
                });
                
                if (saveResponse.ok) {
                    const result = await saveResponse.json();
                    console.log('Parser settings saved successfully:', result);
                } else {
                    console.error('Failed to save parser settings:', saveResponse.status, await saveResponse.text());
                }
            } catch (error) {
                console.error('Error saving parser settings:', error);
            }
        }

        async function loadParserSettings() {
            try {
                const response = await fetch('/api/settings');
                const settings = await response.json();

                // Telegram
                const enableTelegram = document.getElementById('enableTelegram');
                if (enableTelegram) {
                    enableTelegram.checked = settings.enable_telegram !== false; // По умолчанию true
                }
                saveParserSettings(); // Обновляем видимость

                // HeadHunter
                const enableHH = document.getElementById('enableHeadHunter');
                const hhQuery = document.getElementById('hhSearchQuery');
                const hhArea = document.getElementById('hhArea');
                const hhMaxPages = document.getElementById('hhMaxPages');
                const hhSettings = document.getElementById('headHunterSettings');

                if (enableHH) {
                    enableHH.checked = settings.enable_headhunter || false;
                    if (hhSettings) {
                        hhSettings.style.display = enableHH.checked ? 'block' : 'none';
                    }
                }
                if (hhQuery) hhQuery.value = settings.hh_search_query || '';
                if (hhArea) hhArea.value = settings.hh_area || 1;
                if (hhMaxPages) hhMaxPages.value = settings.hh_max_pages || 5;

                // LinkedIn
                const enableLI = document.getElementById('enableLinkedIn');
                const liQuery = document.getElementById('linkedInSearchQuery');
                const liLocation = document.getElementById('linkedInLocation');
                const liEmail = document.getElementById('linkedInEmail');
                const liPassword = document.getElementById('linkedInPassword');
                const liSettings = document.getElementById('linkedInSettings');

                if (enableLI) {
                    enableLI.checked = settings.enable_linkedin || false;
                    if (liSettings) {
                        liSettings.style.display = enableLI.checked ? 'block' : 'none';
                    }
                }
                if (liQuery) liQuery.value = settings.linkedin_search_query || '';
                if (liLocation) liLocation.value = settings.linkedin_location || '';
                if (liEmail) liEmail.value = settings.linkedin_email || '';
                if (liPassword) liPassword.value = settings.linkedin_password || '';

            } catch (error) {
                console.error('Error loading parser settings:', error);
            }
        }
        
        // ============== ADD CUSTOM VACANCY MODAL ==============
        function openAddVacancyModal() {
            // Reset form
            document.getElementById('customVacancyTitle').value = '';
            document.getElementById('customVacancyCompany').value = '';
            document.getElementById('customVacancyLink').value = '';
            document.getElementById('customVacancyText').value = '';
            document.getElementById('skipAnalysis').checked = false;
            document.querySelector('input[name="vacancySource"][value="linkedin"]').checked = true;
            document.getElementById('submitVacancyText').textContent = 'ADD VACANCY';
            document.getElementById('submitVacancyBtn').disabled = false;

            document.getElementById('addVacancyModal').classList.add('active');
        }

        function closeAddVacancyModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('addVacancyModal').classList.remove('active');
        }

        async function submitCustomVacancy() {
            const text = document.getElementById('customVacancyText').value.trim();
            const title = document.getElementById('customVacancyTitle').value.trim();
            const company = document.getElementById('customVacancyCompany').value.trim();
            const link = document.getElementById('customVacancyLink').value.trim();
            const skipAnalysis = document.getElementById('skipAnalysis').checked;
            const source = document.querySelector('input[name="vacancySource"]:checked').value;

            if (text.length < 30) {
                showToast('Please enter at least 30 characters of vacancy description', 'warning', 'Validation Error');
                return;
            }

            const btn = document.getElementById('submitVacancyBtn');
            const btnText = document.getElementById('submitVacancyText');
            btn.disabled = true;
            btnText.textContent = skipAnalysis ? 'ADDING...' : 'ANALYZING...';

            try {
                const response = await fetch('/api/vacancies/custom', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: text,
                        title: title || null,
                        company: company || null,
                        link: link || null,
                        source: source,
                        skip_analysis: skipAnalysis
                    })
                });

                const result = await response.json();

                if (result.status === 'added') {
                    btnText.textContent = '✓ ADDED!';
                    showToast('Vacancy added successfully', 'success', 'Vacancy Added');

                    // Server already added to tracker, just update local state
                    if (result.vacancy) {
                        trackedVacancies.unshift(result.vacancy);
                        renderTrackerList();
                        updateTrackerBadge();
                    }

                    setTimeout(() => {
                        closeAddVacancyModal();
                        // Switch to tracker tab to show the new vacancy
                        switchMainTab('tracker');
                    }, 1000);
                } else if (result.status === 'error') {
                    showToast(result.error || 'Unknown error', 'error', 'Add Vacancy Error');
                    btn.disabled = false;
                    btnText.textContent = 'ADD VACANCY';
                }
            } catch (error) {
                console.error('Error adding vacancy:', error);
                showToast('Failed to add vacancy: ' + error.message, 'error', 'Add Vacancy Error');
                btn.disabled = false;
                btnText.textContent = 'ADD VACANCY';
            }
        }

        async function resetAll() {
            showConfirm(
                'Reset All Data',
                'This will clear all vacancies, statistics, and reset the scanner. This action cannot be undone.',
                async () => {
                    await fetch('/api/reset', {method: 'POST'});
                    vacancies = [];
                    document.getElementById('vacanciesGrid').innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">📡</div>
                            <div class="empty-state-text">AWAITING SIGNAL...<br>PRESS SCAN TO BEGIN</div>
                        </div>
                    `;
                    document.getElementById('vacancyCount').textContent = '0';
                    updateStatsDisplay({found: 0, processed: 0, rejected: 0, suitable: 0});
                    showToast('All data has been reset', 'success', 'Reset Complete');
                }
            );
        }
        
        // ============== VACANCIES ==============
        function addVacancy(vacancy, animate = true) {
            const grid = document.getElementById('vacanciesGrid');
            const empty = grid.querySelector('.empty-state');
            if (empty) empty.remove();

            if (vacancies.find(v => v.id === vacancy.id)) return;
            vacancies.unshift(vacancy);

            const card = createVacancyCard(vacancy);
            grid.insertBefore(card, grid.firstChild);

            document.getElementById('vacancyCount').textContent = vacancies.length;

            // Update numbering for all cards in the grid
            updateCardNumbering();

            // Stage 2 запускается асинхронно в бэкенде
            // Результат придёт через vacancy_update
        }

        function updateCardNumbering() {
            const grid = document.getElementById('vacanciesGrid');
            const cards = grid.querySelectorAll('.vacancy-card');

            cards.forEach((card, index) => {
                const position = (index + 1).toString().padStart(3, '0'); // Order: 1, 2, 3... from top to bottom
                const codeElement = card.querySelector('.vacancy-card-code');
                if (codeElement) {
                    codeElement.innerHTML = codeElement.innerHTML.replace(/#\?\?\?|#\d{3}/, '#' + position);
                }
            });
        }

        function handleVacancyUpdate(data) {
            // Обновление вакансии (например, когда Stage 2 завершился)
            const vacancy = vacancies.find(v => v.id === data.vacancy_id);
            if (!vacancy) {
                console.warn('Vacancy not found for update:', data.vacancy_id);
                return;
            }

            // Обновляем данные вакансии
            if (data.recruiter_analysis) {
                vacancy.recruiter_analysis = data.recruiter_analysis;
                vacancy.comparison = { match_score: data.recruiter_analysis.match_score };

                // Обновляем карточку (match score)
                updateVacancyCard(vacancy);

                // Если модал открыт для этой вакансии - обновляем вкладку ANALYSIS
                if (currentVacancy && currentVacancy.id === vacancy.id) {
                    currentVacancy.recruiter_analysis = data.recruiter_analysis;
                    currentVacancy.comparison = vacancy.comparison;
                    refreshAnalysisTab();
                }

                console.log('✅ Vacancy updated with Stage 2 analysis:', data.vacancy_id);
            }
        }

        function updateVacancyCard(v) {
            // Обновляем карточку с новым match score
            const card = document.getElementById('card_' + v.id);
            if (!card) return;

            const match = v.comparison?.match_score;
            if (match !== undefined && match !== null) {
                const matchClass = match >= 90 ? 'high' : match >= 70 ? 'medium' : 'low';
                const meterEl = card.querySelector('.match-meter');
                if (meterEl) {
                    meterEl.classList.remove('pending');
                    meterEl.innerHTML = `
                        <div class="match-meter-header">
                            <div class="match-meter-label">
                                <span class="match-meter-icon">📈</span>
                                <span>MATCH RATE</span>
                            </div>
                            <span class="match-meter-value ${matchClass}">${match}%</span>
                        </div>
                        <div class="match-meter-bar">
                            <div class="match-meter-fill ${matchClass}" style="width: ${match}%;"></div>
                        </div>
                    `;
                }
            }
        }

        function refreshAnalysisTab() {
            // Обновляем вкладку ANALYSIS для текущей открытой вакансии
            if (!currentVacancy) return;

            let analysisContent = '';

            // Этап 1: Результат фильтрации
            if (currentVacancy.analysis) {
                analysisContent += `
                    <div style="padding: 16px; background: linear-gradient(180deg, #1a2a2a, #0a1a1a); border: 2px solid #3a5050; border-radius: 8px; margin-bottom: 16px;">
                        <div style="font-size: var(--font-size-sm); color: #7dff7d; letter-spacing: 1px; margin-bottom: 12px;">🔍 STAGE 1: FILTER ANALYSIS</div>
                        <div style="font-size: var(--font-size-sm); color: #c0c8d0; line-height: 1.6;">${formatAnalysis(currentVacancy.analysis)}</div>
                    </div>
                `;
            }

            // Этап 2: Анализ рекрутера
            const isStage2InProgressRefresh = stage2InProgress.has(currentVacancy.id);

            if (currentVacancy.recruiter_analysis && currentVacancy.recruiter_analysis.match_score > 0) {
                // Stage 2 completed - show results
                analysisContent += `
                    <div style="margin-bottom: 16px;">
                        <div style="font-size: var(--font-size-sm); color: #4a9eff; letter-spacing: 1px; margin-bottom: 12px; padding: 0 16px;">🎯 STAGE 2: RECRUITER ANALYSIS</div>
                        ${renderRecruiterAnalysis(currentVacancy.recruiter_analysis)}
                    </div>
                `;
            } else if (isStage2InProgressRefresh) {
                // Stage 2 in progress - show loading
                analysisContent += `
                    <div style="padding: 16px; background: linear-gradient(180deg, #1a2a3a, #0a1a2a); border: 2px solid #3a4a6a; border-radius: 8px; margin-bottom: 16px;">
                        <div style="font-size: var(--font-size-sm); color: #4a9eff; letter-spacing: 1px; margin-bottom: 12px;">🎯 STAGE 2: RECRUITER ANALYSIS</div>
                        <div style="display: flex; align-items: center; gap: 12px; color: #6a8aaa;">
                            <div class="stage2-spinner"></div>
                            <span>Analyzing your resume match...</span>
                        </div>
                    </div>
                `;
            } else {
                // Stage 2 not started - show button
                const hasResumeRefresh = !!resumeData;
                analysisContent += `
                    <div style="padding: 16px; background: linear-gradient(180deg, #1a2a3a, #0a1a2a); border: 2px solid #3a4a6a; border-radius: 8px; margin-bottom: 16px;">
                        <div style="font-size: var(--font-size-sm); color: #4a9eff; letter-spacing: 1px; margin-bottom: 12px;">🎯 STAGE 2: RECRUITER ANALYSIS</div>
                        <button class="ctrl-btn stage2-btn" id="askRecruiterBtn" onclick="startStage2Analysis()" ${!hasResumeRefresh ? 'disabled' : ''} style="width: 100%; ${!hasResumeRefresh ? 'opacity: 0.5; cursor: not-allowed;' : ''}">
                            <div class="ctrl-btn-content">
                                <span class="ctrl-btn-icon">🎯</span>
                                <span>ASK RECRUITER</span>
                            </div>
                        </button>
                        ${!hasResumeRefresh ? '<div style="color: #ff6b6b; font-size: 12px; margin-top: 8px; text-align: center;">⚠️ Upload resume first to enable analysis</div>' : ''}
                    </div>
                `;
            }

            document.getElementById('tabAnalysis').innerHTML = analysisContent || '<div style="color: #5a6070;">No analysis available</div>';
        }

        function createVacancyCard(v) {
            const card = document.createElement('div');
            card.className = 'vacancy-card';
            card.id = 'card_' + v.id;

            const dateStr = v.date
              ? new Date(v.date).toLocaleDateString('ru-RU')
              : '';

            const leadText = (v.text || '')
              .replace(/\s+/g, ' ')
              .trim()
              .slice(0, 320) + (v.text.length > 320 ? '…' : '');

            // Extract short title from first l2ne of text
            const firstLine = (v.text || '').split('\n').find(l => l.trim()) || '';
            const shortTitle = v.title || firstLine.substring(0, 60) || 'Vacancy';

            // Match Rate - show from recruiter_analysis (Stage 2) or comparison (Stage 3)
            const hasRecruiterScore = v.recruiter_analysis && typeof v.recruiter_analysis.match_score === 'number' && v.recruiter_analysis.match_score > 0;
            const hasComparisonScore = v.comparison && typeof v.comparison.match_score === 'number' && v.comparison.match_score > 0;
            const match = hasRecruiterScore ? v.recruiter_analysis.match_score : (hasComparisonScore ? v.comparison.match_score : null);
            const matchClass = match !== null ? (match >= 70 ? 'high' : match >= 50 ? 'medium' : 'low') : 'none';

            // Match meter HTML
            const matchMeterHTML = '';
            //     <div class="match-meter">
            //         <div class="match-meter-header">
            //             <div class="match-meter-label">
            //                 <span class="match-meter-icon">📈</span>
            //                 <span>MATCH RATE</span>
            //             </div>
            //             <span class="match-meter-value ${matchClass}">${match}%</span>
            //         </div>
            //         <div class="match-meter-bar">
            //             <div class="match-meter-fill ${matchClass}" style="width: ${match}%;"></div>
            //         </div>
            //     </div>
            // ` : `
            //     <div class="match-meter pending">
            //         <div class="match-meter-header">
            //             <div class="match-meter-label">
            //                 <span class="match-meter-icon">📈</span>
            //                 <span>MATCH RATE</span>
            //             </div>
            //             <span class="match-meter-value none">—</span>
            //         </div>
            //     </div>
            // `;

            // Source icon mapping
            const sourceIcons = {
                'telegram': '📱',
                'linkedin': '🔗',
                'headhunter': '🎯',
                'habr': '💼',
                'custom': '📝'
            };
            const sourceIcon = sourceIcons[v.source] || '📱';

            card.innerHTML = `
                <div class="vacancy-card-header">
                    <div class="vacancy-card-id">
                        <div class="vacancy-card-led active"></div>
                        <span class="vacancy-card-code">${sourceIcon} #???</span>
                    </div>
                    <div class="vacancy-card-date">${dateStr}</div>
                    <span class="vacancy-card-source" title="${escapeHtml(v.channel || 'Unknown')}">${escapeHtml(v.channel || 'Unknown')}</span>
                    <span class="vacancy-card-status">ACTIVE</span>
                </div>
                <div class="vacancy-card-body">
                    <div class="vacancy-card-title">${escapeHtml(shortTitle)}</div>
                    <div class="vacancy-card-lead">${escapeHtml(leadText)}</div>
                    ${matchMeterHTML}
                    <div class="vacancy-card-actions">
                        <button class="vacancy-btn details" onclick="showDetails('${v.id}')" title="View details">📋 DETAILS</button>
                        <button class="vacancy-btn track" onclick="addToTracker('${v.id}')" id="trackBtn_${v.id}" ${isInTracker(v.id) ? 'disabled style="opacity:0.5; cursor:not-allowed;"' : ''} title="${isInTracker(v.id) ? 'Already tracked' : 'Add to tracker'}">
                            ${isInTracker(v.id) ? '✓ TRACKED' : '📌 TRACK'}
                        </button>
                        ${v.link ? `<a class="vacancy-btn open" href="${v.link}" target="_blank" title="Open original">🔗</a>` : `<button class="vacancy-btn open" disabled title="No link">🔗</button>`}
                    </div>
                </div>
                <div class="vacancy-card-footer"></div>
            `;

            return card;
        }
        
        function extractInfo(v) {
            const text = v.text || '';
            const info = {position: '', conditions: '', summary: ''};

            const lines = text.split('\n').filter(l => l.trim());
            if (lines.length) info.position = lines[0].substring(0, 50);

            const cond = text.match(/(от\s*\d+|до\s*\d+|\d+\s*(руб|usd|eur|k)|удаленн|офис|гибрид)/gi);
            if (cond) info.conditions = cond.slice(0, 2).join(' • ');

            // Extract first meaningful sentences for summary (up to 2 sentences)
            if (text.length > 0) {
                // Split by sentence endings and clean up
                const sentences = text.split(/[.!?]+/).map(s => s.trim()).filter(s => s.length > 10);
                if (sentences.length > 0) {
                    // Take first 1-2 sentences up to ~150 chars
                    let summary = sentences[0];
                    if (sentences.length > 1 && summary.length < 100) {
                        summary += ' ' + sentences[1];
                    }
                    info.summary = summary.substring(0, 150) + (summary.length > 150 ? '...' : '');
                }
            }

            return info;
        }
        
        // ============== MODAL ==============
        function showDetails(id) {
            currentVacancy = vacancies.find(v => v.id === id);
            if (!currentVacancy) return;

            // Mark card as viewed
            const card = document.getElementById('card_' + id);
            if (card) {
                card.classList.add('viewed');
            }

            document.getElementById('modalTitle').textContent = 'VACANCY :: ' + (currentVacancy.channel || '').substring(0, 20);
            
            // Use async parser with API, fallback to client-side
            parseVacancyAsync(currentVacancy.text, 'tabDetails');
            
            // Формируем контент для вкладки ANALYSIS
            let analysisContent = '';

            // Этап 1: Результат фильтрации
            if (currentVacancy.analysis) {
                analysisContent += `
                    <div style="padding: 16px; background: linear-gradient(180deg, #1a2a2a, #0a1a1a); border: 2px solid #3a5050; border-radius: 8px; margin-bottom: 16px;">
                        <div style="font-size: var(--font-size-sm); color: #7dff7d; letter-spacing: 1px; margin-bottom: 12px;">🔍 STAGE 1: FILTER ANALYSIS</div>
                        <div style="font-size: var(--font-size-sm); color: #c0c8d0; line-height: 1.6;">${formatAnalysis(currentVacancy.analysis)}</div>
                    </div>
                `;
            }

            // Этап 2: Анализ рекрутера
            const isStage2InProgress = stage2InProgress.has(currentVacancy.id);

            if (currentVacancy.recruiter_analysis && currentVacancy.recruiter_analysis.match_score > 0) {
                // Stage 2 completed - show results
                analysisContent += `
                    <div style="margin-bottom: 16px;">
                        <div style="font-size: var(--font-size-sm); color: #4a9eff; letter-spacing: 1px; margin-bottom: 12px; padding: 0 16px;">🎯 STAGE 2: RECRUITER ANALYSIS</div>
                        ${renderRecruiterAnalysis(currentVacancy.recruiter_analysis)}
                    </div>
                `;
            } else if (isStage2InProgress) {
                // Stage 2 in progress - show loading
                analysisContent += `
                    <div style="padding: 16px; background: linear-gradient(180deg, #1a2a3a, #0a1a2a); border: 2px solid #3a4a6a; border-radius: 8px; margin-bottom: 16px;">
                        <div style="font-size: var(--font-size-sm); color: #4a9eff; letter-spacing: 1px; margin-bottom: 12px;">🎯 STAGE 2: RECRUITER ANALYSIS</div>
                        <div style="display: flex; align-items: center; gap: 12px; color: #6a8aaa;">
                            <div class="stage2-spinner"></div>
                            <span>Analyzing your resume match...</span>
                        </div>
                    </div>
                `;
            } else {
                // Stage 2 not started - show button
                const hasResume = !!resumeData;
                analysisContent += `
                    <div style="padding: 16px; background: linear-gradient(180deg, #1a2a3a, #0a1a2a); border: 2px solid #3a4a6a; border-radius: 8px; margin-bottom: 16px;">
                        <div style="font-size: var(--font-size-sm); color: #4a9eff; letter-spacing: 1px; margin-bottom: 12px;">🎯 STAGE 2: RECRUITER ANALYSIS</div>
                        <button class="ctrl-btn stage2-btn" id="askRecruiterBtn" onclick="startStage2Analysis()" ${!hasResume ? 'disabled' : ''} style="width: 100%; ${!hasResume ? 'opacity: 0.5; cursor: not-allowed;' : ''}">
                            <div class="ctrl-btn-content">
                                <span class="ctrl-btn-icon">🎯</span>
                                <span>ASK RECRUITER</span>
                            </div>
                        </button>
                        ${!hasResume ? '<div style="color: #ff6b6b; font-size: 12px; margin-top: 8px; text-align: center;">⚠️ Upload resume first to enable analysis</div>' : ''}
                    </div>
                `;
            }

            document.getElementById('tabAnalysis').innerHTML = analysisContent || '<div style="color: #5a6070;">No analysis available</div>';
            
            // Resume+ tab visibility: requires active resume
            document.getElementById('resumeTab').style.display = resumeData ? 'block' : 'none';
            document.getElementById('streamImprove').classList.remove('active');

            // Вкладка RESUME+ показывает ТОЛЬКО Stage 3 (улучшенное резюме)
            // Анализ рекрутера (Stage 2) показывается на вкладке ANALYSIS
            const hasStage2Completed = currentVacancy.recruiter_analysis && currentVacancy.recruiter_analysis.match_score > 0;
            const canGenerateResume = hasStage2Completed && resumeData;

            if (currentVacancy.comparison && currentVacancy.comparison.improved_resume) {
                // Stage 3 completed - показываем улучшенное резюме
                document.getElementById('resumeComparison').innerHTML = renderComparisonResult(currentVacancy.comparison);
                document.getElementById('improveBtn').style.display = 'none';
            } else {
                // Stage 3 не выполнен - показываем кнопку генерации (условия: Stage 2 завершен + резюме)
                document.getElementById('resumeComparison').innerHTML = '';
                document.getElementById('improveBtn').style.display = 'block';

                if (canGenerateResume) {
                    document.getElementById('improveBtn').disabled = false;
                    document.getElementById('improveBtn').style.opacity = '1';
                    document.getElementById('improveBtn').style.cursor = 'pointer';
                    document.getElementById('improveBtn').innerHTML = `
                        <div class="ctrl-btn-content">
                            <span class="ctrl-btn-icon">✨</span>
                            <span>GENERATE IMPROVED RESUME</span>
                        </div>
                    `;
                } else {
                    document.getElementById('improveBtn').disabled = true;
                    document.getElementById('improveBtn').style.opacity = '0.5';
                    document.getElementById('improveBtn').style.cursor = 'not-allowed';
                    const missingItems = [];
                    if (!hasStage2Completed) missingItems.push('Complete Stage 2 analysis first');
                    if (!resumeData) missingItems.push('Upload resume first');
                    document.getElementById('improveBtn').innerHTML = `
                        <div class="ctrl-btn-content">
                            <span class="ctrl-btn-icon">✨</span>
                            <span>GENERATE IMPROVED RESUME</span>
                        </div>
                        <div style="font-size: 11px; color: #ff6b6b; margin-top: 8px;">⚠️ ${missingItems.join(' & ')}</div>
                    `;
                }
            }
            
            if (currentVacancy.link) {
                document.getElementById('applyBtn').onclick = () => window.open(currentVacancy.link, '_blank');
            }
            
            switchTab('details');
            document.getElementById('modal').classList.add('active');
        }
        
        function closeModal(e) {
            if (!e || e.target === e.currentTarget) {
                document.getElementById('modal').classList.remove('active');
            }
        }
        
        function switchTab(tab) {
            document.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            document.querySelector(`.modal-tab[onclick="switchTab('${tab}')"]`).classList.add('active');
            document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
        }
        
        async function improveResume() {
            if (!currentVacancy || !resumeData) {
                console.error('improveResume: Missing data', {
                    currentVacancy: !!currentVacancy,
                    resumeData: !!resumeData
                });
                return;
            }

            // Ensure WebSocket is connected to receive the result
            const wsConnected = await ensureWSConnected();
            console.log('improveResume: WS connected:', wsConnected, 'state:', ws?.readyState, '(1=OPEN)');

            if (!wsConnected) {
                console.error('improveResume: WebSocket not connected');
                showToast('WebSocket connection failed. Please refresh the page.', 'error', 'Connection Error');
                return;
            }

            console.log('improveResume: Starting Stage 3 for vacancy:', {
                id: currentVacancy.id,
                channel: currentVacancy.channel,
                textLength: currentVacancy.text?.length,
                hasRecruiterAnalysis: !!currentVacancy.recruiter_analysis
            });

            const btn = document.getElementById('improveBtn');
            const stream = document.getElementById('streamImprove');
            const comp = document.getElementById('resumeComparison');

            comp.innerHTML = '';
            btn.style.display = 'none';
            stream.classList.add('active');
            stream.textContent = 'Stage 3: Generating improved resume...';

            try {
                // Передаём существующий recruiter_analysis если есть (для Stage 3)
                const payload = {
                    vacancy_text: currentVacancy.text,
                    vacancy_title: currentVacancy.channel,
                    vacancy_id: currentVacancy.id,
                    recruiter_analysis: currentVacancy.recruiter_analysis || null
                };
                console.log('improveResume: Sending payload:', payload);

                const res = await fetch('/api/improve-resume', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });

                const result = await res.json();
                console.log('improveResume: Response:', result);
            } catch (e) {
                console.error('improveResume: Error:', e);
                stream.textContent = 'Error: ' + e;
                btn.style.display = 'block';
                showToast('Failed to improve resume: ' + e.message, 'error', 'Resume Improvement Error');
            }
        }

        async function startStage2Analysis() {
            if (!currentVacancy || !resumeData) {
                console.error('startStage2Analysis: Missing data', {
                    currentVacancy: !!currentVacancy,
                    resumeData: !!resumeData
                });
                return;
            }

            const vacancyId = currentVacancy.id;

            // Already in progress
            if (stage2InProgress.has(vacancyId)) {
                console.log('Stage 2 already in progress for', vacancyId);
                return;
            }

            console.log('startStage2Analysis: Starting for vacancy:', vacancyId);

            try {
                const res = await fetch('/api/stage2/start', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        vacancy_id: vacancyId,
                        vacancy_text: currentVacancy.text,
                        vacancy_title: currentVacancy.channel || currentVacancy.title || ''
                    })
                });

                const result = await res.json();
                console.log('startStage2Analysis: Response:', result);

                if (result.status === 'started' || result.status === 'in_progress') {
                    stage2InProgress.add(vacancyId);
                    // Refresh only the Analysis tab content to show spinner (don't switch tabs)
                    refreshAnalysisTabContent();
                    // Update card indicator
                    updateCardStage2Indicator(vacancyId, 'in_progress');
                } else if (result.status === 'error') {
                    showToast(result.error, 'error', 'Analysis Error');
                }
            } catch (e) {
                console.error('startStage2Analysis: Error:', e);
                showToast('Failed to start analysis: ' + e.message, 'error', 'Analysis Error');
            }
        }

        function updateCardStage2Indicator(vacancyId, status) {
            const card = document.getElementById('card_' + vacancyId);
            if (!card) return;

            const statusEl = card.querySelector('.vacancy-card-status');
            if (!statusEl) return;

            if (status === 'in_progress') {
                statusEl.innerHTML = '<span class="stage2-indicator analyzing">ANALYZING</span>';
                statusEl.classList.add('analyzing');
            } else if (status === 'completed') {
                statusEl.innerHTML = 'ACTIVE';
                statusEl.classList.remove('analyzing');
            }
        }

        function handleStage2Started(data) {
            console.log('Stage 2 started for:', data.vacancy_id);
            stage2InProgress.add(data.vacancy_id);
            updateCardStage2Indicator(data.vacancy_id, 'in_progress');
        }

        function handleStage2Progress(data) {
            console.log('Stage 2 progress for:', data.vacancy_id, data.status);
            // Could update UI with more detailed progress if needed
        }

        function handleStage2Completed(data) {
            console.log('Stage 2 completed for:', data.vacancy_id, data.recruiter_analysis);
            stage2InProgress.delete(data.vacancy_id);
            updateCardStage2Indicator(data.vacancy_id, 'completed');

            // Update vacancy in local state
            const vacancy = vacancies.find(v => v.id === data.vacancy_id);
            if (vacancy) {
                vacancy.recruiter_analysis = data.recruiter_analysis;
                // Also update comparison match_score for card display
                if (!vacancy.comparison) vacancy.comparison = {};
                vacancy.comparison.match_score = data.recruiter_analysis.match_score;
            }

            // If this vacancy is currently open in modal, refresh only the Analysis tab content
            // WITHOUT switching tabs or reopening the modal
            if (currentVacancy && currentVacancy.id === data.vacancy_id) {
                currentVacancy.recruiter_analysis = data.recruiter_analysis;
                if (!currentVacancy.comparison) currentVacancy.comparison = {};
                currentVacancy.comparison.match_score = data.recruiter_analysis.match_score;
                // Only refresh Analysis tab content, don't switch tabs or reopen modal
                refreshAnalysisTabContent();
                refreshResumeTabContent();
            }

            // Update card to show new match score
            updateVacancyCardMatchScore(data.vacancy_id, data.recruiter_analysis.match_score);
        }

        function handleStage2Error(data) {
            console.error('Stage 2 error for:', data.vacancy_id, data.error);
            stage2InProgress.delete(data.vacancy_id);
            updateCardStage2Indicator(data.vacancy_id, 'completed');

            // If this vacancy is currently open in modal, refresh only the Analysis tab content
            // WITHOUT switching tabs or reopening the modal
            if (currentVacancy && currentVacancy.id === data.vacancy_id) {
                refreshAnalysisTabContent();
            }

            // Show error to user
            showToast('Stage 2 analysis failed: ' + data.error, 'error', 'Analysis Failed');
        }

        // Refresh only the Analysis tab content without switching tabs or opening modal
        function refreshAnalysisTabContent() {
            if (!currentVacancy) return;

            let analysisContent = '';

            // Stage 1: Filter analysis
            if (currentVacancy.analysis) {
                analysisContent += `
                    <div style="padding: 16px; background: linear-gradient(180deg, #1a2a2a, #0a1a1a); border: 2px solid #3a5050; border-radius: 8px; margin-bottom: 16px;">
                        <div style="font-size: var(--font-size-sm); color: #7dff7d; letter-spacing: 1px; margin-bottom: 12px;">🔍 STAGE 1: FILTER ANALYSIS</div>
                        <div style="font-size: var(--font-size-sm); color: #c0c8d0; line-height: 1.6;">${formatAnalysis(currentVacancy.analysis)}</div>
                    </div>
                `;
            }

            // Stage 2: Recruiter analysis
            const isStage2InProgress = stage2InProgress.has(currentVacancy.id);

            if (currentVacancy.recruiter_analysis && currentVacancy.recruiter_analysis.match_score > 0) {
                // Stage 2 completed - show results
                analysisContent += `
                    <div style="margin-bottom: 16px;">
                        <div style="font-size: var(--font-size-sm); color: #4a9eff; letter-spacing: 1px; margin-bottom: 12px; padding: 0 16px;">🎯 STAGE 2: RECRUITER ANALYSIS</div>
                        ${renderRecruiterAnalysis(currentVacancy.recruiter_analysis)}
                    </div>
                `;
            } else if (isStage2InProgress) {
                // Stage 2 in progress - show loading
                analysisContent += `
                    <div style="padding: 16px; background: linear-gradient(180deg, #1a2a3a, #0a1a2a); border: 2px solid #3a4a6a; border-radius: 8px; margin-bottom: 16px;">
                        <div style="font-size: var(--font-size-sm); color: #4a9eff; letter-spacing: 1px; margin-bottom: 12px;">🎯 STAGE 2: RECRUITER ANALYSIS</div>
                        <div style="display: flex; align-items: center; gap: 12px; color: #6a8aaa;">
                            <div class="stage2-spinner"></div>
                            <span>Analyzing your resume match...</span>
                        </div>
                    </div>
                `;
            } else {
                // Stage 2 not started - show button
                const hasResume = !!resumeData;
                analysisContent += `
                    <div style="padding: 16px; background: linear-gradient(180deg, #1a2a3a, #0a1a2a); border: 2px solid #3a4a6a; border-radius: 8px; margin-bottom: 16px;">
                        <div style="font-size: var(--font-size-sm); color: #4a9eff; letter-spacing: 1px; margin-bottom: 12px;">🎯 STAGE 2: RECRUITER ANALYSIS</div>
                        <button class="ctrl-btn stage2-btn" id="askRecruiterBtn" onclick="startStage2Analysis()" ${!hasResume ? 'disabled' : ''} style="width: 100%; ${!hasResume ? 'opacity: 0.5; cursor: not-allowed;' : ''}">
                            <div class="ctrl-btn-content">
                                <span class="ctrl-btn-icon">🎯</span>
                                <span>ASK RECRUITER</span>
                            </div>
                        </button>
                        ${!hasResume ? '<div style="color: #ff6b6b; font-size: 12px; margin-top: 8px; text-align: center;">⚠️ Upload resume first to enable analysis</div>' : ''}
                    </div>
                `;
            }

            document.getElementById('tabAnalysis').innerHTML = analysisContent || '<div style="color: #5a6070;">No analysis available</div>';
        }

        // Refresh Resume+ tab content (Stage 3 button state) without switching tabs
        function refreshResumeTabContent() {
            if (!currentVacancy) return;

            // Resume+ tab visibility: requires active resume
            document.getElementById('resumeTab').style.display = resumeData ? 'block' : 'none';

            const hasStage2Completed = currentVacancy.recruiter_analysis && currentVacancy.recruiter_analysis.match_score > 0;
            const canGenerateResume = hasStage2Completed && resumeData;

            if (currentVacancy.comparison && currentVacancy.comparison.improved_resume) {
                // Stage 3 completed - show improved resume
                document.getElementById('resumeComparison').innerHTML = renderComparisonResult(currentVacancy.comparison);
                document.getElementById('improveBtn').style.display = 'none';
            } else {
                // Stage 3 not done - show generate button
                document.getElementById('resumeComparison').innerHTML = '';
                document.getElementById('improveBtn').style.display = 'block';

                if (canGenerateResume) {
                    document.getElementById('improveBtn').disabled = false;
                    document.getElementById('improveBtn').style.opacity = '1';
                    document.getElementById('improveBtn').style.cursor = 'pointer';
                    document.getElementById('improveBtn').innerHTML = `
                        <div class="ctrl-btn-content">
                            <span class="ctrl-btn-icon">✨</span>
                            <span>GENERATE IMPROVED RESUME</span>
                        </div>
                    `;
                } else {
                    document.getElementById('improveBtn').disabled = true;
                    document.getElementById('improveBtn').style.opacity = '0.5';
                    document.getElementById('improveBtn').style.cursor = 'not-allowed';
                    document.getElementById('improveBtn').innerHTML = `
                        <div class="ctrl-btn-content">
                            <span class="ctrl-btn-icon">⏳</span>
                            <span>COMPLETE STAGE 2 FIRST</span>
                        </div>
                    `;
                }
            }
        }

        function updateVacancyCardMatchScore(vacancyId, matchScore) {
            const card = document.getElementById('card_' + vacancyId);
            if (!card) return;

            const matchMeter = card.querySelector('.match-meter');
            if (!matchMeter) return;

            const matchClass = matchScore >= 90 ? 'high' : matchScore >= 70 ? 'medium' : 'low';
            matchMeter.classList.remove('pending');
            matchMeter.innerHTML = `
                <div class="match-meter-header">
                    <div class="match-meter-label">
                        <span class="match-meter-icon">📈</span>
                        <span>MATCH RATE</span>
                    </div>
                    <span class="match-meter-value ${matchClass}">${matchScore}%</span>
                </div>
                <div class="match-meter-bar">
                    <div class="match-meter-fill ${matchClass}" style="width: ${matchScore}%;"></div>
                </div>
            `;
        }

        function handleStream(data) {
            // Обработка streaming для разных этапов пайплайна
            const el = document.getElementById('streamImprove');
            if (!el) return;

            if (data.stream_type === 'recruiter_analysis') {
                // ЭТАП 2: Анализ рекрутера
                if (data.chunk) {
                    if (data.chunk === '[START]') {
                        el.textContent = 'Stage 2: Recruiter analyzing your resume...\n';
                    } else if (data.chunk === '[END]') {
                        el.textContent += '\n\n✓ Analysis complete!';
                    } else {
                        el.textContent += data.chunk;
                    }
                    el.scrollTop = el.scrollHeight;
                }
            } else if (data.stream_type === 'improved_resume') {
                // ЭТАП 3: Генерация улучшенного резюме
                if (data.chunk) {
                    if (data.chunk === '[START]') {
                        el.textContent = 'Stage 3: Generating improved resume...\n';
                    } else if (data.chunk === '[END]') {
                        el.textContent += '\n\n✓ Complete!';
                    } else {
                        el.textContent += data.chunk;
                    }
                    el.scrollTop = el.scrollHeight;
                }
            } else if (data.stream_type === 'comparison') {
                // Legacy: быстрый анализ
                if (data.chunk && !['[START]', '[END]'].includes(data.chunk)) {
                    el.textContent += data.chunk;
                    el.scrollTop = el.scrollHeight;
                }
            }
        }

        // Helper function to render recruiter analysis (Stage 2)
        function renderRecruiterAnalysis(analysis) {
            if (!analysis || !analysis.match_score) return '';

            const score = analysis.match_score || 0;
            const scoreLevel = score >= 70 ? 'high' : score >= 40 ? 'medium' : 'low';
            const scoreStatus = score >= 80 ? 'EXCELLENT' : score >= 60 ? 'GOOD' : score >= 40 ? 'PARTIAL' : 'LOW';

            return `
                <div class="recruiter-analysis-container">
                    <!-- Match Score Bar -->
                    <div class="match-score-bar">
                        <div class="match-score-display">
                            <div class="match-score-num ${scoreLevel}">${score}%</div>
                            <div>
                                <div class="match-score-meter">
                                    <div class="match-score-fill ${scoreLevel}" style="width: ${score}%"></div>
                                </div>
                                <div class="match-score-label">RECRUITER SCORE</div>
                            </div>
                        </div>
                        <div class="match-score-status ${scoreLevel}">${scoreStatus}</div>
                    </div>

                    ${analysis.verdict ? `
                    <div class="recruiter-verdict">
                        <div class="verdict-label">RECRUITER VERDICT</div>
                        <div class="verdict-text">${escapeHtml(analysis.verdict)}</div>
                    </div>` : ''}

                    <!-- Analysis Details -->
                    <div class="analysis-summary">
                        <div class="analysis-body">
                            ${analysis.strong_sides && analysis.strong_sides.length > 0 ? `
                            <div class="analysis-section strengths">
                                <div class="analysis-section-header">STRENGTHS</div>
                                <ul class="analysis-list">
                                    ${analysis.strong_sides.map(s => `<li>${escapeHtml(s)}</li>`).join('')}
                                </ul>
                            </div>` : ''}

                            ${analysis.weak_sides && analysis.weak_sides.length > 0 ? `
                            <div class="analysis-section weaknesses">
                                <div class="analysis-section-header">WEAKNESSES</div>
                                <ul class="analysis-list">
                                    ${analysis.weak_sides.map(s => `<li>${escapeHtml(s)}</li>`).join('')}
                                </ul>
                            </div>` : ''}

                            ${analysis.missing_skills && analysis.missing_skills.length > 0 ? `
                            <div class="analysis-section missing">
                                <div class="analysis-section-header">MISSING SKILLS</div>
                                <ul class="analysis-list">
                                    ${analysis.missing_skills.map(s => `<li>${escapeHtml(s)}</li>`).join('')}
                                </ul>
                            </div>` : ''}

                            ${analysis.risks && analysis.risks.length > 0 ? `
                            <div class="analysis-section risks">
                                <div class="analysis-section-header">RISKS</div>
                                <ul class="analysis-list">
                                    ${analysis.risks.map(s => `<li>${escapeHtml(s)}</li>`).join('')}
                                </ul>
                            </div>` : ''}

                            ${analysis.recommendations && analysis.recommendations.length > 0 ? `
                            <div class="analysis-section tips">
                                <div class="analysis-section-header">RECOMMENDATIONS</div>
                                <ul class="analysis-list">
                                    ${analysis.recommendations.map(s => `<li>${escapeHtml(s)}</li>`).join('')}
                                </ul>
                            </div>` : ''}
                        </div>

                        ${analysis.cover_letter_hint ? `
                        <div class="cover-letter-section">
                            <div class="cover-letter-header">COVER LETTER HINT</div>
                            <div class="cover-letter-text">${escapeHtml(analysis.cover_letter_hint)}</div>
                        </div>` : ''}
                    </div>
                </div>
            `;
        }

        // Helper function to render comparison result (used by both handleResumeImproved and showDetails)
        function renderComparisonResult(comparison) {
            const score = comparison.match_score || 0;
            const scoreLevel = score >= 70 ? 'high' : score >= 40 ? 'medium' : 'low';
            const scoreStatus = score >= 80 ? 'EXCELLENT' : score >= 60 ? 'GOOD' : score >= 40 ? 'PARTIAL' : 'LOW';

            const improvedHtml = comparison.improved_resume
                ? simpleMarkdownToHtml(comparison.improved_resume)
                : '<div style="color: #888;">No improved resume text</div>';

            return `
                <div class="resume-result-container">
                    <!-- Match Score Bar -->
                    <div class="match-score-bar">
                        <div class="match-score-display">
                            <div class="match-score-num ${scoreLevel}">${score}%</div>
                            <div>
                                <div class="match-score-meter">
                                    <div class="match-score-fill ${scoreLevel}" style="width: ${score}%"></div>
                                </div>
                                <div class="match-score-label">MATCH SCORE</div>
                            </div>
                        </div>
                        <div class="match-score-status ${scoreLevel}">${scoreStatus} MATCH</div>
                    </div>

                    <!-- Resume Tabs -->
                    <div>
                        <div class="resume-tabs">
                            <button class="resume-tab-btn improved active" onclick="switchResumeTab('improved')">
                                IMPROVED
                            </button>
                            <button class="resume-tab-btn original" onclick="switchResumeTab('original')">
                                ORIGINAL
                            </button>
                        </div>
                        <div class="resume-content-panel">
                            <button class="copy-btn" onclick="copyResumeText()" id="copyResumeBtn">COPY</button>
                            <div class="resume-tab-content active" id="resumeTabImproved">
                                <div class="resume-text improved markdown-content">${improvedHtml}</div>
                            </div>
                            <div class="resume-tab-content" id="resumeTabOriginal">
                                <div class="resume-text">${escapeHtml(resumeData?.raw_text || '')}</div>
                            </div>
                        </div>
                    </div>

                    <!-- Analysis Summary -->
                    <div class="analysis-summary">
                        <div class="analysis-header">
                            <div class="analysis-header-title">DETAILED ANALYSIS</div>
                        </div>
                        <div class="analysis-body">
                            ${comparison.strong_sides && comparison.strong_sides.length > 0 ? `
                            <div class="analysis-section strengths">
                                <div class="analysis-section-header">STRENGTHS</div>
                                <ul class="analysis-list">
                                    ${comparison.strong_sides.map(s => `<li>${escapeHtml(s)}</li>`).join('')}
                                </ul>
                            </div>` : ''}

                            ${comparison.weak_sides && comparison.weak_sides.length > 0 ? `
                            <div class="analysis-section weaknesses">
                                <div class="analysis-section-header">AREAS TO IMPROVE</div>
                                <ul class="analysis-list">
                                    ${comparison.weak_sides.map(s => `<li>${escapeHtml(s)}</li>`).join('')}
                                </ul>
                            </div>` : ''}

                            ${comparison.missing_skills && comparison.missing_skills.length > 0 ? `
                            <div class="analysis-section missing">
                                <div class="analysis-section-header">MISSING SKILLS</div>
                                <ul class="analysis-list">
                                    ${comparison.missing_skills.map(s => `<li>${escapeHtml(s)}</li>`).join('')}
                                </ul>
                            </div>` : ''}

                            ${comparison.recommendations && comparison.recommendations.length > 0 ? `
                            <div class="analysis-section tips">
                                <div class="analysis-section-header">RECOMMENDATIONS</div>
                                <ul class="analysis-list">
                                    ${comparison.recommendations.map(s => `<li>${escapeHtml(s)}</li>`).join('')}
                                </ul>
                            </div>` : ''}
                        </div>

                        ${comparison.cover_letter_hint ? `
                        <div class="cover-letter-section">
                            <div class="cover-letter-header">COVER LETTER HINT</div>
                            <div class="cover-letter-text">${escapeHtml(comparison.cover_letter_hint)}</div>
                        </div>` : ''}
                    </div>
                </div>
            `;
        }

        function handleResumeImproved(data) {
            console.log('=== handleResumeImproved START ===');

            try {
                const stream = document.getElementById('streamImprove');
                const comp = document.getElementById('resumeComparison');

                console.log('Elements found:', { stream: !!stream, comp: !!comp });

                if (!comp) {
                    showToast('Resume comparison element not found', 'error', 'Display Error');
                    return;
                }

                // Показываем что данные получены
                if (stream) {
                    stream.textContent = '✓ Processing data...';
                    stream.classList.add('active');
                }

                console.log('handleResumeImproved data:', JSON.stringify(data, null, 2).substring(0, 500));
                console.log('vacancy_id:', data.vacancy_id);
                console.log('result keys:', data.result ? Object.keys(data.result) : 'NO RESULT');
                console.log('improved_resume length:', data.result?.improved_resume?.length);
                console.log('resumeData available:', !!resumeData);

                if (data.error) {
                    console.error('Error in resume improvement:', data.error);
                    document.getElementById('improveBtn').style.display = 'block';
                    comp.innerHTML = `<div style="color: red; padding: 20px;">Error: ${data.error}</div>`;
                    return;
                }

                // Проверяем, что данные есть
                if (!data.result) {
                    console.error('No result in data');
                    document.getElementById('improveBtn').style.display = 'block';
                    comp.innerHTML = `<div style="color: red; padding: 20px;">No result returned</div>`;
                    return;
                }

                // Проверяем что есть improved_resume
                if (!data.result.improved_resume) {
                    console.error('No improved_resume in result');
                    comp.innerHTML = `<div style="color: red; padding: 20px;">No improved resume text generated</div>`;
                    return;
                }

                // Обновляем вакансию с comparison, чтобы match_score отображался на карточке
                if (data.vacancy_id && data.result) {
                    console.log('Searching for vacancy with id:', data.vacancy_id);
                    console.log('Available vacancies:', vacancies.map(v => ({id: v.id, channel: v.channel})));

                    const vacancy = vacancies.find(v => v.id === data.vacancy_id);
                    console.log('Found vacancy:', vacancy ? 'YES' : 'NO');

                    if (vacancy) {
                        vacancy.comparison = {
                            match_score: data.result.match_score || 0,
                            strong_sides: data.result.strong_sides || [],
                            weak_sides: data.result.weak_sides || [],
                            missing_skills: data.result.missing_skills || [],
                            recommendations: data.result.recommendations || [],
                            cover_letter_hint: data.result.cover_letter_hint || '',
                            improved_resume: data.result.improved_resume || ''
                        };

                        // Также обновляем currentVacancy если это она
                        if (currentVacancy && currentVacancy.id === data.vacancy_id) {
                            currentVacancy.comparison = vacancy.comparison;
                        }

                        console.log('Updated vacancy with match_score:', vacancy.comparison.match_score);

                        // Обновляем карточку вакансии, чтобы показать match_score
                        const cardEl = document.getElementById('card_' + vacancy.id);
                        if (cardEl) {
                            const newCard = createVacancyCard(vacancy);
                            cardEl.replaceWith(newCard);
                        }
                    } else {
                        console.warn('Vacancy not found in array!');
                    }
                }

                // Скрываем stream output
                if (stream) {
                    stream.classList.remove('active');
                    stream.textContent = '';
                }

                // Отображаем результат используя общую функцию
                comp.innerHTML = renderComparisonResult(data.result);
                console.log('Resume comparison displayed successfully');

            } catch (outerError) {
                console.error('=== handleResumeImproved OUTER ERROR ===', outerError);
                showToast('Failed to display improved resume: ' + outerError.message, 'error', 'Display Error');
                const comp = document.getElementById('resumeComparison');
                if (comp) {
                    comp.innerHTML = `<div style="color: red; padding: 20px;">Fatal error: ${outerError.message}</div>`;
                }
            }

            console.log('=== handleResumeImproved END ===');
        }

        // Resume tab switching
        function switchResumeTab(tab) {
            // Update buttons
            document.querySelectorAll('.resume-tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.resume-tab-btn.${tab}`).classList.add('active');

            // Update content
            document.querySelectorAll('.resume-tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById('resumeTab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
        }

        // Copy resume text
        function copyResumeText() {
            const activeTab = document.querySelector('.resume-tab-content.active');
            if (!activeTab) return;

            const text = activeTab.innerText || activeTab.textContent;
            navigator.clipboard.writeText(text).then(() => {
                const btn = document.getElementById('copyResumeBtn');
                btn.textContent = '✓ COPIED';
                btn.classList.add('copied');
                setTimeout(() => {
                    btn.textContent = '📋 COPY';
                    btn.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                console.error('Copy failed:', err);
            });
        }

        // ============== UTILS ==============
        function escapeHtml(t) {
            if (!t) return '';
            const d = document.createElement('div');
            d.textContent = t;
            return d.innerHTML;
        }

        function simpleMarkdownToHtml(markdown) {
            if (!markdown) return '';

            let html = markdown;

            // Headers
            html = html.replace(/^### (.*$)/gim, '<h3>$1</h3>');
            html = html.replace(/^## (.*$)/gim, '<h2>$1</h2>');
            html = html.replace(/^# (.*$)/gim, '<h1>$1</h1>');

            // Bold
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

            // Italic
            html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');

            // Lists
            html = html.replace(/^\- (.*$)/gim, '<li>$1</li>');
            html = html.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');

            // Line breaks
            html = html.replace(/\n\n/g, '</p><p>');
            html = '<p>' + html + '</p>';

            // Horizontal rule
            html = html.replace(/^---$/gim, '<hr>');

            // Code blocks
            html = html.replace(/```(.*?)```/gs, '<pre><code>$1</code></pre>');

            return html;
        }
        
        function formatDate(d) {
            if (!d) return '';
            return new Date(d).toLocaleDateString('ru-RU', {day: 'numeric', month: 'short'});
        }

        function formatAnalysis(t) {
            return escapeHtml(t).replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
        }

        /**
         * Parse vacancy text via backend API and render formatted HTML.
         * Falls back to client-side parsing if API fails.
         */
        async function parseVacancyAsync(text, targetElementId) {
            if (!text) {
                document.getElementById(targetElementId).innerHTML = '<div class="vacancy-empty">No description</div>';
                return;
            }

            // Show loading state
            const target = document.getElementById(targetElementId);
            target.innerHTML = '<div class="vacancy-loading">Parsing...</div>';

            try {
                const response = await fetch('/api/parse-vacancy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text })
                });

                if (!response.ok) throw new Error('API error');

                const data = await response.json();
                if (data.status === 'ok' && data.parsed) {
                    target.innerHTML = renderParsedVacancy(data.parsed);
                } else {
                    throw new Error('Invalid response');
                }
            } catch (e) {
                console.warn('API parse failed, using client-side parser:', e);
                target.innerHTML = formatVacancyText(text);
            }
        }

        /**
         * Render parsed vacancy data from API to HTML
         */
        function renderParsedVacancy(parsed) {
            let html = '<div class="vacancy-formatted">';

            // Render semantics summary if available
            if (parsed.semantics) {
                const sem = parsed.semantics;
                const badges = [];

                if (sem.salary && sem.salary.text) {
                    badges.push(`<span class="vacancy-badge salary">${escapeHtml(sem.salary.text)}</span>`);
                }
                if (sem.remote === true) {
                    badges.push('<span class="vacancy-badge remote">Remote</span>');
                } else if (sem.remote === false) {
                    badges.push('<span class="vacancy-badge office">Office</span>');
                }
                if (sem.employment_type) {
                    badges.push(`<span class="vacancy-badge">${escapeHtml(sem.employment_type)}</span>`);
                }
                if (sem.experience) {
                    const [min, max] = sem.experience;
                    const expText = min === max ? `${min} years` : `${min}-${max} years`;
                    badges.push(`<span class="vacancy-badge">${expText}</span>`);
                }

                if (badges.length > 0) {
                    html += `<div class="vacancy-badges">${badges.join('')}</div>`;
                }

                // Tech stack badges
                if (sem.technologies && sem.technologies.length > 0) {
                    html += '<div class="vacancy-tech-stack">';
                    for (const tech of sem.technologies.slice(0, 15)) {
                        html += `<span class="vacancy-tech">${escapeHtml(tech)}</span>`;
                    }
                    html += '</div>';
                }
            }

            // Render sections
            for (const section of parsed.sections || []) {
                if (section.is_intro) {
                    html += `<div class="vacancy-intro">`;
                    html += renderSectionItems(section.items);
                    html += `</div>`;
                } else {
                    html += `<div class="vacancy-section" data-confidence="${section.confidence}">`;
                    html += `<div class="vacancy-section-header">${section.icon} ${escapeHtml(section.title)}</div>`;
                    html += `<div class="vacancy-section-content">`;
                    html += renderSectionItems(section.items);
                    html += `</div></div>`;
                }
            }

            // Contacts section at the bottom
            if (parsed.semantics && parsed.semantics.contacts && parsed.semantics.contacts.length > 0) {
                html += '<div class="vacancy-contacts-section">';
                html += '<div class="vacancy-contacts-header">📇 Contacts</div>';
                html += '<div class="vacancy-contacts-list">';
                for (const contact of parsed.semantics.contacts) {
                    const icon = contact.icon || '📎';
                    const label = contact.label ? `<span class="contact-label">${escapeHtml(contact.label)}</span>` : '';
                    const typeClass = `contact-${contact.type}`;

                    if (contact.url) {
                        html += `<a href="${escapeHtml(contact.url)}" target="_blank" class="vacancy-contact ${typeClass}">
                            <span class="contact-icon">${icon}</span>
                            <span class="contact-value">${escapeHtml(contact.display || contact.value)}</span>
                            ${label}
                        </a>`;
                    } else {
                        html += `<span class="vacancy-contact ${typeClass}">
                            <span class="contact-icon">${icon}</span>
                            <span class="contact-value">${escapeHtml(contact.display || contact.value)}</span>
                            ${label}
                        </span>`;
                    }
                }
                html += '</div></div>';
            }

            html += '</div>';
            return html;
        }

        /**
         * Render section items (list or paragraphs)
         */
        function renderSectionItems(items) {
            if (!items || items.length === 0) return '';

            // Check if items look like a list (most have short single-line content)
            const listLike = items.filter(i => !i.text.includes('\n') && i.text.length < 200).length > items.length / 2;

            if (listLike && items.length > 1) {
                let html = '<ul class="vacancy-list">';
                for (const item of items) {
                    html += `<li>${formatInlineText(item.text)}</li>`;
                }
                html += '</ul>';
                return html;
            } else {
                let html = '';
                for (const item of items) {
                    // Handle multi-line items
                    const lines = item.text.split('\n');
                    for (const line of lines) {
                        if (line.trim()) {
                            html += `<p class="vacancy-paragraph">${formatInlineText(line)}</p>`;
                        }
                    }
                }
                return html;
            }
        }

        /**
         * Synchronous client-side vacancy parser (fallback)
         * Used when API is unavailable
         */
        function formatVacancyText(text) {
            if (!text) return '<div class="vacancy-empty">No description</div>';

            // Section header patterns (Russian + English)
            const sectionPatterns = [
                { regex: /^(требования|requirements?|что нужно|что мы ждём|что мы ждем|необходимые навыки|обязательные требования|must have|hard skills?|ключевые навыки|навыки|skills?)[\s:]*$/im, title: 'Requirements', icon: '📋' },
                { regex: /^(обязанности|задачи|responsibilities|job responsibilities|что предстоит|чем предстоит заниматься|чем будете заниматься|что нужно будет делать|основные задачи|duties)[\s:]*$/im, title: 'Responsibilities', icon: '💼' },
                { regex: /^(о компании|о нас|about( the)? company|about us|кто мы|company|компания)[\s:]*$/im, title: 'About Company', icon: '🏢' },
                { regex: /^(о (вакансии|позиции|работе)|about( the)? (job|position|role)|описание (вакансии|позиции))[\s:]*$/im, title: 'About Position', icon: '📝' },
                { regex: /^(условия|мы предлагаем|что предлагаем|benefits?|compensation( and benefits)?|perks|мы гарантируем|наше предложение|бонусы|плюшки|what we offer)[\s:]*$/im, title: 'Benefits', icon: '🎁' },
                { regex: /^(будет плюсом|nice to have|preferred|желательно|дополнительно|преимуществом будет|preferred qualifications?|бонусом будет)[\s:]*$/im, title: 'Nice to Have', icon: '⭐' },
                { regex: /^(стек|технологии|tech stack|technologies|инструменты|tools)[\s:]*$/im, title: 'Tech Stack', icon: '🛠️' },
                { regex: /^(контакты?|откликнуться|contact|apply|how to apply|как откликнуться|отклик)[\s:]*$/im, title: 'Contact', icon: '📧' },
                { regex: /^(зарплата|оплата|salary|compensation|вознаграждение|оклад)[\s:]*$/im, title: 'Salary', icon: '💰' },
                { regex: /^(опыт работы|experience|требуемый опыт)[\s:]*$/im, title: 'Experience', icon: '📈' },
                { regex: /^(локация|формат|location|work format|график|режим работы|место работы)[\s:]*$/im, title: 'Work Format', icon: '📍' },
                { regex: /^(команда|team|о команде|about team)[\s:]*$/im, title: 'Team', icon: '👥' },
            ];

            // Normalize and split
            let processed = text.replace(/\r\n/g, '\n').trim();
            const lines = processed.split('\n');
            let sections = [];
            let currentSection = { title: null, icon: '📄', content: [] };

            for (const line of lines) {
                const trimmedLine = line.trim();

                if (!trimmedLine) {
                    if (currentSection.content.length > 0) {
                        currentSection.content.push('');
                    }
                    continue;
                }

                let foundSection = false;
                for (const pattern of sectionPatterns) {
                    if (pattern.regex.test(trimmedLine)) {
                        if (currentSection.content.length > 0 || currentSection.title) {
                            sections.push(currentSection);
                        }
                        currentSection = { title: pattern.title, icon: pattern.icon, content: [] };
                        foundSection = true;
                        break;
                    }
                }

                if (!foundSection) {
                    currentSection.content.push(trimmedLine);
                }
            }

            if (currentSection.content.length > 0 || currentSection.title) {
                sections.push(currentSection);
            }

            // Build HTML
            let html = '<div class="vacancy-formatted">';
            for (const section of sections) {
                if (section.title) {
                    html += `<div class="vacancy-section">`;
                    html += `<div class="vacancy-section-header">${section.icon} ${escapeHtml(section.title)}</div>`;
                    html += `<div class="vacancy-section-content">${formatSectionContent(section.content)}</div>`;
                    html += `</div>`;
                } else {
                    html += `<div class="vacancy-intro">${formatSectionContent(section.content)}</div>`;
                }
            }
            html += '</div>';
            return html;
        }

        /**
         * Format section content with proper list handling
         */
        function formatSectionContent(lines) {
            if (!lines || lines.length === 0) return '';

            let html = '';
            let listItems = [];
            const bulletPattern = /^[\-•◆●○▪▸►★✓✔☑︎\*·]\s+(.*)$/;
            const numberedPattern = /^\d+[\.\)]\s+(.*)$/;

            const flushList = () => {
                if (listItems.length > 0) {
                    html += '<ul class="vacancy-list">';
                    for (const item of listItems) {
                        html += `<li>${formatInlineText(item)}</li>`;
                    }
                    html += '</ul>';
                    listItems = [];
                }
            };

            for (const line of lines) {
                const trimmed = line.trim();
                if (!trimmed) {
                    flushList();
                    continue;
                }

                let match = trimmed.match(bulletPattern) || trimmed.match(numberedPattern);
                if (match) {
                    listItems.push(match[1]);
                } else {
                    flushList();
                    html += `<p class="vacancy-paragraph">${formatInlineText(trimmed)}</p>`;
                }
            }
            flushList();
            return html;
        }

        /**
         * Format inline text with bold, links, hashtags, etc.
         */
        function formatInlineText(text) {
            if (!text) return '';

            let result = escapeHtml(text);

            // Bold: **text** or __text__
            result = result.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
            result = result.replace(/__([^_]+)__/g, '<strong>$1</strong>');

            // Italic: *text* or _text_
            result = result.replace(/(?<!\*)\*([^*]+)\*(?!\*)/g, '<em>$1</em>');

            // Hashtags: #Tag
            result = result.replace(/#(\w+)/g, '<span class="vacancy-tag">#$1</span>');

            // Email
            result = result.replace(/([a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\.[a-zA-Z]{2,})/g, '<a href="mailto:$1" class="vacancy-link">$1</a>');

            // URLs
            result = result.replace(/(https?:\/\/[^\s<]+)/g, '<a href="$1" target="_blank" class="vacancy-link">$1</a>');

            // Telegram: @username
            result = result.replace(/@([a-zA-Z][a-zA-Z0-9_]{4,})/g, '<a href="https://t.me/$1" target="_blank" class="vacancy-link">@$1</a>');

            // Salary
            result = result.replace(/(\$\d[\d\s,]*|\d[\d\s,]*\$|\d[\d\s,]*\s*(USD|EUR|RUB|руб|₽|€))/gi, '<span class="vacancy-salary">$1</span>');

            return result;
        }
    </script>

    <!-- Подключаем модуль авторизации Telegram -->
    <link rel="stylesheet" href="/static/auth.css">
    <script src="/static/auth.js"></script>
</body>
</html>
